<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Real Madrid Fan Bot</title>

    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://images.fotmob.com">

    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HLS.js –¥–ª—è IPTV —Å—Ç—Ä–∏–º–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rm-gold': '#FEBE10',
                        'rm-blue': '#00529F',
                        'rm-dark': '#0A0A0C',
                        'rm-card': '#141418',
                        'rm-light': '#1E1E24',
                        'rm-gray': '#2A2A32'
                    }
                }
            }
        }
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #0A0A0C;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background image */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                linear-gradient(180deg, rgba(10,10,12,0.92) 0%, rgba(10,10,12,0.85) 50%, rgba(10,10,12,0.92) 100%),
                url('bg.jpg') center/cover no-repeat;
            z-index: -1;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #FEBE10; border-radius: 3px; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(100%); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(254,190,16,0.3); }
            50% { box-shadow: 0 0 20px rgba(254,190,16,0.6); }
        }

        @keyframes loading {
            0% { width: 10%; }
            50% { width: 70%; }
            100% { width: 10%; }
        }

        .animate-fade { animation: fadeIn 0.4s ease-out; }
        .animate-slide { animation: slideUp 0.3s ease-out; }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        .animate-loading { animation: loading 1.5s ease-in-out infinite; }

        /* Quiz anti-copy protection */
        .quiz-protected {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
        }

        .skeleton {
            background: linear-gradient(90deg, #1E1E24 25%, #2A2A32 50%, #1E1E24 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        /* Glass effect */
        .glass {
            background: rgba(20, 20, 24, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Smooth page transitions */
        .page-transition { transition: opacity 0.2s ease, transform 0.2s ease; }

        /* Better image loading */
        img { transition: opacity 0.3s; }
        img[loading="lazy"] { opacity: 1; }

        /* Tabular numbers for scores */
        .tabular-nums { font-variant-numeric: tabular-nums; }

        /* Hide scrollbar */
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* Gold button */
        .btn-gold {
            background: linear-gradient(135deg, #FEBE10 0%, #E5AB0E 50%, #FEBE10 100%);
            color: #000;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .btn-gold:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(254,190,16,0.4); }
        .btn-gold:active { transform: scale(0.98); }

        /* Tabs */
        .tab-active {
            color: #FEBE10;
            position: relative;
        }
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: #FEBE10;
            border-radius: 3px;
        }

        /* Navigation */
        .nav-item {
            transition: all 0.2s;
        }
        .nav-item.active {
            color: #FEBE10;
        }
        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }
        .nav-indicator {
            position: absolute;
            top: -2px;
            width: 4px;
            height: 4px;
            background: #FEBE10;
            border-radius: 50%;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Cards */
        .match-card {
            position: relative;
            overflow: hidden;
        }
        .match-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #FEBE10, transparent);
            opacity: 0.5;
        }

        /* Odds buttons */
        .odds-btn {
            background: rgba(30, 30, 36, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .odds-btn:hover {
            background: #FEBE10;
            color: #000;
            border-color: #FEBE10;
            transform: translateY(-2px);
        }
        .odds-btn:active {
            transform: scale(0.95);
        }

        /* Status badges */
        .badge-pending { background: rgba(234,179,8,0.15); color: #EAB308; }
        .badge-won { background: rgba(34,197,94,0.15); color: #22C55E; }
        .badge-lost { background: rgba(239,68,68,0.15); color: #EF4444; }
        .badge-sold { background: rgba(59,130,246,0.15); color: #3B82F6; }

        /* Hide scrollbar for nav */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // ==================== API ====================
        const API_URL = '';
        const tg = window.Telegram?.WebApp;
        const ADMIN_IDS = [1697882482];  // –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤

        const api = {
            async fetch(endpoint, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    ...(tg?.initData && { 'Authorization': tg.initData })
                };
                try {
                    const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.detail || `HTTP ${res.status}`);
                    }
                    return await res.json();
                } catch (err) {
                    console.error('API Error:', err);
                    throw err;
                }
            },
            get: (endpoint) => api.fetch(endpoint),
            post: (endpoint, data) => api.fetch(endpoint, { method: 'POST', body: JSON.stringify(data) })
        };

        // ==================== REAL MADRID LOGO ====================
        const RealMadridLogo = ({ size = 40 }) => (
            <img
                src="https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg"
                alt="Real Madrid"
                width={size}
                height={size}
                className="object-contain"
                onError={(e) => {
                    e.target.onerror = null;
                    e.target.src = 'data:image/svg+xml,' + encodeURIComponent(`
                        <svg viewBox="0 0 100 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="60" r="45" fill="#FEBE10" stroke="#00529F" stroke-width="3"/>
                            <path d="M50 20L55 35H70L58 45L63 60L50 50L37 60L42 45L30 35H45Z" fill="#00529F"/>
                            <text x="50" y="75" text-anchor="middle" fill="#00529F" font-size="28" font-weight="bold" font-family="serif">RM</text>
                        </svg>
                    `);
                }}
            />
        );

        // ==================== ICONS ====================
        const Icons = {
            Home: ({ active }) => (
                <svg className={`w-6 h-6 transition-transform ${active ? 'nav-icon' : ''}`} fill={active ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={active ? 0 : 1.5}
                        d={active ? "M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" : "M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"} />
                </svg>
            ),
            Calendar: ({ active }) => (
                <svg className={`w-6 h-6 transition-transform ${active ? 'nav-icon' : ''}`} fill={active ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={active ? 0 : 1.5}
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            ),
            Zap: ({ active }) => (
                <svg className={`w-6 h-6 transition-transform ${active ? 'nav-icon' : ''}`} fill={active ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={active ? 0 : 1.5} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            ),
            Trophy: ({ active }) => (
                <svg className={`w-6 h-6 transition-transform ${active ? 'nav-icon' : ''}`} fill={active ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={active ? 0 : 1.5}
                        d="M12 15l-2 5h4l-2-5zm0 0V9m-4-4h8l1 4c0 2.5-2 5-5 5s-5-2.5-5-5l1-4z" />
                </svg>
            ),
            Gift: ({ active }) => (
                <svg className={`w-6 h-6 transition-transform ${active ? 'nav-icon' : ''}`} fill={active ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={active ? 0 : 1.5}
                        d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                </svg>
            ),
            User: ({ active }) => (
                <svg className={`w-6 h-6 transition-transform ${active ? 'nav-icon' : ''}`} fill={active ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={active ? 0 : 1.5}
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            ),
            Clock: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" strokeWidth={1.5}/>
                    <path strokeLinecap="round" strokeWidth={1.5} d="M12 6v6l4 2" />
                </svg>
            ),
            ChevronRight: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                </svg>
            ),
            Target: ({ active }) => (
                <svg className={`w-6 h-6 transition-transform ${active ? 'nav-icon' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" strokeWidth={1.5}/>
                    <circle cx="12" cy="12" r="6" strokeWidth={1.5}/>
                    <circle cx="12" cy="12" r="2" fill={active ? 'currentColor' : 'none'} strokeWidth={1.5}/>
                </svg>
            ),
            News: ({ active }) => (
                <svg className={`w-6 h-6 transition-transform ${active ? 'nav-icon' : ''}`} fill={active ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                </svg>
            ),
            Gamepad: ({ active }) => (
                <svg className={`w-6 h-6 transition-transform ${active ? 'nav-icon' : ''}`} fill={active ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
                    <circle cx="9" cy="12" r="1" fill="currentColor"/>
                </svg>
            ),
        };

        // ==================== SKELETON ====================
        const Skeleton = ({ className = "", rounded = "rounded-xl" }) => (
            <div className={`skeleton ${rounded} ${className}`}></div>
        );

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–ª–æ—Å—ã –∑–∞–≥—Ä—É–∑–∫–∏
        const LoadingBar = ({ text = "–ó–∞–≥—Ä—É–∑–∫–∞..." }) => (
            <div className="glass rounded-xl p-4 mb-4">
                <div className="flex items-center gap-3 mb-3">
                    <div className="animate-spin text-xl">‚è≥</div>
                    <span className="text-gray-400">{text}</span>
                </div>
                <div className="w-full bg-rm-light rounded-full h-2 overflow-hidden">
                    <div className="bg-rm-gold h-2 rounded-full animate-loading"></div>
                </div>
            </div>
        );

        // ==================== PURCHASE MODAL ====================
        const PurchaseModal = ({ isOpen, onClose }) => {
            const [step, setStep] = useState(1);
            const [amount, setAmount] = useState(0);
            const [customAmount, setCustomAmount] = useState('');
            const [receipt, setReceipt] = useState(null);
            const [receiptPreview, setReceiptPreview] = useState(null);
            const [submitting, setSubmitting] = useState(false);
            const [purchaseId, setPurchaseId] = useState(null);
            const [copied, setCopied] = useState(false);
            const [config, setConfig] = useState({
                card_number: '...', card_bank: '', price_per_point: 2.5,
                min_purchase: 100, amounts: [100, 250, 500, 1000]
            });

            useEffect(() => {
                if (isOpen) {
                    setStep(1); setAmount(0); setCustomAmount('');
                    setReceipt(null); setReceiptPreview(null);
                    setSubmitting(false); setPurchaseId(null); setCopied(false);
                    fetch('/api/purchase/config').then(r => r.json()).then(setConfig).catch(() => {});
                }
            }, [isOpen]);

            if (!isOpen) return null;

            const selectedAmount = customAmount ? (parseInt(customAmount) || 0) : amount;
            const totalRub = Math.round(selectedAmount * config.price_per_point);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setReceipt(file);
                    const reader = new FileReader();
                    reader.onload = (ev) => setReceiptPreview(ev.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const copyCard = () => {
                const num = config.card_number.replace(/\s/g, '');
                navigator.clipboard?.writeText(num).then(() => {
                    setCopied(true); setTimeout(() => setCopied(false), 2000);
                }).catch(() => {});
            };

            const submitPurchase = async () => {
                if (!receipt || selectedAmount < config.min_purchase) return;
                setSubmitting(true);
                try {
                    const fd = new FormData();
                    fd.append('amount', String(selectedAmount));
                    fd.append('receipt', receipt);
                    const initData = window.Telegram?.WebApp?.initData || '';
                    const res = await fetch('/api/purchase', {
                        method: 'POST',
                        headers: { 'Authorization': initData },
                        body: fd
                    });
                    const data = await res.json();
                    if (data.success) {
                        setPurchaseId(data.id);
                        setStep(3);
                    } else {
                        tg?.showAlert?.(data.detail || '–û—à–∏–±–∫–∞');
                    }
                } catch (err) {
                    tg?.showAlert?.('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
                setSubmitting(false);
            };

            return (
                <div className="fixed inset-0 bg-black/85 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-rm-card w-full max-w-sm rounded-2xl animate-fade max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>

                        {step === 1 && (
                            <div className="p-6">
                                <div className="text-center mb-6">
                                    <div className="text-5xl mb-3">&#128176;</div>
                                    <h3 className="text-xl font-bold mb-2">–ö—É–ø–∏—Ç—å –æ—á–∫–∏</h3>
                                    <p className="text-gray-400 text-sm">–í—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏</p>
                                </div>

                                <div className="grid grid-cols-2 gap-3 mb-4">
                                    {config.amounts.map(a => (
                                        <button
                                            key={a}
                                            onClick={() => { setAmount(a); setCustomAmount(''); }}
                                            className={`p-3 rounded-xl border-2 transition-all ${
                                                amount === a && !customAmount
                                                    ? 'border-rm-gold bg-rm-gold/10'
                                                    : 'border-white/10 bg-rm-light/50'
                                            }`}
                                        >
                                            <div className="text-white font-bold text-lg">{a}</div>
                                            <div className="text-gray-400 text-xs">{Math.round(a * config.price_per_point)}&#8381;</div>
                                        </button>
                                    ))}
                                </div>

                                <div className="relative mb-6">
                                    <input
                                        type="number"
                                        placeholder={`–î—Ä—É–≥–∞—è —Å—É–º–º–∞ (–º–∏–Ω. ${config.min_purchase})`}
                                        min={config.min_purchase}
                                        step="50"
                                        value={customAmount}
                                        onChange={e => { setCustomAmount(e.target.value); setAmount(0); }}
                                        className="w-full bg-rm-light/50 text-white rounded-xl px-4 py-3 border border-white/10 focus:border-rm-gold outline-none"
                                    />
                                    {customAmount && parseInt(customAmount) > 0 && (
                                        <div className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm">
                                            {Math.round(parseInt(customAmount) * config.price_per_point)}&#8381;
                                        </div>
                                    )}
                                </div>

                                {selectedAmount >= config.min_purchase && (
                                    <div className="bg-rm-light/50 rounded-xl p-4 mb-6 text-center">
                                        <div className="text-rm-gold text-2xl font-bold">{selectedAmount} –æ—á–∫–æ–≤</div>
                                        <div className="text-gray-400">= {totalRub}&#8381;</div>
                                    </div>
                                )}

                                <div className="space-y-3">
                                    <button
                                        onClick={() => setStep(2)}
                                        disabled={selectedAmount < config.min_purchase}
                                        className="w-full bg-rm-gold text-black font-bold py-4 rounded-xl hover:bg-yellow-400 transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
                                    >
                                        –î–∞–ª–µ–µ &#8594;
                                    </button>
                                    <button onClick={onClose} className="w-full bg-rm-light text-gray-400 py-3 rounded-xl">
                                        –û—Ç–º–µ–Ω–∞
                                    </button>
                                </div>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="p-6">
                                <div className="text-center mb-4">
                                    <h3 className="text-xl font-bold">&#128179; –û–ø–ª–∞—Ç–∞</h3>
                                </div>

                                <div className="bg-rm-gold/10 border border-rm-gold/30 rounded-xl p-4 mb-4 text-center">
                                    <div className="text-rm-gold text-2xl font-bold">{totalRub}&#8381;</div>
                                    <div className="text-gray-400 text-sm">–∑–∞ {selectedAmount} –æ—á–∫–æ–≤</div>
                                </div>

                                <div className="bg-rm-light rounded-xl p-4 mb-4">
                                    <div className="text-gray-400 text-xs mb-2">
                                        –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É{config.card_bank ? ` (${config.card_bank})` : ''}
                                    </div>
                                    <div className="flex items-center justify-between gap-2">
                                        <span className="text-white font-mono text-lg tracking-wider">{config.card_number}</span>
                                        <button
                                            onClick={copyCard}
                                            className="text-sm px-3 py-1.5 bg-white/10 rounded-lg hover:bg-white/20 transition-colors whitespace-nowrap"
                                        >
                                            {copied ? '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'}
                                        </button>
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <label className="block cursor-pointer">
                                        <div className={`border-2 border-dashed rounded-xl p-4 text-center transition-all ${
                                            receipt ? 'border-rm-gold/50 bg-rm-gold/5' : 'border-white/10 hover:border-white/20'
                                        }`}>
                                            {receiptPreview ? (
                                                <img src={receiptPreview} className="max-h-40 mx-auto rounded-lg mb-2" />
                                            ) : (
                                                <div className="text-4xl mb-2">&#128248;</div>
                                            )}
                                            <div className="text-gray-400 text-sm">
                                                {receipt ? receipt.name : '–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫ / —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã'}
                                            </div>
                                        </div>
                                        <input
                                            type="file"
                                            accept="image/*"
                                            onChange={handleFileChange}
                                            className="hidden"
                                        />
                                    </label>
                                </div>

                                <div className="space-y-3">
                                    <button
                                        onClick={submitPurchase}
                                        disabled={!receipt || submitting}
                                        className="w-full bg-rm-gold text-black font-bold py-4 rounded-xl hover:bg-yellow-400 transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
                                    >
                                        {submitting ? '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É'}
                                    </button>
                                    <button onClick={() => setStep(1)} className="w-full bg-rm-light text-gray-400 py-3 rounded-xl">
                                        &#8592; –ù–∞–∑–∞–¥
                                    </button>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="p-6 text-center">
                                <div className="text-5xl mb-4">&#9989;</div>
                                <h3 className="text-xl font-bold mb-2">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h3>
                                <p className="text-gray-400 mb-2">–ó–∞—è–≤–∫–∞ #{purchaseId}</p>
                                <p className="text-gray-400 text-sm mb-6">
                                    –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.<br/>
                                    –û—á–∫–∏ –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã.
                                </p>
                                <button
                                    onClick={onClose}
                                    className="w-full bg-rm-gold text-black font-bold py-4 rounded-xl hover:bg-yellow-400 transition-colors"
                                >
                                    –û—Ç–ª–∏—á–Ω–æ!
                                </button>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        // ==================== HEADER ====================
        const Header = ({ balance, loading, onBuyClick, photoUrl }) => (
            <header className="sticky top-0 z-50 glass border-b border-white/5">
                <div className="flex items-center justify-between px-4 py-3">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center overflow-hidden">
                            {photoUrl ? (
                                <img src={photoUrl} className="w-full h-full object-cover" onError={(e) => { e.target.style.display='none'; e.target.nextSibling.style.display='block'; }} />
                            ) : null}
                            <div style={{display: photoUrl ? 'none' : 'block'}}><RealMadridLogo size={32} /></div>
                        </div>
                        <div>
                            <span className="font-bold text-base">Real Madrid</span>
                            <span className="text-gray-400 text-xs block">Fan Bot</span>
                        </div>
                    </div>
                    <div className="flex items-center gap-2">
                        {loading ? (
                            <Skeleton className="w-24 h-9" rounded="rounded-full" />
                        ) : (
                            <div className="flex items-center gap-2 bg-rm-light/80 px-4 py-2 rounded-full border border-rm-gold/20">
                                <span className="text-rm-gold font-bold text-lg">{balance?.toLocaleString() || 0}</span>
                                <span className="text-gray-400 text-xs">–æ—á–∫–æ–≤</span>
                            </div>
                        )}
                        <button
                            onClick={onBuyClick}
                            className="w-9 h-9 bg-rm-gold text-black rounded-full flex items-center justify-center font-bold text-xl hover:bg-yellow-400 transition-colors"
                        >
                            +
                        </button>
                    </div>
                </div>
            </header>
        );

        // ==================== NAVIGATION ====================
        const Navigation = ({ active, onChange }) => {
            const items = [
                { id: 'home', icon: Icons.Home, label: '–ì–ª–∞–≤–Ω–∞—è' },
                { id: 'matches', icon: Icons.Calendar, label: '–ú–∞—Ç—á–∏' },
                { id: 'bets', icon: Icons.Zap, label: '–°—Ç–∞–≤–∫–∏' },
                { id: 'games', icon: Icons.Gamepad, label: '–ò–≥—Ä—ã' },
                { id: 'news', icon: Icons.News, label: '–ù–æ–≤–æ—Å—Ç–∏' },
                { id: 'profile', icon: Icons.User, label: '–ü—Ä–æ—Ñ–∏–ª—å' },
            ];

            return (
                <nav className="fixed bottom-0 left-0 right-0 glass border-t border-white/5 z-50 safe-area-bottom">
                    <div className="flex justify-around items-center py-1 px-2">
                        {items.map(item => {
                            const isActive = active === item.id;
                            return (
                                <button
                                    key={item.id}
                                    onClick={() => onChange(item.id)}
                                    className={`nav-item flex flex-col items-center py-2 px-3 rounded-xl relative ${isActive ? 'active' : 'text-gray-500'}`}
                                >
                                    {isActive && <div className="nav-indicator"></div>}
                                    <item.icon active={isActive} />
                                    <span className={`text-[10px] mt-1 font-medium ${isActive ? 'text-rm-gold' : ''}`}>{item.label}</span>
                                </button>
                            );
                        })}
                    </div>
                </nav>
            );
        };

        // ==================== USER AVATAR ====================
        const UserAvatar = ({ photoUrl, name, size = 'md' }) => {
            const sizes = { sm: 'w-8 h-8 text-sm', md: 'w-14 h-14 text-2xl', lg: 'w-24 h-24 text-4xl' };
            const cls = sizes[size] || sizes.md;

            if (photoUrl) {
                return <img src={photoUrl} className={`${cls} rounded-full object-cover`} loading="lazy" onError={(e) => { e.target.style.display='none'; e.target.nextSibling && (e.target.nextSibling.style.display='flex'); }} />;
            }
            return (
                <div className={`${cls} bg-gradient-to-br from-rm-gold via-yellow-500 to-rm-gold rounded-full flex items-center justify-center font-bold text-black shadow-lg shadow-rm-gold/20`}>
                    {name?.[0] || '?'}
                </div>
            );
        };

        // ==================== MATCH CARD ====================
        const MatchCard = ({ match, showOdds = false, onBet, compact = false }) => {
            if (!match) return null;

            const isRealMadridHome = match.home_team?.includes('Real Madrid');
            const isRealMadridAway = match.away_team?.includes('Real Madrid');

            return (
                <div className={`match-card glass rounded-2xl ${compact ? 'p-4' : 'p-5'} animate-fade`}>
                    {/* Header */}
                    <div className="flex justify-between items-center mb-4">
                        <span className="text-rm-gold text-xs font-semibold px-3 py-1 bg-rm-gold/10 rounded-full border border-rm-gold/20">
                            {match.competition || 'La Liga'}
                        </span>
                        <span className="text-gray-400 text-xs flex items-center gap-1.5">
                            <Icons.Clock />
                            {match.date}
                        </span>
                    </div>

                    {/* Teams with logos */}
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex-1 flex flex-col items-center gap-1.5">
                            {match.home_logo && <img src={match.home_logo} className="w-10 h-10 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                            <div className={`font-bold text-center ${compact ? 'text-xs' : 'text-sm'} ${isRealMadridHome ? 'text-rm-gold' : 'text-white'}`}>
                                {match.home_team}
                            </div>
                            {isRealMadridHome && <span className="text-[10px] text-gray-500">–î–æ–º–∞</span>}
                        </div>

                        <div className="px-3">
                            {match.score ? (
                                <div className="text-2xl font-black bg-rm-light/50 px-4 py-2 rounded-xl tabular-nums">{match.score}</div>
                            ) : (
                                <div className="w-11 h-11 rounded-full bg-gradient-to-br from-rm-light to-rm-gray flex items-center justify-center border border-white/10">
                                    <span className="text-gray-400 text-xs font-bold">VS</span>
                                </div>
                            )}
                        </div>

                        <div className="flex-1 flex flex-col items-center gap-1.5">
                            {match.away_logo && <img src={match.away_logo} className="w-10 h-10 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                            <div className={`font-bold text-center ${compact ? 'text-xs' : 'text-sm'} ${isRealMadridAway ? 'text-rm-gold' : 'text-white'}`}>
                                {match.away_team}
                            </div>
                            {isRealMadridAway && <span className="text-[10px] text-gray-500">–í –≥–æ—Å—Ç—è—Ö</span>}
                        </div>
                    </div>

                    {/* Odds */}
                    {showOdds && match.odds && (match.odds.home > 1 || match.odds.draw > 1 || match.odds.away > 1) && (
                        <div className="grid grid-cols-3 gap-3">
                            {[
                                { key: 'home', label: '–ü1', sublabel: '–ü–æ–±–µ–¥–∞ 1', odds: match.odds.home },
                                { key: 'draw', label: 'X', sublabel: '–ù–∏—á—å—è', odds: match.odds.draw },
                                { key: 'away', label: '–ü2', sublabel: '–ü–æ–±–µ–¥–∞ 2', odds: match.odds.away }
                            ].filter(item => item.odds && item.odds > 1).map(item => (
                                <button
                                    key={item.key}
                                    onClick={() => onBet?.(item.key, item.odds)}
                                    className="odds-btn p-4 rounded-xl text-center group"
                                >
                                    <div className="text-[10px] text-gray-500 group-hover:text-black/60 mb-1 uppercase tracking-wider">{item.label}</div>
                                    <div className="text-xl font-bold">{item.odds}</div>
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // ==================== BET MODAL ====================
        const BetModal = ({ isOpen, onClose, betType, odds, balance, matchId, match, onSuccess }) => {
            const [amount, setAmount] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const betNames = {
                home: { name: '–ü–æ–±–µ–¥–∞ —Ö–æ–∑—è–µ–≤', short: '–ü1' },
                draw: { name: '–ù–∏—á—å—è', short: 'X' },
                away: { name: '–ü–æ–±–µ–¥–∞ –≥–æ—Å—Ç–µ–π', short: '–ü2' }
            };
            const potentialWin = amount ? Math.floor(parseFloat(amount) * odds) : 0;

            const handleBet = async () => {
                if (!amount || parseFloat(amount) <= 0) {
                    setError('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏');
                    return;
                }
                if (parseFloat(amount) > balance) {
                    setError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤!');
                    return;
                }

                setLoading(true);
                setError('');
                try {
                    await api.post('/api/bet/place', {
                        match_id: matchId,
                        bet_type: betType,
                        amount: parseInt(amount)
                    });
                    tg?.HapticFeedback?.notificationOccurred?.('success');
                    tg?.showAlert?.('–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! üéâ') || alert('–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! üéâ');
                    onSuccess?.();
                    onClose();
                } catch (err) {
                    tg?.HapticFeedback?.notificationOccurred?.('error');
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (isOpen) {
                    setAmount('');
                    setError('');
                }
            }, [isOpen]);

            if (!isOpen) return null;

            const bet = betNames[betType] || {};

            return (
                <div className="fixed inset-0 bg-black/85 flex items-end justify-center z-50" onClick={onClose}>
                    <div className="bg-rm-card w-full max-w-lg rounded-t-3xl animate-slide" onClick={e => e.stopPropagation()}>
                        {/* Handle */}
                        <div className="flex justify-center pt-3 pb-2">
                            <div className="w-10 h-1 bg-gray-600 rounded-full"></div>
                        </div>

                        <div className="px-6 pb-8">
                            {/* Header */}
                            <div className="text-center mb-6">
                                <div className="inline-flex items-center gap-2 bg-rm-gold/10 text-rm-gold px-4 py-2 rounded-full mb-3">
                                    <span className="text-2xl font-bold">{bet.short}</span>
                                </div>
                                <h3 className="text-xl font-bold">{bet.name}</h3>
                                {match && (
                                    <p className="text-gray-400 text-sm mt-1">{match.home_team} vs {match.away_team}</p>
                                )}
                            </div>

                            {/* Coefficient */}
                            <div className="bg-rm-light/50 rounded-2xl p-4 mb-5 text-center">
                                <span className="text-gray-400 text-sm">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç</span>
                                <div className="text-3xl font-bold text-rm-gold">{odds}</div>
                            </div>

                            {/* Error */}
                            {error && (
                                <div className="bg-red-500/10 border border-red-500/20 text-red-400 p-4 rounded-xl mb-4 text-sm text-center">
                                    {error}
                                </div>
                            )}

                            {/* Input */}
                            <div className="mb-4">
                                <label className="text-gray-400 text-sm mb-2 block">–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏</label>
                                <input
                                    type="number"
                                    value={amount}
                                    onChange={e => setAmount(e.target.value)}
                                    placeholder="0"
                                    className="w-full bg-rm-dark border-2 border-rm-light rounded-xl p-4 text-2xl font-bold text-center focus:border-rm-gold outline-none transition-colors"
                                />
                            </div>

                            {/* Quick amounts */}
                            <div className="flex gap-2 mb-5">
                                {[10, 25, 50, 100].map(val => (
                                    <button
                                        key={val}
                                        onClick={() => setAmount(String(Math.min(val, balance)))}
                                        className="flex-1 bg-rm-light hover:bg-rm-gray transition-colors py-3 rounded-xl text-sm font-semibold"
                                    >
                                        {val}
                                    </button>
                                ))}
                                <button
                                    onClick={() => setAmount(String(balance))}
                                    className="flex-1 bg-rm-gold/20 text-rm-gold hover:bg-rm-gold/30 transition-colors py-3 rounded-xl text-sm font-semibold"
                                >
                                    –í—Å—ë
                                </button>
                            </div>

                            {/* Summary */}
                            {amount && parseFloat(amount) > 0 && (
                                <div className="bg-gradient-to-r from-rm-gold/5 to-rm-gold/10 rounded-2xl p-4 mb-5 border border-rm-gold/20">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-gray-400">–°—Ç–∞–≤–∫–∞</span>
                                        <span className="font-semibold">{parseInt(amount).toLocaleString()} –æ—á–∫–æ–≤</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-400">–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à</span>
                                        <span className="text-rm-gold font-bold text-xl">{potentialWin.toLocaleString()} –æ—á–∫–æ–≤</span>
                                    </div>
                                </div>
                            )}

                            {/* Submit */}
                            <button
                                onClick={handleBet}
                                disabled={loading || !amount || parseFloat(amount) <= 0}
                                className="w-full btn-gold py-4 rounded-xl text-lg disabled:opacity-50 disabled:transform-none"
                            >
                                {loading ? (
                                    <span className="flex items-center justify-center gap-2">
                                        <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                                        </svg>
                                        –û–±—Ä–∞–±–æ—Ç–∫–∞...
                                    </span>
                                ) : '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É'}
                            </button>

                            {/* Balance hint */}
                            <p className="text-center text-gray-500 text-xs mt-3">
                                –ë–∞–ª–∞–Ω—Å: {balance?.toLocaleString()} –æ—á–∫–æ–≤
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== HOME ANALYTICS COMPONENT ====================
        const HomeAnalytics = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [expanded, setExpanded] = useState(false);

            useEffect(() => {
                api.get('/api/match/analytics')
                    .then(d => setData(d))
                    .catch(() => {})
                    .finally(() => setLoading(false));
            }, []);

            if (loading) return (
                <div className="mb-6">
                    <Skeleton className="h-24 w-full" rounded="rounded-2xl" />
                </div>
            );

            if (!data || data.error || (!data.rm_form?.length && !data.opp_form?.length)) return null;

            const a = data;
            const rmStats = a.rm_stats || {};
            const oppStats = a.opp_stats || {};

            return (
                <div className="mb-6">
                    {/* Collapsed preview - always visible */}
                    <button
                        onClick={() => setExpanded(!expanded)}
                        className="w-full glass rounded-2xl p-4 text-left"
                    >
                        <div className="flex items-center justify-between mb-2">
                            <h3 className="font-bold text-sm">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–∞—Ç—á–∞</h3>
                            <span className="text-xs text-gray-500">{expanded ? '‚ñ≤' : '‚ñº'}</span>
                        </div>
                        {/* Mini form badges always shown */}
                        <div className="flex items-center gap-3">
                            <span className="text-xs text-gray-400">–§–æ—Ä–º–∞ RM:</span>
                            <div className="flex gap-1">
                                {(a.rm_form || []).map((m, i) => (
                                    <span key={i} className={`w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold ${
                                        m.result === 'W' ? 'bg-green-500/30 text-green-400' :
                                        m.result === 'D' ? 'bg-yellow-500/30 text-yellow-400' :
                                        'bg-red-500/30 text-red-400'
                                    }`}>{m.result === 'W' ? '–í' : m.result === 'D' ? '–ù' : '–ü'}</span>
                                ))}
                            </div>
                            {a.streak && <span className="text-[10px] text-rm-gold ml-auto">üî• {a.streak}</span>}
                        </div>
                        {a.opp_form?.length > 0 && (
                            <div className="flex items-center gap-3 mt-2">
                                <span className="text-xs text-gray-400 truncate max-w-[80px]">{a.opponent}:</span>
                                <div className="flex gap-1">
                                    {a.opp_form.map((m, i) => (
                                        <span key={i} className={`w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold ${
                                            m.result === 'W' ? 'bg-green-500/30 text-green-400' :
                                            m.result === 'D' ? 'bg-yellow-500/30 text-yellow-400' :
                                            'bg-red-500/30 text-red-400'
                                        }`}>{m.result === 'W' ? '–í' : m.result === 'D' ? '–ù' : '–ü'}</span>
                                    ))}
                                </div>
                            </div>
                        )}
                    </button>

                    {/* Expanded details */}
                    {expanded && (
                        <div className="space-y-3 mt-3 animate-fade">
                            {/* RM Stats */}
                            {rmStats.matches && (
                                <div className="glass rounded-2xl p-4">
                                    <h4 className="font-bold text-sm mb-3">‚öΩ Real Madrid ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ {rmStats.matches}</h4>
                                    <div className="grid grid-cols-3 gap-2 mb-3">
                                        <div className="bg-green-500/10 rounded-xl p-2 text-center">
                                            <div className="font-bold text-green-400">{rmStats.wins}</div>
                                            <div className="text-[10px] text-gray-500">–ü–æ–±–µ–¥</div>
                                        </div>
                                        <div className="bg-yellow-500/10 rounded-xl p-2 text-center">
                                            <div className="font-bold text-yellow-400">{rmStats.draws}</div>
                                            <div className="text-[10px] text-gray-500">–ù–∏—á—å–∏—Ö</div>
                                        </div>
                                        <div className="bg-red-500/10 rounded-xl p-2 text-center">
                                            <div className="font-bold text-red-400">{rmStats.losses}</div>
                                            <div className="text-[10px] text-gray-500">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</div>
                                        </div>
                                    </div>
                                    <div className="space-y-1.5 text-xs">
                                        <div className="flex justify-between"><span className="text-gray-400">–ó–∞–±–∏—Ç–æ / –ü—Ä–æ–ø—É—â–µ–Ω–æ</span><span>{rmStats.goals_for} / {rmStats.goals_against}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-400">–°—Ä. —Ç–æ—Ç–∞–ª</span><span className="text-rm-gold font-semibold">{rmStats.avg_total}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-400">–°—É—Ö–∏–µ –º–∞—Ç—á–∏</span><span>{rmStats.clean_sheets} –∏–∑ {rmStats.matches}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-400">–û–±–µ –∑–∞–±–∏–ª–∏</span><span>{rmStats.btts} –∏–∑ {rmStats.matches} ({Math.round(rmStats.btts / rmStats.matches * 100)}%)</span></div>
                                    </div>
                                    {/* Match list */}
                                    <div className="mt-3 space-y-1.5">
                                        {(a.rm_form || []).map((m, i) => (
                                            <div key={i} className="flex items-center justify-between text-xs bg-rm-light/20 rounded-lg px-2 py-1.5">
                                                <div className="flex items-center gap-1.5">
                                                    <span className={`w-4 h-4 rounded flex items-center justify-center text-[9px] font-bold ${
                                                        m.result === 'W' ? 'bg-green-500/30 text-green-400' :
                                                        m.result === 'D' ? 'bg-yellow-500/30 text-yellow-400' :
                                                        'bg-red-500/30 text-red-400'
                                                    }`}>{m.result}</span>
                                                    <span className="text-gray-300 truncate max-w-[120px]">{m.is_home ? 'vs' : '@'} {m.opponent}</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-semibold">{m.score}</span>
                                                    <span className="text-[10px] text-gray-600">{m.date}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Opponent Stats */}
                            {oppStats.matches && (
                                <div className="glass rounded-2xl p-4">
                                    <h4 className="font-bold text-sm mb-3">üÜö {a.opponent} ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ {oppStats.matches}</h4>
                                    <div className="grid grid-cols-3 gap-2 mb-3">
                                        <div className="bg-green-500/10 rounded-xl p-2 text-center">
                                            <div className="font-bold text-green-400">{oppStats.wins}</div>
                                            <div className="text-[10px] text-gray-500">–ü–æ–±–µ–¥</div>
                                        </div>
                                        <div className="bg-yellow-500/10 rounded-xl p-2 text-center">
                                            <div className="font-bold text-yellow-400">{oppStats.draws}</div>
                                            <div className="text-[10px] text-gray-500">–ù–∏—á—å–∏—Ö</div>
                                        </div>
                                        <div className="bg-red-500/10 rounded-xl p-2 text-center">
                                            <div className="font-bold text-red-400">{oppStats.losses}</div>
                                            <div className="text-[10px] text-gray-500">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</div>
                                        </div>
                                    </div>
                                    <div className="space-y-1.5 text-xs">
                                        <div className="flex justify-between"><span className="text-gray-400">–ó–∞–±–∏—Ç–æ / –ü—Ä–æ–ø—É—â–µ–Ω–æ</span><span>{oppStats.goals_for} / {oppStats.goals_against}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-400">–°—Ä. —Ç–æ—Ç–∞–ª</span><span className="text-rm-gold font-semibold">{oppStats.avg_total}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-400">–û–±–µ –∑–∞–±–∏–ª–∏</span><span>{oppStats.btts} –∏–∑ {oppStats.matches} ({Math.round(oppStats.btts / oppStats.matches * 100)}%)</span></div>
                                    </div>
                                    <div className="mt-3 space-y-1.5">
                                        {(a.opp_form || []).map((m, i) => (
                                            <div key={i} className="flex items-center justify-between text-xs bg-rm-light/20 rounded-lg px-2 py-1.5">
                                                <div className="flex items-center gap-1.5">
                                                    <span className={`w-4 h-4 rounded flex items-center justify-center text-[9px] font-bold ${
                                                        m.result === 'W' ? 'bg-green-500/30 text-green-400' :
                                                        m.result === 'D' ? 'bg-yellow-500/30 text-yellow-400' :
                                                        'bg-red-500/30 text-red-400'
                                                    }`}>{m.result}</span>
                                                    <span className="text-gray-300 truncate max-w-[120px]">{m.opponent}</span>
                                                </div>
                                                <span className="font-semibold">{m.score}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Key insights */}
                            {rmStats.matches && oppStats.matches && (
                                <div className="glass rounded-2xl p-4">
                                    <h4 className="font-bold text-sm mb-3">üí° –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã</h4>
                                    <div className="space-y-2 text-xs">
                                        <div className="bg-rm-light/20 rounded-lg px-3 py-2 flex justify-between">
                                            <span className="text-gray-400">–û–∂–∏–¥–∞–µ–º—ã–π —Ç–æ—Ç–∞–ª</span>
                                            <span className="text-rm-gold font-bold">{((rmStats.avg_total + oppStats.avg_total) / 2).toFixed(1)} –≥–æ–ª–æ–≤</span>
                                        </div>
                                        <div className="bg-rm-light/20 rounded-lg px-3 py-2 flex justify-between">
                                            <span className="text-gray-400">–û–±–µ –∑–∞–±—å—é—Ç (–≤–µ—Ä.)</span>
                                            <span className="text-rm-gold font-bold">{Math.round((rmStats.btts / rmStats.matches + oppStats.btts / oppStats.matches) / 2 * 100)}%</span>
                                        </div>
                                        <div className="bg-rm-light/20 rounded-lg px-3 py-2 flex justify-between">
                                            <span className="text-gray-400">RM –∑–∞–±–∏–≤–∞–µ—Ç –≤ —Å—Ä.</span>
                                            <span className="font-bold">{rmStats.avg_goals_for}</span>
                                        </div>
                                        <div className="bg-rm-light/20 rounded-lg px-3 py-2 flex justify-between">
                                            <span className="text-gray-400">{a.opponent} –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –≤ —Å—Ä.</span>
                                            <span className="font-bold">{oppStats.avg_goals_against}</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* H2H */}
                            {a.h2h?.length > 0 && (
                                <div className="glass rounded-2xl p-4">
                                    <h4 className="font-bold text-sm mb-3">‚öîÔ∏è –õ–∏—á–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏</h4>
                                    {a.h2h_stats?.total > 0 && (
                                        <div className="flex justify-around mb-3 bg-rm-light/20 rounded-xl py-2">
                                            <div className="text-center">
                                                <div className="font-bold text-green-400">{a.h2h_stats.rm_wins}</div>
                                                <div className="text-[10px] text-gray-500">RM</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="font-bold text-yellow-400">{a.h2h_stats.draws}</div>
                                                <div className="text-[10px] text-gray-500">–ù–∏—á—å–∏</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="font-bold text-red-400">{a.h2h_stats.opp_wins}</div>
                                                <div className="text-[10px] text-gray-500">{a.opponent}</div>
                                            </div>
                                        </div>
                                    )}
                                    <div className="space-y-1.5">
                                        {a.h2h.map((m, i) => (
                                            <div key={i} className="flex items-center justify-between text-xs bg-rm-light/20 rounded-lg px-2 py-1.5">
                                                <span className="text-gray-300 truncate max-w-[35%]">{m.home_team}</span>
                                                <span className="font-bold text-rm-gold">{m.score}</span>
                                                <span className="text-gray-300 truncate max-w-[35%] text-right">{m.away_team}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // ==================== HOME PAGE ====================
        const HomePage = ({ user, match, liveMatch, loading, onNavigate, onQuizComplete, streams }) => {
            const [quizStatus, setQuizStatus] = useState(null);
            const [quizQuestion, setQuizQuestion] = useState(null);
            const [quizLoading, setQuizLoading] = useState(false);
            const [quizResult, setQuizResult] = useState(null);
            const [showRules, setShowRules] = useState(false);
            const [timer, setTimer] = useState(0);
            const [activeGame, setActiveGame] = useState(null); // 'quiz', 'penalty', 'catch', 'runner'
            const [gamesStatus, setGamesStatus] = useState(null);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä (–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö)
            useEffect(() => {
                api.get('/api/games/status').then(setGamesStatus).catch(() => {});
                api.get('/api/quiz/status').then(setQuizStatus).catch(() => {});
            }, []);

            // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞
            useEffect(() => {
                if (!quizQuestion || timer <= 0) return;

                const interval = setInterval(() => {
                    setTimer(t => {
                        if (t <= 1) {
                            // –í—Ä–µ–º—è –≤—ã—à–ª–æ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–∏–≥—Ä—ã—à
                            clearInterval(interval);
                            setQuizResult({ correct: false, points_earned: 0, timeout: true });
                            setQuizQuestion(null);
                            setQuizStatus({ available: false, remaining_seconds: 86400, remaining_text: "24—á 0–º" });
                            return 0;
                        }
                        return t - 1;
                    });
                }, 1000);

                return () => clearInterval(interval);
            }, [quizQuestion, timer]);

            const startQuiz = async (difficulty) => {
                setQuizLoading(true);
                try {
                    const q = await api.get(`/api/quiz/question?difficulty=${difficulty}`);
                    setQuizQuestion({ ...q, difficulty });
                    setQuizResult(null);
                    setTimer(15);  // 15 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ—Ç–≤–µ—Ç
                } catch (err) {
                    tg?.showAlert?.(err.message) || alert(err.message);
                } finally {
                    setQuizLoading(false);
                }
            };

            const submitAnswer = async (answerIndex) => {
                if (!quizQuestion) return;
                setQuizLoading(true);
                setTimer(0);  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
                try {
                    const result = await api.post('/api/quiz/answer', {
                        difficulty: quizQuestion.difficulty,
                        question: quizQuestion.question,
                        answer_index: answerIndex
                    });
                    setQuizResult(result);
                    setQuizQuestion(null);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    setQuizStatus({ available: false, remaining_seconds: 86400, remaining_text: "24—á 0–º" });
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞
                    if (onQuizComplete) onQuizComplete();
                } catch (err) {
                    tg?.showAlert?.(err.message) || alert(err.message);
                } finally {
                    setQuizLoading(false);
                }
            };

            return (
                <div className="p-4 pb-28 animate-fade">
                    {/* Welcome */}
                    <div className="mb-6">
                        <h1 className="text-2xl font-bold mb-1">
                            –ü—Ä–∏–≤–µ—Ç, {user?.first_name || '–§–∞–Ω–∞—Ç'}! üëã
                        </h1>
                        <p className="text-gray-400">Hala Madrid!</p>
                    </div>

                    {/* Next Match Preview */}
                    <div className="mb-6">
                        <h2 className="text-lg font-bold mb-4">‚öΩ {liveMatch ? '–ú–∞—Ç—á –∏–¥—ë—Ç' : '–ë–ª–∏–∂–∞–π—à–∏–π –º–∞—Ç—á'}</h2>
                        {loading ? (
                            <div>
                                <LoadingBar text="–ó–∞–≥—Ä—É–∑–∫–∞..." />
                                <Skeleton className="h-32 w-full" rounded="rounded-2xl" />
                            </div>
                        ) : liveMatch ? (
                            <div className="glass rounded-2xl p-5" onClick={() => onNavigate('matches')} style={{cursor:'pointer'}}>
                                <div className="text-center mb-3">
                                    <div className="text-xs text-rm-gold mb-3">{liveMatch.tournament}</div>
                                    <div className="flex items-center justify-center gap-4">
                                        <div className="flex flex-col items-center gap-1 flex-1">
                                            {liveMatch.home_logo && <img src={liveMatch.home_logo} className="w-12 h-12 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            <span className={`text-sm font-bold ${liveMatch.home_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{liveMatch.home_team}</span>
                                        </div>
                                        <div className="flex flex-col items-center">
                                            <div className="flex items-center gap-2">
                                                <span className="text-3xl font-black tabular-nums">{liveMatch.home_score}</span>
                                                <span className="text-gray-500 text-xl">:</span>
                                                <span className="text-3xl font-black tabular-nums">{liveMatch.away_score}</span>
                                            </div>
                                            <div className="flex items-center gap-1.5 mt-1">
                                                <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                                                <span className="text-red-400 text-sm font-bold">{liveMatch.minute}</span>
                                            </div>
                                        </div>
                                        <div className="flex flex-col items-center gap-1 flex-1">
                                            {liveMatch.away_logo && <img src={liveMatch.away_logo} className="w-12 h-12 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            <span className={`text-sm font-bold ${liveMatch.away_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{liveMatch.away_team}</span>
                                        </div>
                                    </div>
                                </div>
                                <button
                                    onClick={(e) => { e.stopPropagation(); onNavigate('bets'); }}
                                    className="w-full btn-gold py-3 rounded-xl font-bold mt-2"
                                >
                                    üé∞ –ü–ï–†–ï–ô–¢–ò –ö –°–¢–ê–í–ö–ê–ú
                                </button>
                            </div>
                        ) : match ? (
                            <div className="glass rounded-2xl p-5">
                                <div className="text-center mb-4">
                                    <div className="text-xs text-rm-gold mb-2">{match.competition}</div>
                                    <div className="flex items-center justify-center gap-4 my-3">
                                        <div className="flex flex-col items-center gap-1 flex-1">
                                            {match.home_logo && <img src={match.home_logo} className="w-10 h-10 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            <span className={`text-sm font-bold ${match.home_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{match.home_team}</span>
                                        </div>
                                        <span className="text-gray-500 text-lg font-bold">vs</span>
                                        <div className="flex flex-col items-center gap-1 flex-1">
                                            {match.away_logo && <img src={match.away_logo} className="w-10 h-10 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            <span className={`text-sm font-bold ${match.away_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{match.away_team}</span>
                                        </div>
                                    </div>
                                    <div className="text-gray-400 text-sm">{match.date}</div>
                                </div>
                                <button
                                    onClick={() => onNavigate('bets')}
                                    className="w-full btn-gold py-3 rounded-xl font-bold"
                                >
                                    üé∞ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å—Ç–∞–≤–∫–∞–º
                                </button>
                            </div>
                        ) : (
                            <div className="glass rounded-2xl p-8 text-center">
                                <div className="text-4xl mb-3">‚è±Ô∏è</div>
                                <div className="text-gray-400 mb-2">–°—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã</div>
                                <div className="text-gray-500 text-sm">–ú–∞—Ç—á —Å–∫–æ—Ä–æ –Ω–∞—á–Ω—ë—Ç—Å—è –∏–ª–∏ —É–∂–µ –∏–¥—ë—Ç</div>
                                <StreamBlock streams={streams?.length > 0 ? streams : [{name:'LiveBall',url:'https://liveball.website/',type:'iframe'}]} compact />
                            </div>
                        )}
                    </div>

                    {/* Analytics under match */}
                    <HomeAnalytics />

                    {/* Mini Games Section */}
                    <div className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-lg font-bold">üéÆ –ú–∏–Ω–∏-–∏–≥—Ä—ã</h2>
                            <button
                                onClick={() => setShowRules(true)}
                                className="text-xs text-rm-gold"
                            >
                                –ü—Ä–∞–≤–∏–ª–∞
                            </button>
                        </div>

                        {/* Game Status - Cooldown */}
                        {!gamesStatus?.available && !activeGame && (
                            <div className="glass rounded-2xl p-5 text-center mb-4">
                                <div className="text-4xl mb-3">‚è∞</div>
                                <div className="font-semibold mb-2">–°–ª–µ–¥—É—é—â–∞—è –∏–≥—Ä–∞ —á–µ—Ä–µ–∑</div>
                                <div className="text-2xl font-bold text-rm-gold">{gamesStatus?.remaining_text || quizStatus?.remaining_text || '...'}</div>
                            </div>
                        )}

                        {/* Game Selection */}
                        {gamesStatus?.available && !activeGame && !quizQuestion && !quizResult && (
                            <div className="glass rounded-2xl p-5">
                                <div className="text-center mb-4">
                                    <div className="text-4xl mb-2">üéØ</div>
                                    <div className="font-semibold">–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É</div>
                                    <div className="text-gray-400 text-xs mt-1">1 –∏–≥—Ä–∞ –≤ 24 —á–∞—Å–∞</div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button
                                        onClick={() => setActiveGame('quiz')}
                                        className="bg-purple-500/20 border border-purple-500/30 hover:bg-purple-500/30 py-4 rounded-xl transition"
                                    >
                                        <div className="text-3xl mb-1">üß†</div>
                                        <div className="font-bold text-purple-400">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</div>
                                        <div className="text-xs text-gray-400">–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å</div>
                                    </button>
                                    <button
                                        onClick={() => setActiveGame('penalty')}
                                        className="bg-green-500/20 border border-green-500/30 hover:bg-green-500/30 py-4 rounded-xl transition"
                                    >
                                        <div className="text-3xl mb-1">‚öΩ</div>
                                        <div className="font-bold text-green-400">–ü–µ–Ω–∞–ª—å—Ç–∏</div>
                                        <div className="text-xs text-gray-400">–ó–∞–±–µ–π 5 —É–¥–∞—Ä–æ–≤</div>
                                    </button>
                                    <button
                                        onClick={() => setActiveGame('memory')}
                                        className="bg-pink-500/20 border border-pink-500/30 hover:bg-pink-500/30 py-4 rounded-xl transition"
                                    >
                                        <div className="text-3xl mb-1">üß†</div>
                                        <div className="font-bold text-pink-400">Memory</div>
                                        <div className="text-xs text-gray-400">–ù–∞–π–¥–∏ –ø–∞—Ä—ã</div>
                                    </button>
                                    <button
                                        onClick={() => setActiveGame('catch')}
                                        className="bg-yellow-500/20 border border-yellow-500/30 py-4 rounded-xl transition relative overflow-hidden"
                                    >
                                        <div className="text-3xl mb-1">üêî</div>
                                        <div className="font-bold text-yellow-400">–ù—É, –ø–æ–≥–æ–¥–∏!</div>
                                        <div className="text-xs text-gray-400">–õ–æ–≤–∏ —è–π—Ü–∞!</div>
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Quiz Game */}
                        {activeGame === 'quiz' && !quizQuestion && !quizResult && (
                            <div className="glass rounded-2xl p-5">
                                <button onClick={() => setActiveGame(null)} className="text-gray-400 text-sm mb-4">‚Üê –ù–∞–∑–∞–¥</button>
                                <div className="text-center mb-4">
                                    <div className="text-4xl mb-2">üß†</div>
                                    <div className="font-semibold">–í—ã–±–µ—Ä–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button
                                        onClick={() => startQuiz('easy')}
                                        disabled={quizLoading}
                                        className="bg-green-500/20 border border-green-500/30 text-green-400 py-3 rounded-xl font-semibold"
                                    >
                                        –õ—ë–≥–∫–∏–π (+5)
                                    </button>
                                    <button
                                        onClick={() => startQuiz('medium')}
                                        disabled={quizLoading}
                                        className="bg-yellow-500/20 border border-yellow-500/30 text-yellow-400 py-3 rounded-xl font-semibold"
                                    >
                                        –°—Ä–µ–¥–Ω–∏–π (+10)
                                    </button>
                                    <button
                                        onClick={() => startQuiz('hard')}
                                        disabled={quizLoading}
                                        className="bg-orange-500/20 border border-orange-500/30 text-orange-400 py-3 rounded-xl font-semibold"
                                    >
                                        –°–ª–æ–∂–Ω—ã–π (+15)
                                    </button>
                                    <button
                                        onClick={() => startQuiz('expert')}
                                        disabled={quizLoading}
                                        className="bg-red-500/20 border border-red-500/30 text-red-400 py-3 rounded-xl font-semibold"
                                    >
                                        –≠–∫—Å–ø–µ—Ä—Ç (+25)
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Quiz Result */}
                        {quizResult && (
                            <div className="glass rounded-2xl p-5 text-center">
                                <div className="text-5xl mb-3">{quizResult.timeout ? '‚è∞' : quizResult.correct ? 'üéâ' : 'üò¢'}</div>
                                <div className="text-xl font-bold mb-2">
                                    {quizResult.timeout ? '–í—Ä–µ–º—è –≤—ã—à–ª–æ!' : quizResult.correct ? '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!' : '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ'}
                                </div>
                                {quizResult.correct && (
                                    <div className="text-green-400 font-bold text-lg">+{quizResult.points_earned} –æ—á–∫–æ–≤</div>
                                )}
                                <div className="text-gray-400 text-sm mt-4">–°–ª–µ–¥—É—é—â–∞—è –∏–≥—Ä–∞ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞</div>
                            </div>
                        )}

                        {/* Quiz Question */}
                        {quizQuestion && (
                            <div className="glass rounded-2xl p-5 quiz-protected" onContextMenu={e => e.preventDefault()} onCopy={e => e.preventDefault()}>
                                {/* –¢–∞–π–º–µ—Ä */}
                                <div className="flex justify-between items-center mb-4">
                                    <span className={`text-xs px-3 py-1 rounded-full ${
                                        quizQuestion.difficulty === 'easy' ? 'bg-green-500/20 text-green-400' :
                                        quizQuestion.difficulty === 'medium' ? 'bg-yellow-500/20 text-yellow-400' :
                                        quizQuestion.difficulty === 'hard' ? 'bg-orange-500/20 text-orange-400' :
                                        'bg-red-500/20 text-red-400'
                                    }`}>
                                        +{quizQuestion.points} –æ—á–∫–æ–≤
                                    </span>
                                    <div className={`text-lg font-bold px-3 py-1 rounded-full ${
                                        timer <= 5 ? 'bg-red-500/30 text-red-400 animate-pulse' : 'bg-white/10 text-white'
                                    }`}>
                                        ‚è±Ô∏è {timer}—Å
                                    </div>
                                </div>
                                <div className="text-lg font-semibold text-center mb-5">{quizQuestion.question}</div>
                                <div className="space-y-3">
                                    {quizQuestion.answers.map((ans, i) => (
                                        <button
                                            key={i}
                                            onClick={() => submitAnswer(i)}
                                            disabled={quizLoading}
                                            className="w-full bg-rm-light hover:bg-rm-gray py-3 px-4 rounded-xl text-left transition"
                                        >
                                            {ans}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Penalty Game Modal */}
                    {activeGame === 'penalty' && (
                        <PenaltyGame
                            onClose={() => {
                                setActiveGame(null);
                                setGamesStatus({ available: false, remaining_seconds: 86400, remaining_text: "24—á 0–º" });
                                api.get('/api/games/status').then(setGamesStatus).catch(() => {});
                            }}
                            onWin={(points) => {
                                setGamesStatus({ available: false, remaining_seconds: 86400, remaining_text: "24—á 0–º" });
                                if (onQuizComplete) onQuizComplete(points);
                            }}
                            gameStatus={gamesStatus}
                        />
                    )}

                    {/* Memory Game Modal */}
                    {activeGame === 'memory' && (
                        <MemoryGame
                            onClose={() => {
                                setActiveGame(null);
                                setGamesStatus({ available: false, remaining_seconds: 86400, remaining_text: "24—á 0–º" });
                                api.get('/api/games/status').then(setGamesStatus).catch(() => {});
                            }}
                            onWin={(points) => {
                                setGamesStatus({ available: false, remaining_seconds: 86400, remaining_text: "24—á 0–º" });
                                if (onQuizComplete) onQuizComplete(points);
                            }}
                            gameStatus={gamesStatus}
                        />
                    )}


                    {/* Nu Pogodi Game Modal */}
                    {activeGame === 'catch' && (
                        <NuPogodiGame
                            onClose={() => {
                                setActiveGame(null);
                                setGamesStatus({ available: false, remaining_seconds: 86400, remaining_text: "24—á 0–º" });
                                api.get('/api/games/status').then(setGamesStatus).catch(() => {});
                            }}
                            onWin={(points) => {
                                setGamesStatus({ available: false, remaining_seconds: 86400, remaining_text: "24—á 0–º" });
                                if (onQuizComplete) onQuizComplete(points);
                            }}
                            gameStatus={gamesStatus}
                        />
                    )}

                    {/* Rules Modal */}
                    {/* Rules Modal */}
                    {showRules && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => setShowRules(false)}>
                            <div className="bg-rm-dark rounded-2xl p-6 max-w-sm" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">üìú –ü—Ä–∞–≤–∏–ª–∞ –º–∏–Ω–∏-–∏–≥—Ä</h3>
                                <div className="space-y-3 text-sm text-gray-300">
                                    <p>üéÆ –ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞ —Ç—ã –º–æ–∂–µ—à—å —Å—ã–≥—Ä–∞—Ç—å –≤ 1 –∏–≥—Ä—É</p>
                                    <p>üìä –£—Ä–æ–≤–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</p>
                                    <ul className="ml-4 space-y-1">
                                        <li>‚Ä¢ –õ—ë–≥–∫–∏–π: <span className="text-green-400">+5 –æ—á–∫–æ–≤</span></li>
                                        <li>‚Ä¢ –°—Ä–µ–¥–Ω–∏–π: <span className="text-yellow-400">+10 –æ—á–∫–æ–≤</span></li>
                                        <li>‚Ä¢ –°–ª–æ–∂–Ω—ã–π: <span className="text-orange-400">+15 –æ—á–∫–æ–≤</span></li>
                                        <li>‚Ä¢ –≠–∫—Å–ø–µ—Ä—Ç: <span className="text-red-400">+25 –æ—á–∫–æ–≤</span></li>
                                    </ul>
                                    <p>‚úÖ –ü–æ–±–µ–¥–∞ = –æ—á–∫–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å</p>
                                    <p>‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à = –ø–æ–ø—Ä–æ–±—É–π –∑–∞–≤—Ç—Ä–∞</p>
                                </div>
                                <button
                                    onClick={() => setShowRules(false)}
                                    className="w-full btn-gold py-3 rounded-xl font-bold mt-6"
                                >
                                    –ü–æ–Ω—è—Ç–Ω–æ!
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        // ==================== PENALTY GAME (iframe) ====================
        const PenaltyGame = ({ onClose, onWin, gameStatus }) => {
            const iframeRef = useRef(null);
            const [gameStarted, setGameStarted] = useState(false);
            const [resultSent, setResultSent] = useState(false);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç iframe
            useEffect(() => {
                const handleMessage = async (event) => {
                    const { type, won, goals, difficulty, reward } = event.data || {};

                    if (type === 'closeGame') {
                        onClose();
                    }

                    // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ - –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫—É —Å—Ä–∞–∑—É!
                    if (type === 'gameStart' && !gameStarted) {
                        setGameStarted(true);
                        try {
                            await api.post('/api/games/start', { game: 'penalty', difficulty });
                        } catch (err) {
                            console.error('Error starting game:', err);
                        }
                    }

                    if (type === 'gameResult' && !resultSent) {
                        setResultSent(true);
                        try {
                            await api.post('/api/games/result', {
                                game: 'penalty',
                                difficulty,
                                won,
                                score: goals,
                                points: won ? reward : 0
                            });

                            if (won && onWin) {
                                onWin(reward);
                            }
                        } catch (err) {
                            console.error('Error saving game result:', err);
                        }
                        setTimeout(() => onClose(), 3000);
                    }
                };

                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, [onClose, onWin, gameStarted, resultSent]);

            return (
                <div className="fixed inset-0 z-50 bg-black">
                    <iframe
                        ref={iframeRef}
                        src="penalty.html"
                        className="w-full h-full border-0"
                        allow="autoplay"
                    />
                </div>
            );
        };

        // ==================== MEMORY GAME (iframe) ====================
        const MemoryGame = ({ onClose, onWin, gameStatus }) => {
            const iframeRef = useRef(null);
            const [gameStarted, setGameStarted] = useState(false);
            const [resultSent, setResultSent] = useState(false);

            useEffect(() => {
                const handleMessage = async (event) => {
                    const { type, won, score, difficulty, reward } = event.data || {};

                    if (type === 'closeGame') {
                        onClose();
                    }

                    if (type === 'gameStart' && !gameStarted) {
                        setGameStarted(true);
                        try {
                            await api.post('/api/games/start', { game: 'memory', difficulty });
                        } catch (err) {
                            console.error('Error starting game:', err);
                        }
                    }

                    if (type === 'gameResult' && !resultSent) {
                        setResultSent(true);
                        try {
                            await api.post('/api/games/result', {
                                game: 'memory',
                                difficulty,
                                won,
                                score: score || 0,
                                points: won ? reward : 0
                            });

                            if (won && onWin) {
                                onWin(reward);
                            }
                        } catch (err) {
                            console.error('Error saving game result:', err);
                        }
                        setTimeout(() => onClose(), 3000);
                    }
                };

                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, [onClose, onWin, gameStarted, resultSent]);

            return (
                <div className="fixed inset-0 z-50 bg-black">
                    <iframe
                        ref={iframeRef}
                        src="memory.html"
                        className="w-full h-full border-0"
                        allow="autoplay"
                    />
                </div>
            );
        };

        // ==================== NU POGODI GAME (iframe) ====================
        const NuPogodiGame = ({ onClose, onWin, gameStatus }) => {
            const iframeRef = useRef(null);
            const [gameStarted, setGameStarted] = useState(false);
            const [resultSent, setResultSent] = useState(false);

            useEffect(() => {
                const handleMessage = async (event) => {
                    const { type, won, score, difficulty, reward } = event.data || {};

                    if (type === 'closeGame') {
                        onClose();
                    }

                    if (type === 'gameStart' && !gameStarted) {
                        setGameStarted(true);
                        try {
                            await api.post('/api/games/start', { game: 'catch', difficulty });
                        } catch (err) {
                            console.error('Error starting game:', err);
                        }
                    }

                    if (type === 'gameResult' && !resultSent) {
                        setResultSent(true);
                        try {
                            await api.post('/api/games/result', {
                                game: 'catch',
                                difficulty,
                                won,
                                score,
                                points: won ? reward : 0
                            });

                            if (won && onWin) {
                                onWin(reward);
                            }
                        } catch (err) {
                            console.error('Error saving game result:', err);
                        }
                        // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫
                        setTimeout(() => onClose(), 3000);
                    }
                };

                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, [onClose, onWin, gameStarted, resultSent]);

            return (
                <div className="fixed inset-0 z-50 bg-black">
                    <iframe
                        ref={iframeRef}
                        src="nu-pogodi.html"
                        className="w-full h-full border-0"
                        allow="autoplay"
                    />
                </div>
            );
        };

        // ==================== MATCH DETAIL VIEW ====================
        const MatchDetailView = ({ matchId, onBack }) => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('events');
            const [showHighlights, setShowHighlights] = useState(false);

            useEffect(() => {
                if (!matchId) return;
                setLoading(true);
                api.get(`/api/match/details/${matchId}`)
                    .then(d => { setData(d); setLoading(false); })
                    .catch(() => setLoading(false));
            }, [matchId]);

            if (loading) return (
                <div className="p-4 pb-28 animate-fade">
                    <button onClick={onBack} className="flex items-center gap-2 text-gray-400 mb-4">‚Üê –ù–∞–∑–∞–¥</button>
                    <LoadingBar text="–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–∞..." />
                </div>
            );

            if (!data || data.error) return (
                <div className="p-4 pb-28">
                    <button onClick={onBack} className="flex items-center gap-2 text-gray-400 mb-4">‚Üê –ù–∞–∑–∞–¥</button>
                    <div className="text-center py-12 text-gray-400">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–∞</div>
                </div>
            );

            const titleMap = {
                'Ball possession': '–í–ª–∞–¥–µ–Ω–∏–µ', 'Possession': '–í–ª–∞–¥–µ–Ω–∏–µ',
                'Expected goals (xG)': 'xG', 'Total shots': '–£–¥–∞—Ä—ã',
                'Shots on target': '–í —Å—Ç–≤–æ—Ä', 'Shots off target': '–ú–∏–º–æ',
                'Blocked shots': '–ó–∞–±–ª–æ–∫.', 'Corner kicks': '–£–≥–ª–æ–≤—ã–µ',
                'Corners': '–£–≥–ª–æ–≤—ã–µ', 'Fouls': '–§–æ–ª—ã', 'Offsides': '–û—Ñ—Å–∞–π–¥—ã',
                'Yellow cards': '–ñ–ö', 'Red cards': '–ö–ö',
                'Passes': '–ü–µ—Ä–µ–¥–∞—á–∏', 'Accurate passes': '–¢–æ—á–Ω—ã–µ –ø–∞—Å.',
                'Big chances': '–ú–æ–º–µ–Ω—Ç—ã', 'Big chances missed': '–£–ø—É—â–µ–Ω–æ',
                'Crosses': '–ö—Ä–æ—Å—Å—ã', 'Tackles': '–û—Ç–±–æ—Ä—ã',
                'Saves': '–°–µ–π–≤—ã', 'Duels won': '–ï–¥–∏–Ω–æ–±.',
            };

            return (
                <div className="p-4 pb-28 animate-fade">
                    <button onClick={onBack} className="flex items-center gap-2 text-gray-400 mb-4 hover:text-white transition-colors">‚Üê –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>

                    {/* Score Header */}
                    <div className="glass rounded-2xl overflow-hidden mb-4">
                        <div className="text-center px-5 pt-4 pb-2">
                            <div className="text-[11px] text-rm-gold font-medium">{data.tournament} {data.round ? `¬∑ ${data.round}` : ''}</div>
                        </div>
                        <div className="flex items-center justify-center gap-4 px-5 pb-2">
                            {/* Home team */}
                            <div className="flex-1 flex flex-col items-center gap-1.5">
                                {data.home_logo && <img src={data.home_logo} className="w-12 h-12 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                <span className={`text-sm font-bold text-center ${data.home_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{data.home_team}</span>
                            </div>

                            {/* Score */}
                            <div className="flex items-center gap-3">
                                <span className="text-4xl font-black tabular-nums">{data.home_score}</span>
                                <span className="text-gray-600 text-xl">-</span>
                                <span className="text-4xl font-black tabular-nums">{data.away_score}</span>
                            </div>

                            {/* Away team */}
                            <div className="flex-1 flex flex-col items-center gap-1.5">
                                {data.away_logo && <img src={data.away_logo} className="w-12 h-12 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                <span className={`text-sm font-bold text-center ${data.away_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{data.away_team}</span>
                            </div>
                        </div>

                        {/* MVP + Highlights */}
                        <div className="flex flex-col items-center gap-2 pb-4">
                            {data.man_of_match && (
                                <div className="text-xs text-gray-400">‚≠ê MVP: <span className="text-rm-gold font-semibold">{data.man_of_match.name}</span> ({data.man_of_match.rating})</div>
                            )}
                            {data.highlight_url && (() => {
                                // Extract YouTube video ID
                                const ytMatch = data.highlight_url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                                const videoId = ytMatch ? ytMatch[1] : null;

                                return videoId ? (
                                    <div className="w-full">
                                        {!showHighlights ? (
                                            <div className="flex justify-center">
                                                <button onClick={() => setShowHighlights(true)}
                                                    className="inline-flex items-center gap-2 bg-red-600/90 hover:bg-red-500 text-white px-4 py-2 rounded-xl text-sm font-bold transition-all shadow-lg shadow-red-500/20">
                                                    ‚ñ∂Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å —Ö–∞–π–ª–∞–π—Ç—ã
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="w-full">
                                                <div className="relative w-full rounded-xl overflow-hidden" style={{paddingBottom: '56.25%'}}>
                                                    <iframe
                                                        src={`https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`}
                                                        className="absolute inset-0 w-full h-full"
                                                        frameBorder="0"
                                                        allow="autoplay; encrypted-media; fullscreen"
                                                        allowFullScreen
                                                    />
                                                </div>
                                                <button onClick={() => setShowHighlights(false)}
                                                    className="w-full text-center text-xs text-gray-500 mt-2 py-1">
                                                    –°–≤–µ—Ä–Ω—É—Ç—å ‚úï
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <a href={data.highlight_url} target="_blank" rel="noopener noreferrer"
                                        className="inline-flex items-center gap-2 bg-red-600/90 hover:bg-red-500 text-white px-4 py-2 rounded-xl text-sm font-bold transition-all shadow-lg shadow-red-500/20">
                                        ‚ñ∂Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å —Ö–∞–π–ª–∞–π—Ç—ã
                                    </a>
                                );
                            })()}
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                        {['events', 'stats', 'lineups'].map(t => (
                            <button key={t} onClick={() => setActiveTab(t)}
                                className={`px-3 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition-all ${activeTab === t ? 'bg-rm-gold text-black' : 'bg-rm-light text-gray-400'}`}>
                                {t === 'events' ? 'üìã –°–æ–±—ã—Ç–∏—è' : t === 'stats' ? 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' : 'üë• –°–æ—Å—Ç–∞–≤—ã'}
                            </button>
                        ))}
                    </div>

                    {/* Events Tab */}
                    {activeTab === 'events' && (
                        <div className="glass rounded-2xl p-4">
                            {data.events?.length > 0 ? (
                                <div className="space-y-1">
                                    {data.events.map((ev, i) => {
                                        if (ev.type === 'half') return (
                                            <div key={i} className="text-center text-xs font-bold text-gray-400 py-2 border-y border-rm-light my-2">{ev.text}</div>
                                        );
                                        const isHome = ev.home;
                                        const isRM = (isHome && data.home_team?.includes('Real Madrid')) || (!isHome && data.away_team?.includes('Real Madrid'));

                                        const icon = ev.type === 'goal' ? (ev.own_goal ? 'üî¥' : ev.penalty ? 'üÖøÔ∏è' : '‚öΩ') :
                                                     ev.type === 'yellow' ? 'üü®' : ev.type === 'red' || ev.type === 'second_yellow' ? 'üü•' : 'üîÑ';

                                        const content = ev.type === 'goal' ? (
                                            <><span className="font-bold">{ev.player}</span>{ev.assist && <span className="text-gray-500 text-xs"> ({ev.assist})</span>}</>
                                        ) : ev.type === 'sub' ? (
                                            <><span className="text-green-400">‚Üë {ev.player_in}</span><br/><span className="text-red-400/70">‚Üì {ev.player_out}</span></>
                                        ) : <span>{ev.player}</span>;

                                        const score = ev.type === 'goal' ? <span className="text-gray-500 text-[10px]">{ev.score}</span> : null;

                                        // Home events on left, away events on right
                                        return (
                                            <div key={i} className={`flex items-center gap-1 py-2 ${isRM ? 'bg-rm-gold/5' : ''} rounded-lg px-1`}>
                                                {isHome ? (
                                                    <>
                                                        <div className="flex-1 text-right text-sm leading-tight">{content}</div>
                                                        {score && <div className="text-right">{score}</div>}
                                                        <div className="text-base mx-1">{icon}</div>
                                                        <div className="w-9 text-center">
                                                            <span className="text-[11px] font-mono bg-gray-800 text-gray-300 px-1.5 py-0.5 rounded-full">{ev.minute}'</span>
                                                        </div>
                                                        <div className="flex-1"></div>
                                                    </>
                                                ) : (
                                                    <>
                                                        <div className="flex-1"></div>
                                                        <div className="w-9 text-center">
                                                            <span className="text-[11px] font-mono bg-gray-800 text-gray-300 px-1.5 py-0.5 rounded-full">{ev.minute}'</span>
                                                        </div>
                                                        <div className="text-base mx-1">{icon}</div>
                                                        {score && <div>{score}</div>}
                                                        <div className="flex-1 text-left text-sm leading-tight">{content}</div>
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : <div className="text-center text-gray-500 py-8">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ–±—ã—Ç–∏—è—Ö</div>}
                        </div>
                    )}

                    {/* Stats Tab */}
                    {activeTab === 'stats' && (
                        <div className="glass rounded-2xl p-4">
                            {data.stats?.length > 0 ? (
                                <div className="space-y-3">
                                    <div className="flex justify-between text-xs text-gray-400 mb-2">
                                        <span>{data.home_team}</span>
                                        <span>{data.away_team}</span>
                                    </div>
                                    {data.stats.map((s, i) => {
                                        const label = titleMap[s.title] || s.title;
                                        const hv = s.home_num || 0;
                                        const av = s.away_num || 0;
                                        const total = hv + av;
                                        const homePct = total > 0 ? (hv / total * 100) : 50;
                                        const isXg = label.includes('xG');
                                        return (
                                            <div key={i}>
                                                <div className="flex items-center justify-between mb-1">
                                                    <span className={`font-bold text-sm w-12 text-left ${isXg ? 'text-rm-gold' : ''}`}>{s.home}</span>
                                                    <span className="text-[11px] text-gray-400">{label}</span>
                                                    <span className={`font-bold text-sm w-12 text-right ${isXg ? 'text-rm-gold' : ''}`}>{s.away}</span>
                                                </div>
                                                <div className="flex gap-0.5 h-1.5">
                                                    <div className="flex-1 flex justify-end">
                                                        <div className="h-full rounded-l-full bg-blue-500/60 transition-all" style={{width: `${homePct}%`, minWidth: '2px'}}></div>
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="h-full rounded-r-full bg-red-500/60 transition-all" style={{width: `${100-homePct}%`, minWidth: '2px'}}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : <div className="text-center text-gray-500 py-8">–ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>}
                        </div>
                    )}

                    {/* Lineups Tab ‚Äî FotMob Style */}
                    {activeTab === 'lineups' && (() => {
                        const homePlayers = (data.lineups?.home || []).filter(p => !p.substitute);
                        const awayPlayers = (data.lineups?.away || []).filter(p => !p.substitute);
                        const homeSubs = (data.lineups?.home || []).filter(p => p.substitute);
                        const awaySubs = (data.lineups?.away || []).filter(p => p.substitute);
                        const homeFormation = data.lineups?.home_formation || '';
                        const awayFormation = data.lineups?.away_formation || '';
                        const homeRating = data.lineups?.home_rating || '';
                        const awayRating = data.lineups?.away_rating || '';
                        const hasHPos = homePlayers.some(p => p.hx != null);

                        const rBadge = (r) => {
                            const n = parseFloat(r) || 0;
                            return n >= 8 ? 'bg-green-500' : n >= 7 ? 'bg-emerald-600' : n >= 6.5 ? 'bg-orange-500' : n > 0 ? 'bg-red-500' : 'bg-gray-600';
                        };

                        const PlayerDot = ({ p, isHome, isRM }) => {
                            if (!hasHPos || p.hx == null) return null;
                            const left = isHome
                                ? `${p.hx * 47 + 1.5}%`
                                : `${51.5 + (1 - p.hx) * 47}%`;
                            const top = `${p.hy * 82 + 8}%`;
                            const lastName = p.name?.split(' ').pop() || '';

                            return (
                                <div className="absolute flex flex-col items-center" style={{left, top, transform: 'translate(-50%, -50%)', zIndex: 2}}>
                                    {/* Photo + Rating */}
                                    <div className="relative">
                                        {p.rating && (
                                            <div className={`absolute -top-1 -left-1 text-[8px] font-bold text-white px-1 rounded-sm z-10 ${rBadge(p.rating)}`}
                                                style={{minWidth: '18px', textAlign: 'center', lineHeight: '14px'}}>
                                                {p.rating}
                                            </div>
                                        )}
                                        <div className={`w-9 h-9 rounded-full overflow-hidden border-2 ${isRM ? 'border-rm-gold/60' : 'border-gray-600'}`}
                                            style={{background: '#2a2a2e'}}>
                                            {p.image ? (
                                                <img src={p.image} alt="" className="w-full h-full object-cover" loading="lazy"
                                                    onError={(e) => { e.target.style.display='none'; e.target.parentElement.innerHTML=`<span style="display:flex;width:100%;height:100%;align-items:center;justify-content:center;font-size:11px;font-weight:bold;color:#999">${p.number}</span>`; }} />
                                            ) : (
                                                <span className="flex w-full h-full items-center justify-center text-xs font-bold text-gray-400">{p.number}</span>
                                            )}
                                        </div>
                                    </div>
                                    {/* Number + Name */}
                                    <div className="text-[8px] text-gray-300 font-medium mt-0.5 whitespace-nowrap text-center leading-tight">
                                        <span className="text-gray-500">{p.number}</span> {lastName}{p.is_captain ? ' ¬©' : ''}
                                    </div>
                                </div>
                            );
                        };

                        return (<div className="space-y-3">
                            {/* Combined Pitch */}
                            <div className="glass rounded-2xl overflow-hidden">
                                {/* Header: formations */}
                                <div className="flex justify-between items-center px-4 py-2.5" style={{background: '#1a1a1e'}}>
                                    <div className="flex items-center gap-2">
                                        {homeRating && <span className={`text-[10px] font-bold text-white px-1.5 py-0.5 rounded-full ${rBadge(homeRating)}`}>{homeRating}</span>}
                                        <span className="text-xs font-semibold text-white">{data.home_team}</span>
                                        {homeFormation && <span className="text-[10px] text-gray-400">{homeFormation}</span>}
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {awayFormation && <span className="text-[10px] text-gray-400">{awayFormation}</span>}
                                        <span className="text-xs font-semibold text-white">{data.away_team}</span>
                                        {awayRating && <span className={`text-[10px] font-bold text-white px-1.5 py-0.5 rounded-full ${rBadge(awayRating)}`}>{awayRating}</span>}
                                    </div>
                                </div>

                                {/* Pitch area */}
                                {hasHPos ? (
                                    <div className="relative" style={{height: '380px', background: 'linear-gradient(90deg, #1e1e24 0%, #1e1e24 49.5%, #2a2a30 49.5%, #2a2a30 50.5%, #1e1e24 50.5%, #1e1e24 100%)'}}>
                                        {/* Center line */}
                                        <div className="absolute left-1/2 top-0 bottom-0 w-px bg-gray-700/50"></div>

                                        {/* Home players */}
                                        {homePlayers.map((p, i) => (
                                            <PlayerDot key={`h${i}`} p={p} isHome={true} isRM={data.home_team?.includes('Real Madrid')} />
                                        ))}

                                        {/* Away players */}
                                        {awayPlayers.map((p, i) => (
                                            <PlayerDot key={`a${i}`} p={p} isHome={false} isRM={data.away_team?.includes('Real Madrid')} />
                                        ))}
                                    </div>
                                ) : (
                                    /* Fallback: list view */
                                    <div className="p-3 grid grid-cols-2 gap-4">
                                        {['home', 'away'].map(side => (
                                            <div key={side}>
                                                {(data.lineups?.[side] || []).filter(p => !p.substitute).map((p, i) => (
                                                    <div key={i} className="flex items-center gap-1.5 py-1 text-xs border-b border-rm-light/20 last:border-0">
                                                        <span className="text-gray-500 w-4">{p.number}</span>
                                                        <span className="flex-1 truncate">{p.name}</span>
                                                        {p.rating && <span className={`text-[10px] font-bold ${parseFloat(p.rating) >= 7 ? 'text-green-400' : 'text-gray-400'}`}>{p.rating}</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Substitutes */}
                            {(homeSubs.length > 0 || awaySubs.length > 0) && (
                                <div className="glass rounded-2xl p-3">
                                    <div className="text-xs text-gray-500 mb-2 font-semibold">üîÑ –ó–∞–º–µ–Ω—ã</div>
                                    <div className="grid grid-cols-2 gap-x-4">
                                        {/* Home subs */}
                                        <div className="space-y-1">
                                            {homeSubs.map((p, i) => (
                                                <div key={i} className="flex items-center gap-1.5 py-0.5">
                                                    {p.image && <img src={p.image} className="w-5 h-5 rounded-full object-cover" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                                    <span className="text-gray-500 text-[10px]">{p.number}</span>
                                                    <span className="flex-1 text-xs truncate text-gray-300">{p.name?.split(' ').pop()}</span>
                                                    {p.rating && <span className={`text-[10px] font-bold px-1 rounded ${rBadge(p.rating)} text-white`}>{p.rating}</span>}
                                                </div>
                                            ))}
                                        </div>
                                        {/* Away subs */}
                                        <div className="space-y-1">
                                            {awaySubs.map((p, i) => (
                                                <div key={i} className="flex items-center gap-1.5 py-0.5">
                                                    {p.image && <img src={p.image} className="w-5 h-5 rounded-full object-cover" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                                    <span className="text-gray-500 text-[10px]">{p.number}</span>
                                                    <span className="flex-1 text-xs truncate text-gray-300">{p.name?.split(' ').pop()}</span>
                                                    {p.rating && <span className={`text-[10px] font-bold px-1 rounded ${rBadge(p.rating)} text-white`}>{p.rating}</span>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>);
                    })()}

                    {/* Shotmap Tab */}
                    {activeTab === 'shotmap' && (
                        <div className="glass rounded-2xl p-4">
                            {data.shotmap?.length > 0 ? (() => {
                                const homeShots = data.shotmap.filter(s => s.home);
                                const awayShots = data.shotmap.filter(s => !s.home);
                                const homeXG = homeShots.reduce((sum, s) => sum + (s.xG || 0), 0);
                                const awayXG = awayShots.reduce((sum, s) => sum + (s.xG || 0), 0);

                                // Auto-detect: if avg x of home shots > 50, they need mirroring to left side
                                const homeAvgX = homeShots.length > 0 ? homeShots.reduce((s, h) => s + (h.x||0), 0) / homeShots.length : 50;
                                const awayAvgX = awayShots.length > 0 ? awayShots.reduce((s, a) => s + (a.x||0), 0) / awayShots.length : 50;
                                const needsMirror = homeAvgX > 50; // FotMob: both teams shoot "right" (x~100)

                                return (<>
                                    <div className="relative bg-green-900/30 rounded-xl" style={{height: '160px'}}>
                                        <div className="absolute inset-0 border border-green-600/20 rounded-xl"></div>
                                        <div className="absolute left-1/2 top-0 bottom-0 w-px bg-green-600/20"></div>
                                        {/* Goal areas */}
                                        <div className="absolute left-0 top-1/4 bottom-1/4 w-[8%] border-r border-green-600/15"></div>
                                        <div className="absolute right-0 top-1/4 bottom-1/4 w-[8%] border-l border-green-600/15"></div>
                                        {data.shotmap.map((shot, i) => {
                                            // If both teams shoot right (FotMob default): mirror home to left
                                            const x = needsMirror
                                                ? (shot.home ? (100 - (shot.x || 0)) : (shot.x || 50))
                                                : (shot.x || 50);  // Already separated ‚Äî use as-is
                                            return (
                                                <div key={i} className={`absolute w-3 h-3 rounded-full border ${
                                                    shot.result === 'Goal' ? 'bg-green-500 border-green-300 z-10' :
                                                    shot.on_target ? 'bg-yellow-500/70 border-yellow-300' :
                                                    shot.blocked ? 'bg-orange-500/50 border-orange-300' :
                                                    'bg-red-500/40 border-red-400/50'
                                                }`} style={{left: `${Math.min(Math.max(x,3),97)}%`, top: `${Math.min(Math.max(shot.y||50,5),95)}%`}}
                                                title={`${shot.player} ${shot.minute}' xG:${(shot.xG||0).toFixed(2)}`}></div>
                                            );
                                        })}
                                    </div>
                                    <div className="flex justify-between mt-3 text-xs">
                                        <div><div className="text-gray-400">{data.home_team}</div>
                                            <span className="text-rm-gold font-bold">xG {homeXG.toFixed(2)}</span> ¬∑ {homeShots.length} —É–¥.</div>
                                        <div className="text-right"><div className="text-gray-400">{data.away_team}</div>
                                            <span className="text-rm-gold font-bold">xG {awayXG.toFixed(2)}</span> ¬∑ {awayShots.length} —É–¥.</div>
                                    </div>
                                    <div className="flex gap-3 mt-2 text-[10px] text-gray-500">
                                        <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span>–ì–æ–ª</span>
                                        <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-500/70"></span>–í —Å—Ç–≤–æ—Ä</span>
                                        <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-orange-500/50"></span>–ë–ª–æ–∫</span>
                                        <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500/40"></span>–ú–∏–º–æ</span>
                                    </div>
                                </>);
                            })() : <div className="text-center text-gray-500 py-8">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>}
                        </div>
                    )}

                    {/* Top Stats Summary (always visible) */}
                    {data.stats?.length > 0 && (
                        <div className="glass rounded-2xl p-4 mt-4">
                            <h3 className="font-bold mb-3 text-sm text-center">Top stats</h3>
                            {(() => {
                                const topKeys = ['Ball possession', 'Possession', 'Expected goals (xG)', 'Total shots', 'Big chances', 'Shots on target'];
                                const topStats = topKeys.map(k => data.stats.find(s => s.title === k)).filter(Boolean).slice(0, 4);
                                if (!topStats.length) return null;
                                return (
                                    <div className="space-y-3">
                                        {topStats.map((s, i) => {
                                            const isPoss = s.title?.includes('possession');
                                            const hv = s.home_num || 0;
                                            const av = s.away_num || 0;
                                            const total = hv + av;
                                            const homePct = total > 0 ? (hv / total * 100) : 50;
                                            return (
                                                <div key={i}>
                                                    <div className="text-center text-xs text-gray-400 mb-1">{s.title}</div>
                                                    {isPoss ? (
                                                        <div className="flex h-7 rounded-full overflow-hidden">
                                                            <div className="bg-rm-gold flex items-center justify-start pl-2 text-xs font-bold text-black transition-all" style={{width: `${homePct}%`}}>{s.home}</div>
                                                            <div className="bg-gray-600 flex items-center justify-end pr-2 text-xs font-bold text-white transition-all" style={{width: `${100-homePct}%`}}>{s.away}</div>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-center justify-between">
                                                            <span className={`font-bold text-sm w-12 ${hv > av ? 'text-rm-gold' : ''}`}>{s.home}</span>
                                                            <div className="flex-1 mx-3 flex gap-0.5 h-1">
                                                                <div className="flex-1 flex justify-end"><div className="h-full rounded-l-full bg-rm-gold/40" style={{width: `${homePct}%`}}></div></div>
                                                                <div className="flex-1"><div className="h-full rounded-r-full bg-gray-500/40" style={{width: `${100-homePct}%`}}></div></div>
                                                            </div>
                                                            <span className={`font-bold text-sm w-12 text-right ${av > hv ? 'text-rm-gold' : ''}`}>{s.away}</span>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                );
                            })()}
                        </div>
                    )}
                </div>
            );
        };

        // ==================== MATCHES PAGE ====================
        const MatchesPage = ({ matches, results, standings, loading, liveMatch, onNavigate, streams }) => {
            const [tab, setTab] = useState('live');
            const [selectedMatchId, setSelectedMatchId] = useState(null);

            if (selectedMatchId) {
                return <MatchDetailView matchId={selectedMatchId} onBack={() => setSelectedMatchId(null)} />;
            }

            return (
                <div className="p-4 pb-28 animate-fade">
                    <h1 className="text-2xl font-bold mb-5">‚öΩ –ú–∞—Ç—á–∏</h1>

                    {/* Tabs */}
                    <div className="flex gap-3 mb-6 border-b border-rm-light pb-1 overflow-x-auto hide-scrollbar">
                        <button
                            onClick={() => setTab('live')}
                            className={`pb-3 text-sm font-semibold transition-colors relative whitespace-nowrap flex items-center gap-1 ${tab === 'live' ? 'tab-active text-white' : 'text-gray-500'}`}
                        >
                            {liveMatch ? <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> : 'üî¥'} LIVE
                        </button>
                        <button
                            onClick={() => setTab('upcoming')}
                            className={`pb-3 text-sm font-semibold transition-colors relative whitespace-nowrap ${tab === 'upcoming' ? 'tab-active text-white' : 'text-gray-500'}`}
                        >
                            üìÖ –ú–∞—Ç—á–∏
                        </button>
                        <button
                            onClick={() => setTab('results')}
                            className={`pb-3 text-sm font-semibold transition-colors relative whitespace-nowrap ${tab === 'results' ? 'tab-active text-white' : 'text-gray-500'}`}
                        >
                            ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
                        </button>
                        <button
                            onClick={() => setTab('standings')}
                            className={`pb-3 text-sm font-semibold transition-colors relative whitespace-nowrap ${tab === 'standings' ? 'tab-active text-white' : 'text-gray-500'}`}
                        >
                            üèÜ –¢–∞–±–ª–∏—Ü–∞
                        </button>
                    </div>

                    {loading ? (
                        <div className="space-y-4">
                            <LoadingBar text="–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π..." />
                            {[1,2,3].map(i => <Skeleton key={i} className="h-28 w-full" rounded="rounded-2xl" />)}
                        </div>
                    ) : tab === 'live' ? (
                        /* LIVE TAB */
                        liveMatch ? (
                            <div className="space-y-4">
                                {/* Live Score */}
                                <div className="glass rounded-2xl p-5 text-center">
                                    <div className="text-xs text-rm-gold mb-3">{liveMatch.tournament}</div>
                                    <div className="flex items-center justify-center gap-4 mb-3">
                                        <div className="flex-1 flex flex-col items-center gap-1.5">
                                            {liveMatch.home_logo && <img src={liveMatch.home_logo} className="w-10 h-10 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            <div className={`font-bold text-sm ${liveMatch.home_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>
                                                {liveMatch.home_team}
                                            </div>
                                        </div>
                                        <div className="bg-rm-dark px-5 py-2 rounded-xl">
                                            <span className="text-3xl font-black tabular-nums">{liveMatch.home_score}</span>
                                            <span className="text-gray-500 mx-2">:</span>
                                            <span className="text-3xl font-black tabular-nums">{liveMatch.away_score}</span>
                                        </div>
                                        <div className="flex-1 flex flex-col items-center gap-1.5">
                                            {liveMatch.away_logo && <img src={liveMatch.away_logo} className="w-10 h-10 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            <div className={`font-bold text-sm ${liveMatch.away_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>
                                                {liveMatch.away_team}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="inline-flex items-center gap-2 bg-red-500/20 text-red-400 px-3 py-1 rounded-full text-sm">
                                        <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                                        {liveMatch.minute}
                                    </div>
                                </div>

                                {/* –°–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞ */}
                                {liveMatch.incidents && liveMatch.incidents.length > 0 && (
                                    <div className="glass rounded-2xl p-4">
                                        <h3 className="font-bold mb-3">üìã –°–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞</h3>
                                        <div className="space-y-2 max-h-80 overflow-y-auto">
                                            {[...liveMatch.incidents].reverse().map((inc, i) => (
                                                <div key={i} className={`flex items-center gap-3 p-2 rounded-lg ${inc.home ? 'bg-rm-light/50' : 'bg-gray-800/50'}`}>
                                                    <div className="w-10 text-center text-gray-400 text-sm">{inc.minute}'</div>
                                                    <div className="text-xl">
                                                        {inc.type === 'goal' && '‚öΩ'}
                                                        {inc.type === 'yellow' && 'üü®'}
                                                        {inc.type === 'red' && 'üü•'}
                                                        {inc.type === 'sub' && 'üîÑ'}
                                                    </div>
                                                    <div className="flex-1">
                                                        {inc.type === 'goal' && (
                                                            <div>
                                                                <span className="font-bold">{inc.player}</span>
                                                                {inc.assist && <span className="text-gray-400 text-sm"> (–∞—Å—Å. {inc.assist})</span>}
                                                                <span className="text-gray-500 text-sm ml-2">{inc.score}</span>
                                                            </div>
                                                        )}
                                                        {(inc.type === 'yellow' || inc.type === 'red') && (
                                                            <span>{inc.player}</span>
                                                        )}
                                                        {inc.type === 'sub' && (
                                                            <div className="text-sm">
                                                                <span className="text-green-400">‚Üë {inc.player_in}</span>
                                                                <span className="text-gray-500 mx-1">/</span>
                                                                <span className="text-red-400">‚Üì {inc.player_out}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="text-xs text-gray-500">{inc.home ? '–î–æ–º–∞' : '–ì–æ—Å—Ç–∏'}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}


                                {/* –ù–∞ —ç—Ç–æ—Ç –º–∞—Ç—á –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å LIVE */}
                                <div className="glass rounded-2xl p-4">
                                    <div className="flex items-center justify-between">
                                        <span className="text-sm">–ù–∞ —ç—Ç–æ—Ç –º–∞—Ç—á –º–æ–∂–Ω–æ <b className="text-rm-gold">—Å—Ç–∞–≤–∏—Ç—å –≤ LIVE</b></span>
                                        <button
                                            onClick={() => { onNavigate && onNavigate('bets'); }}
                                            className="bg-gradient-to-r from-red-600 to-red-500 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:opacity-90 transition-all"
                                        >
                                            –°–¢–ê–í–¨ LIVE ‚ö°
                                        </button>
                                    </div>
                                </div>

                                {/* –°–¢–ê–¢–ò–°–¢–ò–ö–ê LIVE ‚Äî FotMob */}
                                {liveMatch.stats && liveMatch.stats.length > 0 && (() => {
                                    // Map FotMob stat titles to Russian
                                    const titleMap = {
                                        'Ball possession': '–í–ª–∞–¥–µ–Ω–∏–µ –º—è—á–æ–º',
                                        'Possession': '–í–ª–∞–¥–µ–Ω–∏–µ –º—è—á–æ–º',
                                        'Expected goals (xG)': 'xG (–æ–∂–∏–¥. –≥–æ–ª—ã)',
                                        'Total shots': '–£–¥–∞—Ä—ã –≤—Å–µ–≥–æ',
                                        'Shots on target': '–£–¥–∞—Ä—ã –≤ —Å—Ç–≤–æ—Ä',
                                        'Shots off target': '–£–¥–∞—Ä—ã –º–∏–º–æ',
                                        'Blocked shots': '–ó–∞–±–ª–æ–∫. —É–¥–∞—Ä—ã',
                                        'Corner kicks': '–£–≥–ª–æ–≤—ã–µ',
                                        'Corners': '–£–≥–ª–æ–≤—ã–µ',
                                        'Fouls': '–§–æ–ª—ã',
                                        'Offsides': '–û—Ñ—Å–∞–π–¥—ã',
                                        'Yellow cards': '–ñ—ë–ª—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏',
                                        'Red cards': '–ö—Ä–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏',
                                        'Passes': '–ü–µ—Ä–µ–¥–∞—á–∏',
                                        'Accurate passes': '–¢–æ—á–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—á–∏',
                                        'Free kicks': '–®—Ç—Ä–∞—Ñ–Ω—ã–µ',
                                        'Throw-ins': '–ê—É—Ç—ã',
                                        'Goal kicks': '–£–¥–∞—Ä—ã –æ—Ç –≤–æ—Ä–æ—Ç',
                                        'Big chances': '–ì–æ–ª–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã',
                                        'Big chances missed': '–£–ø—É—â. –º–æ–º–µ–Ω—Ç—ã',
                                        'Crosses': '–ö—Ä–æ—Å—Å—ã',
                                        'Tackles': '–û—Ç–±–æ—Ä—ã',
                                        'Interceptions': '–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã',
                                        'Saves': '–°–µ–π–≤—ã',
                                        'Duels won': '–í—ã–∏–≥—Ä. –µ–¥–∏–Ω–æ–±–æ—Ä—Å—Ç–≤–∞',
                                        'Aerial duels won': '–í–µ—Ä—Ö–æ–≤—ã–µ –µ–¥–∏–Ω–æ–±.',
                                    };
                                    // Priority stats to show first
                                    const priority = ['Ball possession', 'Possession', 'Expected goals (xG)', 'Total shots', 'Shots on target', 'Corner kicks', 'Corners', 'Fouls', 'Yellow cards', 'Big chances', 'Saves'];
                                    const allStats = liveMatch.stats;

                                    // Sort: priority first, then rest
                                    const sorted = [...allStats].sort((a, b) => {
                                        const ai = priority.findIndex(p => a.title?.includes(p));
                                        const bi = priority.findIndex(p => b.title?.includes(p));
                                        if (ai >= 0 && bi >= 0) return ai - bi;
                                        if (ai >= 0) return -1;
                                        if (bi >= 0) return 1;
                                        return 0;
                                    });

                                    // Show max 12 stats
                                    const displayed = sorted.slice(0, 12);

                                    return (
                                        <div className="glass rounded-2xl p-4">
                                            <div className="flex items-center gap-2 mb-4">
                                                <h3 className="font-bold">üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê</h3>
                                                <span className="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold">LIVE</span>
                                            </div>
                                            <div className="space-y-3">
                                                {displayed.map((stat, idx) => {
                                                    const label = titleMap[stat.title] || stat.title;
                                                    const hv = stat.home_num || 0;
                                                    const av = stat.away_num || 0;
                                                    const total = hv + av;
                                                    const homePct = total > 0 ? (hv / total * 100) : 50;
                                                    const awayPct = total > 0 ? (av / total * 100) : 50;
                                                    const isPossession = label.includes('–í–ª–∞–¥–µ–Ω–∏–µ');
                                                    const isXg = label.includes('xG');
                                                    return (
                                                        <div key={idx}>
                                                            <div className="flex items-center justify-between mb-1">
                                                                <span className={`font-bold w-12 text-left ${isXg ? 'text-rm-gold' : ''}`}>{stat.home}</span>
                                                                <span className="text-[11px] text-gray-400">{label}</span>
                                                                <span className={`font-bold w-12 text-right ${isXg ? 'text-rm-gold' : ''}`}>{stat.away}</span>
                                                            </div>
                                                            <div className="flex gap-0.5 h-1.5">
                                                                <div className="flex-1 flex justify-end">
                                                                    <div
                                                                        className={`h-full rounded-l-full transition-all duration-500 ${isPossession || isXg ? 'bg-blue-400' : 'bg-blue-500/60'}`}
                                                                        style={{width: `${homePct}%`, minWidth: total > 0 ? '2px' : '0'}}
                                                                    ></div>
                                                                </div>
                                                                <div className="flex-1">
                                                                    <div
                                                                        className={`h-full rounded-r-full transition-all duration-500 ${isPossession || isXg ? 'bg-red-400' : 'bg-red-500/60'}`}
                                                                        style={{width: `${awayPct}%`, minWidth: total > 0 ? '2px' : '0'}}
                                                                    ></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })()}

                                {/* Fallback: Leon stats if no FotMob stats */}
                                {(!liveMatch.stats || liveMatch.stats.length === 0) && liveMatch.leon_stats && (() => {
                                    const hs = liveMatch.leon_stats?.home || {};
                                    const as_ = liveMatch.leon_stats?.away || {};
                                    const stats = [
                                        { label: '–£–≥–ª–æ–≤—ã–µ', home: hs.corners || 0, away: as_.corners || 0 },
                                        { label: '–ñ—ë–ª—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏', home: hs.yellowCards || 0, away: as_.yellowCards || 0 },
                                    ];
                                    return (
                                        <div className="glass rounded-2xl p-4">
                                            <div className="flex items-center gap-2 mb-4">
                                                <h3 className="font-bold">–°–¢–ê–¢–ò–°–¢–ò–ö–ê</h3>
                                                <span className="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold">LIVE</span>
                                            </div>
                                            <div className="space-y-3">
                                                {stats.map((stat, idx) => {
                                                    const total = stat.home + stat.away;
                                                    const homePct = total > 0 ? (stat.home / total * 100) : 50;
                                                    return (
                                                        <div key={idx}>
                                                            <div className="flex items-center justify-between mb-1">
                                                                <span className="font-bold w-8 text-left">{stat.home}</span>
                                                                <span className="text-xs text-gray-400">{stat.label}</span>
                                                                <span className="font-bold w-8 text-right">{stat.away}</span>
                                                            </div>
                                                            <div className="flex gap-0.5 h-1.5">
                                                                <div className="flex-1 flex justify-end">
                                                                    <div className="h-full rounded-l-full bg-blue-500/60" style={{width: `${homePct}%`, minWidth: '2px'}}></div>
                                                                </div>
                                                                <div className="flex-1">
                                                                    <div className="h-full rounded-r-full bg-red-500/60" style={{width: `${100-homePct}%`, minWidth: '2px'}}></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })()}

                                {/* TOP STATS (replaces momentum) */}
                                {liveMatch.stats && liveMatch.stats.length > 0 && (() => {
                                    const topKeys = ['Ball possession', 'Possession', 'Expected goals (xG)', 'Total shots', 'Big chances', 'Shots on target'];
                                    const topStats = topKeys.map(k => liveMatch.stats.find(s => s.title === k)).filter(Boolean).slice(0, 4);
                                    if (!topStats.length) return null;
                                    return (
                                        <div className="glass rounded-2xl p-4">
                                            <h3 className="font-bold mb-3 text-sm text-center">Top stats</h3>
                                            <div className="space-y-3">
                                                {topStats.map((s, i) => {
                                                    const isPoss = s.title?.toLowerCase().includes('possession');
                                                    const hv = s.home_num || 0;
                                                    const av = s.away_num || 0;
                                                    const total = hv + av;
                                                    const homePct = total > 0 ? (hv / total * 100) : 50;
                                                    return (
                                                        <div key={i}>
                                                            <div className="text-center text-xs text-gray-400 mb-1">{s.title}</div>
                                                            {isPoss ? (
                                                                <div className="flex h-7 rounded-full overflow-hidden">
                                                                    <div className="bg-rm-gold flex items-center justify-start pl-2 text-xs font-bold text-black transition-all" style={{width: `${homePct}%`}}>{s.home}</div>
                                                                    <div className="bg-gray-600 flex items-center justify-end pr-2 text-xs font-bold text-white transition-all" style={{width: `${100-homePct}%`}}>{s.away}</div>
                                                                </div>
                                                            ) : (
                                                                <div className="flex items-center justify-between">
                                                                    <span className={`font-bold text-sm w-12 ${hv > av ? 'text-rm-gold' : ''}`}>{s.home}</span>
                                                                    <div className="flex-1 mx-3 flex gap-0.5 h-1">
                                                                        <div className="flex-1 flex justify-end"><div className="h-full rounded-l-full bg-rm-gold/40" style={{width: `${homePct}%`}}></div></div>
                                                                        <div className="flex-1"><div className="h-full rounded-r-full bg-gray-500/40" style={{width: `${100-homePct}%`}}></div></div>
                                                                    </div>
                                                                    <span className={`font-bold text-sm w-12 text-right ${av > hv ? 'text-rm-gold' : ''}`}>{s.away}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })()}

                                {/* SHOTMAP */}
                                {liveMatch.shotmap && liveMatch.shotmap.length > 0 && (() => {
                                    const homeShots = liveMatch.shotmap.filter(s => s.home);
                                    const awayShots = liveMatch.shotmap.filter(s => !s.home);
                                    const homeXG = homeShots.reduce((sum, s) => sum + (s.xG || 0), 0);
                                    const awayXG = awayShots.reduce((sum, s) => sum + (s.xG || 0), 0);
                                    const homeOnTarget = homeShots.filter(s => s.on_target).length;
                                    const awayOnTarget = awayShots.filter(s => s.on_target).length;
                                    const homeAvgX = homeShots.length > 0 ? homeShots.reduce((s, h) => s + (h.x||0), 0) / homeShots.length : 50;
                                    const needsMirror = homeAvgX > 50;

                                    return (
                                        <div className="glass rounded-2xl p-4">
                                            <h3 className="font-bold mb-3 text-sm">üéØ –ö–∞—Ä—Ç–∞ —É–¥–∞—Ä–æ–≤</h3>
                                            {/* Pitch mini */}
                                            <div className="relative bg-green-900/30 rounded-xl" style={{height: '140px'}}>
                                                <div className="absolute inset-0 border border-green-600/20 rounded-xl"></div>
                                                {/* Center line */}
                                                <div className="absolute left-1/2 top-0 bottom-0 w-px bg-green-600/20"></div>
                                                {/* Shots */}
                                                {liveMatch.shotmap.map((shot, i) => {
                                                    const x = needsMirror
                                                        ? (shot.home ? (100 - (shot.x || 0)) : (shot.x || 50))
                                                        : (shot.x || 50);
                                                    return (
                                                    <div
                                                        key={i}
                                                        className={`absolute w-2.5 h-2.5 rounded-full border ${
                                                            shot.result === 'Goal' ? 'bg-green-500 border-green-300' :
                                                            shot.on_target ? 'bg-yellow-500/70 border-yellow-300' :
                                                            shot.blocked ? 'bg-orange-500/50 border-orange-300' :
                                                            'bg-red-500/40 border-red-400/50'
                                                        }`}
                                                        style={{
                                                            left: `${Math.min(Math.max(x, 3), 97)}%`,
                                                            top: `${Math.min(Math.max(shot.y || 50, 5), 95)}%`,
                                                        }}
                                                        title={`${shot.player} ${shot.minute}' (xG: ${(shot.xG || 0).toFixed(2)})`}
                                                    ></div>
                                                    );
                                                })}
                                            </div>
                                            <div className="flex justify-between mt-3 text-xs">
                                                <div>
                                                    <div className="text-gray-400">{liveMatch.home_team}</div>
                                                    <div><span className="text-rm-gold font-bold">xG {homeXG.toFixed(2)}</span> ¬∑ {homeShots.length} —É–¥. ¬∑ {homeOnTarget} –≤ —Å—Ç–≤–æ—Ä</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-gray-400">{liveMatch.away_team}</div>
                                                    <div><span className="text-rm-gold font-bold">xG {awayXG.toFixed(2)}</span> ¬∑ {awayShots.length} —É–¥. ¬∑ {awayOnTarget} –≤ —Å—Ç–≤–æ—Ä</div>
                                                </div>
                                            </div>
                                            <div className="flex gap-3 mt-2 text-[10px] text-gray-500">
                                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span>–ì–æ–ª</span>
                                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-500/70"></span>–í —Å—Ç–≤–æ—Ä</span>
                                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-orange-500/50"></span>–ë–ª–æ–∫</span>
                                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500/40"></span>–ú–∏–º–æ</span>
                                            </div>
                                        </div>
                                    );
                                })()}

                                {/* –°–û–°–¢–ê–í–´ LIVE */}
                                {liveMatch.lineups && (liveMatch.lineups.home?.length > 0 || liveMatch.lineups.away?.length > 0) && (() => {
                                    return (
                                        <div className="glass rounded-2xl p-4">
                                            <h3 className="font-bold mb-3">üë• –°–æ—Å—Ç–∞–≤—ã</h3>
                                            {['home', 'away'].map(side => {
                                                const teamName = side === 'home' ? liveMatch.home_team : liveMatch.away_team;
                                                const players = liveMatch.lineups?.[side] || [];
                                                const isRM = teamName?.includes('Real Madrid');
                                                if (!players.length) return null;
                                                return (
                                                    <div key={side} className="mb-3 last:mb-0">
                                                        <div className={`text-xs font-bold mb-1.5 ${isRM ? 'text-rm-gold' : 'text-gray-400'}`}>{teamName}</div>
                                                        <div className="grid grid-cols-2 gap-x-3 gap-y-0.5">
                                                            {players.filter(p => !p.substitute).map((p, i) => (
                                                                <div key={i} className="flex items-center gap-1.5 py-0.5 text-xs">
                                                                    <span className="text-gray-500 w-4 text-center">{p.number}</span>
                                                                    <span className="flex-1 truncate">{p.name}{p.is_captain ? ' ¬©' : ''}</span>
                                                                    {p.rating && <span className={`text-[10px] font-bold px-1 rounded ${parseFloat(p.rating) >= 7 ? 'text-green-400' : 'text-gray-400'}`}>{p.rating}</span>}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })()}

                                {/* –ë–ª–æ–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ */}
                                <StreamBlock streams={streams?.length > 0 ? streams : [{name:'LiveBall',url:'https://liveball.website/',type:'iframe'}]} />
                            </div>
                        ) : (
                            <div className="text-center py-12">
                                <div className="text-7xl mb-6">üì∫</div>
                                <div className="text-xl font-bold text-white mb-2">–ù–µ—Ç live –º–∞—Ç—á–µ–π</div>
                                <div className="text-gray-500 text-sm mb-8">–°–ª–µ–¥—É—é—â–∏–π –º–∞—Ç—á —Å–∫–æ—Ä–æ –Ω–∞—á–Ω—ë—Ç—Å—è</div>

                                <div className="inline-block">
                                    <StreamBlock streams={streams?.length > 0 ? streams : [{name:'LiveBall',url:'https://liveball.website/',type:'iframe'}]} />
                                </div>
                            </div>
                        )
                    ) : tab === 'upcoming' ? (
                        <div className="space-y-3">
                            {matches?.length > 0 ? matches.map((m, i) => (
                                <div key={i} className="glass rounded-2xl p-4">
                                    <div className="flex justify-between text-xs mb-3">
                                        <span className="text-rm-gold font-medium px-2 py-0.5 bg-rm-gold/10 rounded-full">{m.competition}</span>
                                        <span className="text-gray-500 flex items-center gap-1"><Icons.Clock />{m.date}</span>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2 flex-1 min-w-0">
                                            {m.home_logo && <img src={m.home_logo} className="w-7 h-7 object-contain flex-shrink-0" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            <span className={`font-semibold truncate ${m.home_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{m.home_team}</span>
                                        </div>
                                        <div className="w-10 h-10 rounded-full bg-rm-light/50 flex items-center justify-center border border-white/10 mx-2 flex-shrink-0">
                                            <span className="text-gray-400 text-xs font-bold">VS</span>
                                        </div>
                                        <div className="flex items-center gap-2 flex-1 min-w-0 justify-end">
                                            <span className={`font-semibold truncate text-right ${m.away_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{m.away_team}</span>
                                            {m.away_logo && <img src={m.away_logo} className="w-7 h-7 object-contain flex-shrink-0" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                        </div>
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center py-12">
                                    <div className="text-5xl mb-4">üìÖ</div>
                                    <div className="text-gray-400">–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–∞—Ç—á–µ–π</div>
                                </div>
                            )}
                        </div>
                    ) : tab === 'results' ? (
                        <div className="space-y-3">
                            {results?.length > 0 ? results.map((r, i) => {
                                const isWin = r.result === 'win';
                                const isLoss = r.result === 'loss';
                                const borderColor = isWin ? 'border-l-green-500' : isLoss ? 'border-l-red-500' : 'border-l-gray-500';
                                const resultBg = isWin ? 'bg-green-500' : isLoss ? 'bg-red-500' : 'bg-gray-500';
                                const resultText = isWin ? '–í' : isLoss ? '–ü' : '–ù';

                                return (
                                    <div key={i}
                                        className={`glass rounded-2xl overflow-hidden border-l-4 ${borderColor} ${r.match_id ? 'cursor-pointer active:scale-[0.98] transition-all' : ''}`}
                                        onClick={() => r.match_id && setSelectedMatchId(r.match_id)}
                                    >
                                        {/* Competition + Date */}
                                        <div className="flex justify-between items-center px-4 pt-3 pb-1">
                                            <span className="text-[10px] text-rm-gold font-medium">{r.competition}</span>
                                            <span className="text-[10px] text-gray-500">{r.date}</span>
                                        </div>

                                        {/* Match Row */}
                                        <div className="flex items-center px-4 pb-3 gap-3">
                                            {/* Home */}
                                            <div className="flex items-center gap-2 flex-1 min-w-0">
                                                {r.home_logo && <img src={r.home_logo} className="w-7 h-7 object-contain flex-shrink-0" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                                <span className={`text-sm truncate ${(r.home_team || '').includes('Real Madrid') ? 'text-rm-gold font-bold' : 'font-medium'}`}>
                                                    {r.home_team || (r.is_home ? 'Real Madrid' : r.opponent)}
                                                </span>
                                            </div>

                                            {/* Score */}
                                            <div className="flex items-center gap-2 flex-shrink-0">
                                                <span className="text-lg font-bold tabular-nums">{r.home_score ?? '?'}</span>
                                                <span className="text-gray-600">-</span>
                                                <span className="text-lg font-bold tabular-nums">{r.away_score ?? '?'}</span>
                                            </div>

                                            {/* Away */}
                                            <div className="flex items-center gap-2 flex-1 min-w-0 justify-end">
                                                <span className={`text-sm truncate text-right ${(r.away_team || '').includes('Real Madrid') ? 'text-rm-gold font-bold' : 'font-medium'}`}>
                                                    {r.away_team || (!r.is_home ? 'Real Madrid' : r.opponent)}
                                                </span>
                                                {r.away_logo && <img src={r.away_logo} className="w-7 h-7 object-contain flex-shrink-0" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            </div>

                                            {/* Result badge + arrow */}
                                            <div className="flex items-center gap-1.5 flex-shrink-0">
                                                <span className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold text-white ${resultBg}`}>{resultText}</span>
                                                {r.match_id && <span className="text-gray-600">‚Ä∫</span>}
                                            </div>
                                        </div>
                                    </div>
                                );
                            }) : (
                                <div className="text-center py-12">
                                    <div className="text-5xl mb-4">üìä</div>
                                    <div className="text-gray-400">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>
                                </div>
                            )}
                        </div>
                    ) : tab === 'standings' ? (
                        <div className="glass rounded-2xl overflow-hidden">
                            {/* Table Header */}
                            <div className="grid grid-cols-12 gap-1 text-xs text-gray-500 p-3 border-b border-rm-light bg-rm-light/30">
                                <div className="col-span-1">#</div>
                                <div className="col-span-5">–ö–æ–º–∞–Ω–¥–∞</div>
                                <div className="col-span-1 text-center">–ò</div>
                                <div className="col-span-1 text-center">–í</div>
                                <div className="col-span-1 text-center">–ù</div>
                                <div className="col-span-1 text-center">–ü</div>
                                <div className="col-span-2 text-center">–û</div>
                            </div>
                            {/* Table Body */}
                            <div className="divide-y divide-rm-light/50">
                                {standings?.length > 0 ? standings.map((row, i) => (
                                    <div
                                        key={i}
                                        className={`grid grid-cols-12 gap-1 text-sm p-3 items-center ${row.isRealMadrid ? 'bg-rm-gold/10' : ''}`}
                                    >
                                        <div className={`col-span-1 font-bold ${i < 4 ? 'text-green-400' : i >= standings.length - 3 ? 'text-red-400' : ''}`}>
                                            {row.position}
                                        </div>
                                        <div className={`col-span-5 flex items-center gap-1.5 min-w-0 ${row.isRealMadrid ? 'text-rm-gold font-bold' : ''}`}>
                                            {row.logo && <img src={row.logo} className="w-5 h-5 object-contain flex-shrink-0" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            <span className="truncate">{row.team}</span>
                                        </div>
                                        <div className="col-span-1 text-center text-gray-400">{row.played}</div>
                                        <div className="col-span-1 text-center text-green-400">{row.won}</div>
                                        <div className="col-span-1 text-center text-gray-400">{row.drawn}</div>
                                        <div className="col-span-1 text-center text-red-400">{row.lost}</div>
                                        <div className={`col-span-2 text-center font-bold ${row.isRealMadrid ? 'text-rm-gold' : ''}`}>
                                            {row.points}
                                        </div>
                                    </div>
                                )) : (
                                    <div className="text-center py-12">
                                        <div className="text-5xl mb-4">üèÜ</div>
                                        <div className="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã...</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : null}
                </div>
            );
        };

        // ==================== PREDICTIONS CONTENT (–¥–ª—è –≤–ª–æ–∂–µ–Ω–∏—è –≤ BetsPage) ====================
        const PredictionsContent = ({ match, predictions, onPredict }) => {
            const predictionOptions = [
                { key: 'home', label: '–ü–æ–±–µ–¥–∞ —Ö–æ–∑—è–µ–≤', icon: 'üè†', color: 'from-green-500/20 to-green-600/20 border-green-500/30' },
                { key: 'draw', label: '–ù–∏—á—å—è', icon: 'ü§ù', color: 'from-yellow-500/20 to-yellow-600/20 border-yellow-500/30' },
                { key: 'away', label: '–ü–æ–±–µ–¥–∞ –≥–æ—Å—Ç–µ–π', icon: '‚úàÔ∏è', color: 'from-blue-500/20 to-blue-600/20 border-blue-500/30' }
            ];

            const existingPrediction = useMemo(() => {
                if (!predictions || !match) return null;
                return predictions.find(p => String(p.match_id) === String(match.id) && p.status === 'pending');
            }, [predictions, match]);

            const handlePredict = async (type) => {
                if (existingPrediction) return;
                try {
                    await api.post('/api/prediction/make', { match_id: match.id, prediction: type });
                    tg?.HapticFeedback?.notificationOccurred?.('success');
                    tg?.showAlert?.('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏–Ω—è—Ç! üéØ');
                    onPredict?.();
                } catch (err) {
                    tg?.showAlert?.(err.message);
                }
            };

            return match ? (
                <div className="space-y-4">
                    <div className="glass rounded-2xl p-5">
                        <div className="text-center mb-1">
                            <div className="text-rm-gold text-xs mb-3">{match.competition}</div>
                        </div>
                        <div className="flex items-center justify-between mb-2">
                            <div className="flex-1 flex flex-col items-center gap-1">
                                {match.home_logo && <img src={match.home_logo} className="w-8 h-8 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                <span className={`text-sm font-bold text-center ${match.home_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{match.home_team}</span>
                            </div>
                            <div className="text-gray-400 text-xs font-bold px-3">VS</div>
                            <div className="flex-1 flex flex-col items-center gap-1">
                                {match.away_logo && <img src={match.away_logo} className="w-8 h-8 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                <span className={`text-sm font-bold text-center ${match.away_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{match.away_team}</span>
                            </div>
                        </div>
                        <div className="text-gray-400 text-sm text-center mb-4">{match.date}</div>

                        {existingPrediction ? (
                            <div className="bg-rm-gold/10 border border-rm-gold/30 rounded-xl p-4 text-center">
                                <div className="text-rm-gold text-lg mb-1">‚úÖ –ü—Ä–æ–≥–Ω–æ–∑ —Å–¥–µ–ª–∞–Ω</div>
                                <div className="text-gray-400">
                                    –¢—ã –≤—ã–±—Ä–∞–ª: <span className="font-bold text-white">
                                        {existingPrediction.prediction === 'home' ? '–ü–æ–±–µ–¥–∞ —Ö–æ–∑—è–µ–≤' :
                                         existingPrediction.prediction === 'draw' ? '–ù–∏—á—å—è' : '–ü–æ–±–µ–¥–∞ –≥–æ—Å—Ç–µ–π'}
                                    </span>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                <p className="text-center text-gray-400 text-sm mb-3">–í—ã–±–µ—Ä–∏ –∏—Å—Ö–æ–¥:</p>
                                {predictionOptions.map(opt => (
                                    <button
                                        key={opt.key}
                                        onClick={() => handlePredict(opt.key)}
                                        className={`w-full bg-gradient-to-r ${opt.color} border rounded-xl p-4 flex items-center gap-4 hover:scale-[1.02] transition-all`}
                                    >
                                        <span className="text-2xl">{opt.icon}</span>
                                        <span className="font-semibold">{opt.label}</span>
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ */}
                    {predictions?.length > 0 && (
                        <div className="glass rounded-2xl p-5">
                            <h3 className="font-bold mb-4">üìä –ò—Å—Ç–æ—Ä–∏—è</h3>
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                                {predictions.slice(0, 10).map((p, i) => {
                                    const isCorrect = p.status === 'correct' || p.status === 'won';
                                    const isIncorrect = p.status === 'incorrect' || p.status === 'lost';
                                    const statusIcon = isCorrect ? '‚úÖ' : isIncorrect ? '‚ùå' : '‚è≥';
                                    const predText = p.prediction === 'home' ? '–ü1' : p.prediction === 'draw' ? 'X' : '–ü2';

                                    return (
                                        <div key={i} className="flex justify-between items-center p-3 bg-rm-light rounded-xl">
                                            <div className="text-sm">
                                                <span className="text-gray-400">{p.home_team} - {p.away_team}</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-rm-gold font-bold">{predText}</span>
                                                <span>{statusIcon}</span>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            ) : (
                <div className="glass rounded-2xl p-8 text-center">
                    <div className="text-5xl mb-4">‚öΩ</div>
                    <div className="text-gray-400">–ù–µ—Ç –º–∞—Ç—á–µ–π –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞</div>
                </div>
            );
        };

        // ==================== BETS PAGE ====================
        const BetsPage = ({ bets, predictions, match, loading, onSellBet, onPlaceBet, streams }) => {
            const [tab, setTab] = useState('place');
            const [sellLoading, setSellLoading] = useState(null);
            const [betLoading, setBetLoading] = useState(false);
            const [selectedBet, setSelectedBet] = useState(null);
            const [betAmount, setBetAmount] = useState('');
            const [marketFilter, setMarketFilter] = useState('all');
            const [prevOdds, setPrevOdds] = useState({});
            const [lastUpdate, setLastUpdate] = useState(null);

            const MARKET_FILTER_MAP = {
                outcome: ['match_result', 'double_chance', 'dnb'],
                total: ['total_goals', 'home_total', 'away_total'],
                handicap: ['handicap'],
                score: ['correct_score'],
                corners: ['total_corners', 'corners_home', 'corners_away'],
                cards: ['total_cards', 'cards_home', 'cards_away'],
                combo: ['btts', 'odd_even', 'first_goal', 'penalty'],
            };

            // Track odds changes
            useEffect(() => {
                if (!match?.bet_markets) return;
                const newOdds = {};
                // Main odds
                if (match.odds) {
                    ['home', 'draw', 'away'].forEach(k => { if (match.odds[k]) newOdds[k] = match.odds[k]; });
                }
                // All market odds
                match.bet_markets.forEach(m => {
                    m.bets?.forEach(b => { if (b.odds) newOdds[b.key] = b.odds; });
                });

                setPrevOdds(prev => {
                    // Only update if we had previous values
                    if (Object.keys(prev).length > 0) {
                        const merged = {};
                        Object.keys(newOdds).forEach(k => {
                            merged[k] = prev[k] || newOdds[k]; // keep old value for comparison
                        });
                        return merged;
                    }
                    return newOdds;
                });
                setLastUpdate(new Date());
            }, [match?.bet_markets, match?.odds]);

            // Helper: get odds direction arrow
            const getOddsArrow = (key, currentOdds) => {
                const prev = prevOdds[key];
                if (!prev || prev === currentOdds) return null;
                if (currentOdds > prev) return { dir: 'up', color: 'text-green-400' };
                return { dir: 'down', color: 'text-red-400' };
            };

            const pendingBets = useMemo(() => bets?.filter(b => b.status === 'pending') || [], [bets]);
            const settledBets = useMemo(() => bets?.filter(b => ['won', 'lost', 'sold', 'returned'].includes(b.status)) || [], [bets]);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–ª–∫–∏ - —Å—Ç–∞–≤–∫–∏ –ò –ø—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ —ç—Ç–æ—Ç –º–∞—Ç—á
            const existingBetTypes = useMemo(() => {
                if (!match?.id) return [];
                const betTypes = pendingBets
                    .filter(b => b.match_id == match.id)
                    .map(b => b.bet_type);
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≥–Ω–æ–∑—ã
                const predTypes = (predictions || [])
                    .filter(p => p.match_id == match.id && p.status === 'pending')
                    .map(p => p.prediction);
                return [...betTypes, ...predTypes];
            }, [pendingBets, predictions, match]);

            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¢–û–õ–¨–ö–û –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ (–∑–∞—â–∏—Ç–∞ –æ—Ç –≤–∏–ª–∫–∏)
            const isBlocked = (betType) => {
                // –ü1/X/–ü2 - –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–µ
                const hasHome = existingBetTypes.includes('home');
                const hasDraw = existingBetTypes.includes('draw');
                const hasAway = existingBetTypes.includes('away');

                if (hasHome && ['draw', 'away'].includes(betType)) return true;
                if (hasDraw && ['home', 'away'].includes(betType)) return true;
                if (hasAway && ['home', 'draw'].includes(betType)) return true;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å—Ç–∞–≤–∫–∞–º–∏ –Ω–∞ —Ç–æ—á–Ω—ã–π —Å—á—ë—Ç
                for (const bt of existingBetTypes) {
                    if (bt.startsWith('score_')) {
                        const [eH, eA] = bt.replace('score_', '').split('-').map(Number);
                        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å—Ç–∞–≤–∫–∞ –Ω–∞ —Å—á—ë—Ç —Å –ø–æ–±–µ–¥–æ–π —Ö–æ–∑—è–µ–≤
                        if (eH > eA && ['draw', 'away'].includes(betType)) return true;
                        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å—Ç–∞–≤–∫–∞ –Ω–∞ —Å—á—ë—Ç —Å –Ω–∏—á—å–µ–π
                        if (eH === eA && ['home', 'away'].includes(betType)) return true;
                        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å—Ç–∞–≤–∫–∞ –Ω–∞ —Å—á—ë—Ç —Å –ø–æ–±–µ–¥–æ–π –≥–æ—Å—Ç–µ–π
                        if (eA > eH && ['home', 'draw'].includes(betType)) return true;
                    }
                }

                // BTTS - –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π
                if (existingBetTypes.includes('btts_yes') && betType === 'btts_no') return true;
                if (existingBetTypes.includes('btts_no') && betType === 'btts_yes') return true;

                // –¢–æ—á–Ω—ã–π —Å—á—ë—Ç ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –∏—Å—Ö–æ–¥–æ–º
                if (betType.startsWith('score_')) {
                    const [sH, sA] = betType.replace('score_', '').split('-').map(Number);
                    if (hasHome && sH <= sA) return true;
                    if (hasDraw && sH !== sA) return true;
                    if (hasAway && sA <= sH) return true;
                    for (const bt of existingBetTypes) {
                        if (bt.startsWith('score_') && bt !== betType) {
                            const [eH, eA] = bt.replace('score_', '').split('-').map(Number);
                            if ((eH > eA) !== (sH > sA) || (eH === eA) !== (sH === sA)) return true;
                        }
                    }
                }

                return false;
            };

            // –°–∫–æ–ª—å–∫–æ —É–∂–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ —ç—Ç–æ—Ç —Ç–∏–ø
            const getBetTotal = (betType) => {
                return pendingBets
                    .filter(b => b.match_id == match?.id && b.bet_type === betType)
                    .reduce((sum, b) => sum + (b.amount || 0), 0);
            };

            const formatBetType = (bt) => {
                if (bt?.startsWith('score_')) return `üéØ ${bt.replace('score_', '').replace('-', ':')}`;
                if (bt?.startsWith('total_over_')) return '–¢–ë ' + bt.replace('total_over_', '');
                if (bt?.startsWith('total_under_')) return '–¢–ú ' + bt.replace('total_under_', '');
                if (bt?.startsWith('corners_over_')) return '–£–ë ' + bt.replace('corners_over_', '');
                if (bt?.startsWith('corners_under_')) return '–£–ú ' + bt.replace('corners_under_', '');
                if (bt === 'btts_yes') return '–û–±–µ –∑–∞–±—å—é—Ç: –î–∞';
                if (bt === 'btts_no') return '–û–±–µ –∑–∞–±—å—é—Ç: –ù–µ—Ç';
                return { home: '–ü1', draw: 'X', away: '–ü2' }[bt] || bt;
            };

            const getStatusBadge = (status) => {
                const badges = {
                    pending: { class: 'badge-pending', icon: '‚è≥', text: '–û–∂–∏–¥–∞–Ω–∏–µ' },
                    won: { class: 'badge-won', icon: '‚úÖ', text: '–í—ã–∏–≥—Ä—ã—à' },
                    lost: { class: 'badge-lost', icon: '‚ùå', text: '–ü—Ä–æ–∏–≥—Ä—ã—à' },
                    sold: { class: 'badge-sold', icon: 'üí∏', text: '–ü—Ä–æ–¥–∞–Ω–æ' },
                    returned: { class: 'badge-pending', icon: '‚Ü©Ô∏è', text: '–í–æ–∑–≤—Ä–∞—Ç' }
                };
                return badges[status] || badges.pending;
            };

            const handleSellBet = async (betId, amount) => {
                const sellPrice = Math.floor(amount / 2);
                if (!confirm(`–ü—Ä–æ–¥–∞—Ç—å —Å—Ç–∞–≤–∫—É –∑–∞ ${sellPrice} –æ—á–∫–æ–≤ (50%)?`)) return;

                setSellLoading(betId);
                try {
                    await api.post('/api/bet/sell', { bet_id: betId });
                    tg?.showAlert?.(`–°—Ç–∞–≤–∫–∞ –ø—Ä–æ–¥–∞–Ω–∞ –∑–∞ ${sellPrice} –æ—á–∫–æ–≤!`);
                    onSellBet?.();
                } catch (err) {
                    tg?.showAlert?.(err.message);
                } finally {
                    setSellLoading(null);
                }
            };

            const placeBet = async (betType, odds) => {
                if (!betAmount || parseInt(betAmount) <= 0) {
                    tg?.showAlert?.('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏');
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–ª–∫–∏ –ø–µ—Ä–µ–¥ —Å—Ç–∞–≤–∫–æ–π
                if (isBlocked(betType)) {
                    tg?.showAlert?.('üîí –ù–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π –∏—Å—Ö–æ–¥ (–≤–∏–ª–∫–∞)');
                    return;
                }

                setBetLoading(true);
                try {
                    await api.post('/api/bet/place', {
                        match_id: match.id,
                        bet_type: betType,
                        amount: parseInt(betAmount)
                    });
                    tg?.showAlert?.('‚úÖ –°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!');
                    setBetAmount('');
                    setSelectedBet(null);
                    onPlaceBet?.();
                } catch (err) {
                    tg?.showAlert?.(err.message);
                } finally {
                    setBetLoading(false);
                }
            };

                        return (
                <div className="p-4 pb-28 animate-fade">
                    <h1 className="text-2xl font-bold mb-5">üé∞ –°—Ç–∞–≤–∫–∏</h1>

                    {/* Tabs */}
                    <div className="flex gap-4 mb-6 border-b border-rm-light pb-1 overflow-x-auto hide-scrollbar">
                        <button
                            onClick={() => setTab('place')}
                            className={`pb-3 text-sm font-semibold whitespace-nowrap ${tab === 'place' ? 'tab-active text-white' : 'text-gray-500'}`}
                        >
                            üéØ –°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É
                        </button>
                        <button
                            onClick={() => setTab('predictions')}
                            className={`pb-3 text-sm font-semibold whitespace-nowrap ${tab === 'predictions' ? 'tab-active text-white' : 'text-gray-500'}`}
                        >
                            üîÆ –ü—Ä–æ–≥–Ω–æ–∑—ã
                        </button>
                        <button
                            onClick={() => setTab('pending')}
                            className={`pb-3 text-sm font-semibold whitespace-nowrap ${tab === 'pending' ? 'tab-active text-white' : 'text-gray-500'}`}
                        >
                            ‚è≥ –ê–∫—Ç–∏–≤–Ω—ã–µ ({pendingBets.length})
                        </button>
                        <button
                            onClick={() => setTab('settled')}
                            className={`pb-3 text-sm font-semibold whitespace-nowrap ${tab === 'settled' ? 'tab-active text-white' : 'text-gray-500'}`}
                        >
                            ‚úÖ –ò—Å—Ç–æ—Ä–∏—è ({settledBets.length})
                        </button>
                    </div>

                    {loading ? (
                        <div className="space-y-4">
                            <LoadingBar text="–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–≤–æ–∫..." />
                            {[1,2,3].map(i => <Skeleton key={i} className="h-28 w-full" rounded="rounded-2xl" />)}
                        </div>
                    ) : tab === 'place' ? (
                        /* PLACE BET TAB */
                        match ? (
                            <div className="space-y-4">
                                {/* Match Info */}
                                <div className="glass rounded-2xl p-5">
                                    <div className="text-xs text-rm-gold mb-3 text-center">{match.competition}</div>
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex-1 flex flex-col items-center gap-1">
                                            {match.home_logo && <img src={match.home_logo} className="w-8 h-8 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            <span className={`text-sm font-bold text-center ${match.home_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{match.home_team}</span>
                                        </div>
                                        <div className="px-3">
                                            {match.score ? (
                                                <div className="text-2xl font-black tabular-nums">{match.score}</div>
                                            ) : (
                                                <div className="text-gray-400 text-xs font-bold">VS</div>
                                            )}
                                        </div>
                                        <div className="flex-1 flex flex-col items-center gap-1">
                                            {match.away_logo && <img src={match.away_logo} className="w-8 h-8 object-contain" loading="lazy" onError={(e) => e.target.style.display='none'} />}
                                            <span className={`text-sm font-bold text-center ${match.away_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>{match.away_team}</span>
                                        </div>
                                    </div>
                                    {match.is_live ? (
                                        <div className="flex items-center justify-center gap-3">
                                            <div className="inline-flex items-center gap-2 bg-red-500/20 text-red-400 px-3 py-1 rounded-full text-sm">
                                                <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                                                {match.minute || 'LIVE'}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-gray-400 text-sm text-center">{match.date}</div>
                                    )}
                                    {lastUpdate && (
                                        <div className="text-[10px] text-gray-600 mt-2 text-center">
                                            üîÑ –ö—ç—Ñ—ã ¬∑ –æ–±–Ω–æ–≤–ª–µ–Ω–æ {lastUpdate.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}
                                        </div>
                                    )}
                                </div>

                                {match.bets_suspended ? (
                                    <div className="glass rounded-2xl p-6 text-center">
                                        <div className="text-4xl mb-3">‚è∏Ô∏è</div>
                                        <div className="font-bold text-orange-400 mb-1">–°—Ç–∞–≤–∫–∏ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</div>
                                        <div className="text-xs text-gray-500">–ò–¥—ë—Ç –ø–µ—Ä–µ—Å—á—ë—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤</div>
                                    </div>
                                ) : (
                                <>
                                {/* Market Filter Pills */}
                                <div style={{position:'sticky',top:0,zIndex:10,background:'linear-gradient(180deg, #0A0A0C 80%, transparent)',paddingTop:8,paddingBottom:12}}>
                                    <div className="flex gap-2 overflow-x-auto hide-scrollbar" style={{WebkitOverflowScrolling:'touch'}}>
                                        {[
                                            {key:'all',label:'–í—Å–µ'},
                                            {key:'outcome',label:'–ò—Å—Ö–æ–¥'},
                                            {key:'total',label:'–¢–æ—Ç–∞–ª'},
                                            {key:'handicap',label:'–§–æ—Ä–∞'},
                                            {key:'score',label:'–°—á—ë—Ç'},
                                            {key:'corners',label:'–£–≥–ª–æ–≤—ã–µ'},
                                            {key:'cards',label:'–ö–∞—Ä—Ç–æ—á–∫–∏'},
                                            {key:'combo',label:'–ö–æ–º–±–æ'},
                                        ].map(f => (
                                            <button
                                                key={f.key}
                                                onClick={() => { setMarketFilter(f.key); setSelectedBet(null); }}
                                                className="whitespace-nowrap shrink-0"
                                                style={{
                                                    padding:'8px 16px',
                                                    borderRadius:20,
                                                    fontSize:13,
                                                    fontWeight:500,
                                                    background: marketFilter === f.key ? '#d4a017' : '#2a2a3e',
                                                    color: marketFilter === f.key ? '#fff' : '#9ca3af',
                                                    border:'none',
                                                    cursor:'pointer',
                                                    transition:'all 0.2s',
                                                }}
                                            >
                                                {f.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Main Odds - –ü1 X –ü2 */}
                                {(marketFilter === 'all' || marketFilter === 'outcome') && (
                                <div className="glass rounded-2xl p-5">
                                    <h3 className="font-bold mb-4">‚öΩ –ò—Å—Ö–æ–¥ –º–∞—Ç—á–∞</h3>
                                    <div className="grid grid-cols-3 gap-3 mb-4">
                                        {[
                                            { type: 'home', label: '–ü1', odds: match.odds?.home || 0 },
                                            { type: 'draw', label: 'X', odds: match.odds?.draw || 0 },
                                            { type: 'away', label: '–ü2', odds: match.odds?.away || 0 }
                                        ].map(bet => {
                                            const blocked = isBlocked(bet.type);
                                            const active = selectedBet === bet.type;
                                            const totalBet = getBetTotal(bet.type);
                                            const noOdds = !bet.odds || bet.odds <= 1;

                                            return (
                                                <button
                                                    key={bet.type}
                                                    onClick={() => !blocked && !noOdds && setSelectedBet(active ? null : bet.type)}
                                                    disabled={blocked || noOdds}
                                                    className={`p-4 rounded-xl text-center transition-all ${
                                                        noOdds ? 'bg-rm-light/50 opacity-60 cursor-not-allowed' :
                                                        blocked ? 'bg-red-500/10 opacity-50 cursor-not-allowed' :
                                                        active ? 'bg-rm-gold/20 border-2 border-rm-gold' :
                                                        totalBet > 0 ? 'bg-green-500/10 border border-green-500/30' :
                                                        'bg-rm-light hover:bg-rm-gray'
                                                    }`}
                                                >
                                                    <div className="text-lg font-bold">{bet.label}</div>
                                                    <div className={`text-sm flex items-center justify-center gap-1 ${active ? 'text-rm-gold' : 'text-gray-400'}`}>
                                                        {noOdds ? '‚Äî' : bet.odds}
                                                        {(() => { const a = getOddsArrow(bet.type, bet.odds); return a ? <span className={a.color}>{a.dir === 'up' ? '‚ñ≤' : '‚ñº'}</span> : null; })()}
                                                    </div>
                                                    {totalBet > 0 && <div className="text-xs text-green-400 mt-1">+{totalBet}</div>}
                                                    {blocked && <div className="text-xs text-red-400 mt-1">üîí</div>}
                                                </button>
                                            );
                                        })}
                                    </div>

                                    {/* Amount Input */}
                                    {selectedBet && ['home', 'draw', 'away'].includes(selectedBet) && (
                                        <div className="space-y-3 pt-3 border-t border-rm-light">
                                            <input
                                                type="number"
                                                placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏"
                                                value={betAmount}
                                                onChange={e => setBetAmount(e.target.value)}
                                                className="w-full bg-rm-light border border-rm-gray rounded-xl px-4 py-3 focus:border-rm-gold outline-none"
                                            />
                                            <div className="flex gap-2">
                                                {[50, 100, 200, 500].map(n => (
                                                    <button
                                                        key={n}
                                                        onClick={() => setBetAmount(n.toString())}
                                                        className="flex-1 bg-rm-light py-2 rounded-lg text-sm hover:bg-rm-gray"
                                                    >
                                                        {n}
                                                    </button>
                                                ))}
                                            </div>
                                            {betAmount && (
                                                <div className="text-center text-sm">
                                                    –í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: <span className="text-rm-gold font-bold">
                                                        {Math.floor(parseInt(betAmount) * (match.odds?.[selectedBet] || 2))}
                                                    </span>
                                                </div>
                                            )}
                                            <button
                                                onClick={() => placeBet(selectedBet, match.odds?.[selectedBet])}
                                                disabled={betLoading}
                                                className="w-full btn-gold py-3 rounded-xl font-bold disabled:opacity-50"
                                            >
                                                {betLoading ? '...' : '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É'}
                                            </button>
                                        </div>
                                    )}
                                </div>
                                )}

                                {/* Dynamic bet markets from API */}
                                {match?.bet_markets?.filter(m => {
                                    if (m.type === 'match_result') return false;
                                    if (match?.is_live && m.type === 'correct_score') return false;
                                    if (marketFilter === 'all') return true;
                                    return (MARKET_FILTER_MAP[marketFilter] || []).includes(m.type);
                                }).map((market, mi) => (
                                    <div key={mi} className="glass rounded-2xl p-5">
                                        <h3 className="font-bold mb-4">{market.category}</h3>
                                        <div className={`grid ${market.bets?.length === 3 || market.type === 'correct_score' ? 'grid-cols-3' : 'grid-cols-2'} gap-3`}>
                                            {market.bets?.map(bet => {
                                                const active = selectedBet === bet.key;
                                                const totalBet = getBetTotal(bet.key);
                                                const blocked = isBlocked(bet.key);
                                                return (
                                                    <button
                                                        key={bet.key}
                                                        onClick={() => !blocked && setSelectedBet(active ? null : bet.key)}
                                                        disabled={blocked}
                                                        className={`p-3 rounded-xl text-center transition-all ${
                                                            blocked ? 'bg-red-500/10 opacity-50 cursor-not-allowed' :
                                                            active ? 'bg-rm-gold/20 border-2 border-rm-gold' :
                                                            totalBet > 0 ? 'bg-green-500/10 border border-green-500/30' :
                                                            'bg-rm-light hover:bg-rm-gray'
                                                        }`}
                                                    >
                                                        <div className="font-bold">{bet.name}</div>
                                                        <div className={`text-sm flex items-center justify-center gap-1 ${active ? 'text-rm-gold' : 'text-gray-400'}`}>
                                                            {bet.odds}
                                                            {(() => { const a = getOddsArrow(bet.key, bet.odds); return a ? <span className={a.color}>{a.dir === 'up' ? '‚ñ≤' : '‚ñº'}</span> : null; })()}
                                                        </div>
                                                        {totalBet > 0 && <div className="text-xs text-green-400 mt-1">+{totalBet}</div>}
                                                        {blocked && <div className="text-xs text-red-400 mt-1">üîí</div>}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                        {market.bets?.some(b => selectedBet === b.key) && (
                                            <div className="space-y-3 pt-4 mt-4 border-t border-rm-light">
                                                <input type="number" placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏" value={betAmount} onChange={e => setBetAmount(e.target.value)} className="w-full bg-rm-light border border-rm-gray rounded-xl px-4 py-3 focus:border-rm-gold outline-none" />
                                                <div className="flex gap-2">{[50, 100, 200, 500].map(n => (<button key={n} onClick={() => setBetAmount(n.toString())} className="flex-1 bg-rm-light py-2 rounded-lg text-sm hover:bg-rm-gray">{n}</button>))}</div>
                                                {betAmount && (<div className="text-center text-sm">–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: <span className="text-rm-gold font-bold">{Math.floor(parseInt(betAmount) * (market.bets.find(b => b.key === selectedBet)?.odds || 2))}</span></div>)}
                                                <button onClick={() => placeBet(selectedBet, market.bets.find(b => b.key === selectedBet)?.odds)} disabled={betLoading} className="w-full btn-gold py-3 rounded-xl font-bold disabled:opacity-50">{betLoading ? '...' : '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É'}</button>
                                            </div>
                                        )}
                                    </div>
                                ))}


                                {/* Info */}
                                <div className="text-center text-gray-500 text-xs">
                                    üîí –ù–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–µ –∏—Å—Ö–æ–¥—ã (–∑–∞—â–∏—Ç–∞ –æ—Ç –≤–∏–ª–∫–∏)
                                </div>
                                </>
                                )}
                            </div>
                        ) : (
                            <div className="text-center py-12">
                                <div className="text-6xl mb-4">‚è±Ô∏è</div>
                                <div className="text-xl font-bold text-white mb-2">–°—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã</div>
                                <div className="text-gray-400 mb-6">–ú–∞—Ç—á —Å–∫–æ—Ä–æ –Ω–∞—á–Ω—ë—Ç—Å—è –∏–ª–∏ —É–∂–µ –∏–¥—ë—Ç</div>
                                <StreamBlock streams={streams?.length > 0 ? streams : [{name:'LiveBall',url:'https://liveball.website/',type:'iframe'}]} compact />
                            </div>
                        )
                    ) : tab === 'predictions' ? (
                        /* PREDICTIONS TAB */
                        <PredictionsContent match={match} predictions={predictions} onPredict={onPlaceBet} />
                    ) : tab === 'pending' ? (
                        /* PENDING BETS TAB */
                        pendingBets.length > 0 ? (
                            <div className="space-y-4">
                                {pendingBets.map(bet => {
                                    const badge = getStatusBadge(bet.status);
                                    const sellPrice = Math.floor(bet.amount / 2);
                                    return (
                                        <div key={bet.bet_id} className="glass rounded-2xl p-5">
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <div className="font-semibold mb-1">{bet.home_team} vs {bet.away_team}</div>
                                                    <div className="text-xs text-gray-500">{bet.match_date}</div>
                                                </div>
                                                <span className={`text-xs px-3 py-1.5 rounded-full ${badge.class}`}>
                                                    {badge.icon} {badge.text}
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-center bg-rm-light/50 rounded-xl p-3 mb-3">
                                                <div>
                                                    <span className="text-gray-400 text-sm">{formatBetType(bet.bet_type)}</span>
                                                    <span className="mx-2 text-gray-600">‚Ä¢</span>
                                                    <span className="text-sm">{bet.amount} √ó {bet.odds}</span>
                                                </div>
                                                <div className="text-rm-gold font-bold text-lg">‚Üí {bet.potential_win}</div>
                                            </div>
                                            <button
                                                onClick={() => handleSellBet(bet.bet_id, bet.amount)}
                                                disabled={sellLoading === bet.bet_id}
                                                className="w-full bg-orange-500/20 border border-orange-500/30 text-orange-400 py-2 rounded-xl text-sm font-semibold hover:bg-orange-500/30 transition disabled:opacity-50"
                                            >
                                                {sellLoading === bet.bet_id ? '...' : `üí∏ –ü—Ä–æ–¥–∞—Ç—å –∑–∞ ${sellPrice} (50%)`}
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="text-center py-16">
                                <div className="text-6xl mb-4">üé∞</div>
                                <div className="text-gray-400 mb-2">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫</div>
                                <button onClick={() => setTab('place')} className="text-rm-gold text-sm">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É ‚Üí</button>
                            </div>
                        )
                    ) : tab === 'settled' ? (
                        /* SETTLED BETS TAB */
                        settledBets.length > 0 ? (
                            <div className="space-y-4">
                                {settledBets.map(bet => {
                                    const badge = getStatusBadge(bet.status);
                                    return (
                                        <div key={bet.bet_id} className="glass rounded-2xl p-5">
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <div className="font-semibold mb-1">{bet.home_team} vs {bet.away_team}</div>
                                                    <div className="text-xs text-gray-500">{bet.match_date}</div>
                                                </div>
                                                <span className={`text-xs px-3 py-1.5 rounded-full ${badge.class}`}>
                                                    {badge.icon} {badge.text}
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-center bg-rm-light/50 rounded-xl p-3">
                                                <div>
                                                    <span className="text-gray-400 text-sm">{formatBetType(bet.bet_type)}</span>
                                                    <span className="mx-2 text-gray-600">‚Ä¢</span>
                                                    <span className="text-sm">{bet.amount} √ó {bet.odds}</span>
                                                </div>
                                                <div className={`font-bold text-lg ${bet.status === 'won' ? 'text-green-400' : bet.status === 'sold' ? 'text-orange-400' : bet.status === 'returned' ? 'text-blue-400' : 'text-red-400'}`}>
                                                    {bet.status === 'won' ? `+${bet.potential_win}` : bet.status === 'sold' ? `+${bet.sold_amount || Math.floor(bet.amount/2)}` : bet.status === 'returned' ? `‚Ü© ${bet.amount}` : `-${bet.amount}`}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="text-center py-16">
                                <div className="text-6xl mb-4">üìú</div>
                                <div className="text-gray-400">–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫</div>
                            </div>
                        )
                    ) : null}
                </div>
            );
        };

        // ==================== GAMES PAGE (—Å–≤–æ–±–æ–¥–Ω–∞—è –∏–≥—Ä–∞ –±–µ–∑ –æ—á–∫–æ–≤) ====================
        const GamesPage = () => {
            const [activeGame, setActiveGame] = useState(null);

            return (
                <div className="p-4 pb-28 animate-fade">
                    <h1 className="text-2xl font-bold mb-2">üéÆ –ú–∏–Ω–∏-–∏–≥—Ä—ã</h1>
                    <p className="text-gray-400 mb-6">–ò–≥—Ä–∞–π –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π! (–±–µ–∑ –æ—á–∫–æ–≤)</p>

                    {/* –°–ø–∏—Å–æ–∫ –∏–≥—Ä */}
                    {!activeGame && (
                        <div className="grid grid-cols-2 gap-4">
                            <button
                                onClick={() => setActiveGame('penalty')}
                                className="glass rounded-2xl p-5 text-center hover:scale-[1.02] transition-all"
                            >
                                <div className="text-4xl mb-3">‚öΩ</div>
                                <div className="font-bold text-green-400 mb-1">–ü–µ–Ω–∞–ª—å—Ç–∏</div>
                                <div className="text-xs text-gray-400">–ó–∞–±–µ–π 5 —É–¥–∞—Ä–æ–≤</div>
                            </button>

                            <button
                                onClick={() => setActiveGame('memory')}
                                className="glass rounded-2xl p-5 text-center hover:scale-[1.02] transition-all"
                            >
                                <div className="text-4xl mb-3">üß†</div>
                                <div className="font-bold text-pink-400 mb-1">Memory</div>
                                <div className="text-xs text-gray-400">–ù–∞–π–¥–∏ –ø–∞—Ä—ã</div>
                            </button>

                            <button
                                onClick={() => setActiveGame('catch')}
                                className="glass rounded-2xl p-5 text-center hover:scale-[1.02] transition-all"
                            >
                                <div className="text-4xl mb-3">üêî</div>
                                <div className="font-bold text-yellow-400 mb-1">–ù—É, –ø–æ–≥–æ–¥–∏!</div>
                                <div className="text-xs text-gray-400">–õ–æ–≤–∏ —è–π—Ü–∞!</div>
                            </button>

                            <button
                                disabled
                                className="glass rounded-2xl p-5 text-center opacity-50"
                            >
                                <div className="text-4xl mb-3">‚ùì</div>
                                <div className="font-bold text-gray-400 mb-1">–ù–æ–≤–∞—è –∏–≥—Ä–∞</div>
                                <div className="text-xs text-gray-500">–°–∫–æ—Ä–æ</div>
                            </button>
                        </div>
                    )}

                    {/* Penalty Game */}
                    {activeGame === 'penalty' && (
                        <div className="fixed inset-0 z-50 bg-black">
                            <button
                                onClick={() => setActiveGame(null)}
                                className="absolute top-4 right-4 z-[60] bg-black/50 text-white w-10 h-10 rounded-full text-xl"
                            >√ó</button>
                            <iframe
                                src="penalty.html?freeplay=1"
                                className="w-full h-full border-0"
                                allow="autoplay"
                            />
                        </div>
                    )}

                    {/* Memory Game */}
                    {activeGame === 'memory' && (
                        <div className="fixed inset-0 z-50 bg-black">
                            <button
                                onClick={() => setActiveGame(null)}
                                className="absolute top-4 right-4 z-[60] bg-black/50 text-white w-10 h-10 rounded-full text-xl"
                            >√ó</button>
                            <iframe
                                src="memory.html?freeplay=1"
                                className="w-full h-full border-0"
                                allow="autoplay"
                            />
                        </div>
                    )}

                    {/* Nu Pogodi Game - Freeplay */}
                    {activeGame === 'catch' && (
                        <div className="fixed inset-0 z-50 bg-black">
                            <button
                                onClick={() => setActiveGame(null)}
                                className="absolute top-4 right-4 z-[60] bg-black/50 text-white w-10 h-10 rounded-full text-xl"
                            >√ó</button>
                            <iframe
                                src="nu-pogodi.html?freeplay=1"
                                className="w-full h-full border-0"
                                allow="autoplay"
                            />
                        </div>
                    )}
                </div>
            );
        };

        // ==================== PREDICTIONS PAGE ====================
        const PredictionsPage = ({ match, predictions, loading, onPredict }) => {
            const [userPrediction, setUserPrediction] = useState(null);

            const predictionOptions = [
                { key: 'home', label: '–ü–æ–±–µ–¥–∞ —Ö–æ–∑—è–µ–≤', icon: 'üè†', color: 'from-green-500/20 to-green-600/20 border-green-500/30' },
                { key: 'draw', label: '–ù–∏—á—å—è', icon: 'ü§ù', color: 'from-yellow-500/20 to-yellow-600/20 border-yellow-500/30' },
                { key: 'away', label: '–ü–æ–±–µ–¥–∞ –≥–æ—Å—Ç–µ–π', icon: '‚úàÔ∏è', color: 'from-blue-500/20 to-blue-600/20 border-blue-500/30' }
            ];

            // Find if user already predicted on this match
            const existingPrediction = useMemo(() => {
                if (!predictions || !match) return null;
                return predictions.find(p => String(p.match_id) === String(match.id) && p.status === 'pending');
            }, [predictions, match]);

            const handlePredict = async (type) => {
                if (existingPrediction) return;

                try {
                    await api.post('/api/prediction/make', {
                        match_id: match.id,
                        prediction: type
                    });
                    tg?.HapticFeedback?.notificationOccurred?.('success');
                    tg?.showAlert?.('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏–Ω—è—Ç! üéØ') || alert('–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏–Ω—è—Ç! üéØ');
                    onPredict?.();
                } catch (err) {
                    tg?.HapticFeedback?.notificationOccurred?.('error');
                    tg?.showAlert?.(err.message) || alert(err.message);
                }
            };

            return (
                <div className="p-4 pb-28 animate-fade">
                    <h1 className="text-2xl font-bold mb-2">üéØ –ü—Ä–æ–≥–Ω–æ–∑—ã</h1>
                    <p className="text-gray-400 mb-6">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã ‚Äî —É–≥–∞–¥–∞–π –∏—Å—Ö–æ–¥ –∏ –ø–æ–ª—É—á–∏ –æ—á–∫–∏!</p>

                    {/* Current match prediction */}
                    {loading ? (
                        <div>
                            <LoadingBar text="–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤..." />
                            <Skeleton className="h-64 w-full" rounded="rounded-2xl" />
                        </div>
                    ) : match ? (
                        <div className="glass rounded-2xl p-5 mb-6">
                            <div className="flex justify-between items-center mb-4">
                                <span className="text-rm-gold text-xs font-semibold px-3 py-1 bg-rm-gold/10 rounded-full border border-rm-gold/20">
                                    {match.competition}
                                </span>
                                <span className="text-gray-400 text-xs flex items-center gap-1">
                                    <Icons.Clock />{match.date}
                                </span>
                            </div>

                            <div className="text-center mb-6">
                                <div className="flex items-center justify-center gap-4 mb-2">
                                    <span className={`font-bold text-lg ${match.home_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>
                                        {match.home_team}
                                    </span>
                                    <span className="text-gray-600">vs</span>
                                    <span className={`font-bold text-lg ${match.away_team?.includes('Real Madrid') ? 'text-rm-gold' : ''}`}>
                                        {match.away_team}
                                    </span>
                                </div>
                            </div>

                            {existingPrediction ? (
                                <div className="bg-rm-gold/10 border border-rm-gold/30 rounded-xl p-4 text-center">
                                    <div className="text-rm-gold text-lg mb-1">‚úÖ –ü—Ä–æ–≥–Ω–æ–∑ —Å–¥–µ–ª–∞–Ω</div>
                                    <div className="text-gray-400">
                                        –¢—ã –≤—ã–±—Ä–∞–ª: <span className="font-bold text-white">
                                            {existingPrediction.prediction === 'home' ? '–ü–æ–±–µ–¥–∞ —Ö–æ–∑—è–µ–≤' :
                                             existingPrediction.prediction === 'draw' ? '–ù–∏—á—å—è' : '–ü–æ–±–µ–¥–∞ –≥–æ—Å—Ç–µ–π'}
                                        </span>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    <p className="text-center text-gray-400 text-sm mb-4">–í—ã–±–µ—Ä–∏ –∏—Å—Ö–æ–¥ –º–∞—Ç—á–∞:</p>
                                    {predictionOptions.map(opt => (
                                        <button
                                            key={opt.key}
                                            onClick={() => handlePredict(opt.key)}
                                            className={`w-full bg-gradient-to-r ${opt.color} border rounded-xl p-4 flex items-center gap-4 hover:scale-[1.02] transition-all`}
                                        >
                                            <span className="text-3xl">{opt.icon}</span>
                                            <span className="font-semibold text-lg">{opt.label}</span>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="glass rounded-2xl p-8 text-center mb-6">
                            <div className="text-5xl mb-4">‚öΩ</div>
                            <div className="text-gray-400">–ù–µ—Ç –º–∞—Ç—á–µ–π –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞</div>
                        </div>
                    )}

                    {/* Prediction history */}
                    <h2 className="text-lg font-bold mb-4">üìä –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</h2>
                    {predictions?.length > 0 ? (
                        <div className="space-y-3">
                            {predictions.map((p, i) => {
                                const isCorrect = p.status === 'correct' || p.status === 'won';
                                const isIncorrect = p.status === 'incorrect' || p.status === 'lost';
                                const statusClass = isCorrect ? 'badge-won' :
                                                   isIncorrect ? 'badge-lost' : 'badge-pending';
                                const statusText = isCorrect ? '‚úÖ –£–≥–∞–¥–∞–ª' :
                                                  isIncorrect ? '‚ùå –ù–µ —É–≥–∞–¥–∞–ª' : '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ';
                                const predText = p.prediction === 'home' ? '–ü1' :
                                                p.prediction === 'draw' ? 'X' : '–ü2';

                                return (
                                    <div key={i} className="glass rounded-xl p-4">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <div className="font-medium text-sm">{p.home_team} vs {p.away_team}</div>
                                                <div className="text-xs text-gray-500">{p.match_date}</div>
                                            </div>
                                            <span className={`text-xs px-3 py-1 rounded-full ${statusClass}`}>{statusText}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-400 text-sm">–ü—Ä–æ–≥–Ω–æ–∑: {predText}</span>
                                            {isCorrect && <span className="text-green-400 font-bold">+{p.points_change || 50}</span>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="text-center py-8">
                            <div className="text-4xl mb-3">üéØ</div>
                            <div className="text-gray-400">–ü—Ä–æ–≥–Ω–æ–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                        </div>
                    )}
                </div>
            );
        };

        // ==================== RATING PAGE ====================
        const RatingPage = ({ leaderboard, user, loading }) => {
            const userRank = useMemo(() => {
                if (!leaderboard || !user) return null;
                const idx = leaderboard.findIndex(l => l.user_id === user.user_id);
                return idx >= 0 ? idx + 1 : null;
            }, [leaderboard, user]);

            return (
                <div className="p-4 pb-28 animate-fade">
                    <h1 className="text-2xl font-bold mb-5">üèÜ –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h1>

                    {/* User rank card */}
                    {user && userRank && (
                        <div className="glass rounded-2xl p-5 mb-6 border border-rm-gold/30 animate-glow">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="w-14 h-14 bg-gradient-to-br from-rm-gold to-yellow-600 rounded-full flex items-center justify-center text-2xl font-bold text-black">
                                        {user.first_name?.[0] || '?'}
                                    </div>
                                    <div>
                                        <div className="font-bold text-lg">{user.first_name}</div>
                                        <div className="text-gray-400 text-sm">@{user.username || 'anonymous'}</div>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-3xl font-bold text-rm-gold">{userRank}</div>
                                    <div className="text-gray-400 text-sm">–º–µ—Å—Ç–æ</div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Leaderboard */}
                    {loading ? (
                        <div className="space-y-3">
                            <LoadingBar text="–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞..." />
                            {[1,2,3,4,5].map(i => <Skeleton key={i} className="h-20 w-full" rounded="rounded-2xl" />)}
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {leaderboard?.map((l, i) => {
                                const isUser = l.user_id === user?.user_id;
                                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : null;
                                const initials = (l.first_name || '?')[0].toUpperCase();
                                const colors = ['bg-blue-600','bg-purple-600','bg-pink-600','bg-green-600','bg-orange-600','bg-cyan-600','bg-red-600','bg-indigo-600'];
                                const bgColor = colors[(l.user_id || i) % colors.length];

                                return (
                                    <div
                                        key={l.user_id}
                                        className={`glass rounded-2xl p-4 flex items-center transition-all ${isUser ? 'ring-2 ring-rm-gold/50 bg-rm-gold/5' : ''}`}
                                    >
                                        {/* Position */}
                                        <div className="w-7 text-center font-bold text-sm text-gray-500 flex-shrink-0">
                                            {medal || (i + 1)}
                                        </div>
                                        {/* Avatar */}
                                        <div className="w-10 h-10 rounded-full flex-shrink-0 ml-2 overflow-hidden">
                                            {l.photo_url ? (
                                                <img src={l.photo_url} className="w-full h-full object-cover" loading="lazy"
                                                    onError={(e) => { e.target.style.display='none'; e.target.nextSibling.style.display='flex'; }} />
                                            ) : null}
                                            <div className={`w-full h-full ${bgColor} flex items-center justify-center text-white font-bold text-lg`}
                                                style={{display: l.photo_url ? 'none' : 'flex'}}>
                                                {initials}
                                            </div>
                                        </div>
                                        <div className="flex-1 ml-3 min-w-0">
                                            <div className={`font-semibold truncate ${isUser ? 'text-rm-gold' : ''}`}>{l.first_name || '–ò–≥—Ä–æ–∫'}</div>
                                            <div className="text-gray-500 text-sm truncate">@{l.username || 'anonymous'}</div>
                                        </div>
                                        <div className="text-right flex-shrink-0">
                                            <div className="text-rm-gold font-bold text-xl">{l.balance?.toLocaleString()}</div>
                                            <div className="text-gray-500 text-xs">–æ—á–∫–æ–≤</div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // ==================== NEWS PAGE ====================
        const NewsPage = ({ news, loading, onRefresh }) => {
            const [viewImage, setViewImage] = useState(null);
            const [viewVideo, setViewVideo] = useState(null);

            // Extract VK video ID for embed: https://vk.com/video-123_456 -> -123_456
            const getVkVideoEmbed = (url) => {
                if (!url) return null;
                const match = url.match(/video(-?\d+_\d+)/);
                if (match) {
                    return `https://vk.com/video_ext.php?oid=${match[1].split('_')[0]}&id=${match[1].split('_')[1]}&hd=2`;
                }
                return null;
            };

            const NewsCard = ({ item, onVideoClick }) => {
                const isVideo = item.media_type === 'video';

                const handleClick = (e) => {
                    if (isVideo && onVideoClick) {
                        e.preventDefault();
                        onVideoClick(item);
                    }
                };

                return (
                    <a
                        href={item.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        onClick={handleClick}
                        className="block glass rounded-2xl overflow-hidden"
                    >
                        {/* –ú–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç */}
                        {item.photo_url ? (
                            <div className="relative">
                                <img
                                    src={item.photo_url}
                                    alt=""
                                    className="w-full"
                                    style={{ maxHeight: '400px', objectFit: 'contain', backgroundColor: '#0A0A0C' }}
                                    loading="lazy"
                                />
                                {/* –ö–Ω–æ–ø–∫–∞ Play –¥–ª—è –≤–∏–¥–µ–æ */}
                                {isVideo && (
                                    <div className="absolute inset-0 flex items-center justify-center bg-black/30">
                                        <div className="w-16 h-16 bg-rm-gold/90 rounded-full flex items-center justify-center">
                                            <span className="text-3xl ml-1">‚ñ∂</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : isVideo ? (
                            <div className="bg-gradient-to-r from-rm-gold/20 to-rm-gold/10 p-8 flex items-center justify-center gap-3">
                                <div className="w-14 h-14 bg-rm-gold/80 rounded-full flex items-center justify-center">
                                    <span className="text-2xl ml-1">‚ñ∂</span>
                                </div>
                                <span className="text-sm text-gray-300">–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ</span>
                            </div>
                        ) : item.has_media && (
                            <div className="bg-gradient-to-r from-rm-gold/20 to-rm-gold/10 p-4 flex items-center justify-center gap-2">
                                <span className="text-2xl">üì∑</span>
                                <span className="text-sm text-gray-300">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram</span>
                            </div>
                        )}
                        <div className="p-4">
                            <div className="flex items-center gap-2 mb-2">
                                <span className="text-xs text-gray-500">{item.date}</span>
                                {isVideo && <span className="text-xs bg-rm-gold/20 text-rm-gold px-2 py-0.5 rounded-full">üìπ –í–∏–¥–µ–æ</span>}
                            </div>
                            <p className="text-sm leading-relaxed whitespace-pre-line">{item.text}</p>
                        </div>
                    </a>
                );
            };

            return (
                <div className="p-4 pb-28 animate-fade">
                    {/* Image Viewer Modal */}
                    {viewImage && (
                        <div
                            className="fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4"
                            onClick={() => setViewImage(null)}
                        >
                            <button
                                className="absolute top-4 right-4 w-10 h-10 bg-white/10 rounded-full flex items-center justify-center text-white text-2xl z-10"
                                onClick={() => setViewImage(null)}
                            >
                                √ó
                            </button>
                            <img
                                src={viewImage}
                                alt=""
                                className="max-w-full max-h-full object-contain"
                            />
                        </div>
                    )}

                    {/* Video Player Modal */}
                    {viewVideo && (
                        <div
                            className="fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4"
                            onClick={() => setViewVideo(null)}
                        >
                            <button
                                className="absolute top-4 right-4 w-10 h-10 bg-white/10 rounded-full flex items-center justify-center text-white text-2xl z-10"
                                onClick={() => setViewVideo(null)}
                            >
                                √ó
                            </button>
                            <div className="w-full max-w-lg" onClick={e => e.stopPropagation()}>
                                {/* Video Player */}
                                {viewVideo.video_url && viewVideo.video_url.startsWith('/api/') ? (
                                    <video
                                        src={viewVideo.video_url}
                                        controls
                                        autoPlay
                                        playsInline
                                        className="w-full rounded-xl bg-black"
                                        style={{ maxHeight: '70vh' }}
                                    >
                                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ
                                    </video>
                                ) : (
                                    <>
                                        {/* Fallback - –ø—Ä–µ–≤—å—é + —Å—Å—ã–ª–∫–∞ */}
                                        {viewVideo.photo_url && (
                                            <img
                                                src={viewVideo.photo_url}
                                                alt=""
                                                className="w-full rounded-t-xl"
                                                style={{ maxHeight: '300px', objectFit: 'contain', backgroundColor: '#0A0A0C' }}
                                            />
                                        )}
                                        <div className="bg-rm-card p-4 rounded-b-xl">
                                            <a
                                                href={viewVideo.url}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="block w-full btn-gold py-3 rounded-xl font-bold text-center"
                                            >
                                                ‚ñ∂ –°–º–æ—Ç—Ä–µ—Ç—å –≤ Telegram
                                            </a>
                                        </div>
                                    </>
                                )}

                                {/* –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ */}
                                <div className="bg-rm-card/80 p-3 mt-2 rounded-xl">
                                    <p className="text-sm text-gray-300 line-clamp-3">{viewVideo.text}</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-5">
                        <h1 className="text-2xl font-bold">üì∞ –ù–æ–≤–æ—Å—Ç–∏</h1>
                        <button
                            onClick={onRefresh}
                            className="text-rm-gold text-sm bg-rm-gold/10 px-3 py-1.5 rounded-full"
                        >
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>

                    {loading ? (
                        <div className="space-y-4">
                            <div className="glass rounded-xl p-4">
                                <div className="flex items-center gap-3 mb-3">
                                    <div className="animate-spin text-xl">‚è≥</div>
                                    <span className="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</span>
                                </div>
                                <div className="w-full bg-rm-light rounded-full h-2 overflow-hidden">
                                    <div className="bg-rm-gold h-2 rounded-full animate-loading"></div>
                                </div>
                            </div>
                            {[1,2,3].map(i => <Skeleton key={i} className="h-48 w-full" rounded="rounded-2xl" />)}
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {news?.length > 0 ? news.map((item, i) => (
                                <NewsCard key={i} item={item} onVideoClick={(v) => setViewVideo(v)} />
                            )) : (
                                <div className="text-center py-12">
                                    <div className="text-5xl mb-4">üì∞</div>
                                    <div className="text-gray-400">–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π</div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // ==================== PRIZES PAGE ====================
        const PrizesPage = ({ balance, loading }) => {
            const prizes = [
                { id: 1, name: '–§—É—Ç–±–æ–ª–∫–∞ Real Madrid', cost: 1000, icon: 'üëï', desc: '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞ —Å–µ–∑–æ–Ω–∞ 24/25' },
                { id: 2, name: 'Telegram Premium 3 –º–µ—Å', cost: 1500, icon: '‚≠ê', desc: '–ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞ Telegram' },
                { id: 3, name: 'PlayStation 5 Slim', cost: 55000, icon: 'üéÆ', desc: '–ò–≥—Ä–æ–≤–∞—è –∫–æ–Ω—Å–æ–ª—å Sony' },
            ];

            return (
                <div className="p-4 pb-28 animate-fade">
                    <h1 className="text-2xl font-bold mb-2">üéÅ –ú–∞–≥–∞–∑–∏–Ω –ø—Ä–∏–∑–æ–≤</h1>
                    <p className="text-gray-400 mb-6">
                        –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: <span className="text-rm-gold font-bold">{balance?.toLocaleString() || 0}</span> –æ—á–∫–æ–≤
                    </p>

                    <div className="space-y-5">
                        {prizes.map(prize => {
                            const canBuy = balance >= prize.cost;
                            const need = prize.cost - (balance || 0);
                            const progress = Math.min(100, ((balance || 0) / prize.cost) * 100);

                            return (
                                <div key={prize.id} className="glass rounded-2xl p-5 overflow-hidden relative">
                                    <div className="flex gap-5">
                                        <div className="text-5xl">{prize.icon}</div>
                                        <div className="flex-1">
                                            <h3 className="font-bold text-lg mb-1">{prize.name}</h3>
                                            <p className="text-sm text-gray-400 mb-3">{prize.desc}</p>

                                            {/* Progress bar */}
                                            <div className="h-2 bg-rm-light rounded-full mb-3 overflow-hidden">
                                                <div
                                                    className="h-full bg-gradient-to-r from-rm-gold to-yellow-500 rounded-full transition-all duration-500"
                                                    style={{ width: `${progress}%` }}
                                                ></div>
                                            </div>

                                            <div className="flex items-center justify-between">
                                                <span className="text-rm-gold font-bold text-xl">{prize.cost.toLocaleString()}</span>
                                                {canBuy ? (
                                                    <button className="btn-gold px-5 py-2.5 rounded-xl text-sm">
                                                        üõí –ö—É–ø–∏—Ç—å
                                                    </button>
                                                ) : (
                                                    <span className="text-gray-500 text-sm">–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç {need.toLocaleString()}</span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // ==================== PROFILE PAGE ====================
        const ProfilePage = ({ user, leaderboard, loading, onBuyPrize, photoUrl }) => {
            const [tab, setTab] = useState('stats');
            const [prizes, setPrizes] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [txLoading, setTxLoading] = useState(false);
            const [referralInfo, setReferralInfo] = useState(null);
            const [refLoading, setRefLoading] = useState(false);
            const [buyModal, setBuyModal] = useState({ open: false, prize: null });
            const [buyForm, setBuyForm] = useState({ contact: '', size: '', phone: '', address: '' });
            const [buyLoading, setBuyLoading] = useState(false);

            // Admin state
            const [adminUsername, setAdminUsername] = useState('');
            const [adminAmount, setAdminAmount] = useState('');
            const [adminLoading, setAdminLoading] = useState(false);
            const [adminResult, setAdminResult] = useState(null);

            const isAdmin = ADMIN_IDS.includes(user?.user_id);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–∑—ã
            useEffect(() => {
                api.get('/api/prizes').then(data => {
                    setPrizes(data.prizes || []);
                }).catch(() => {});
            }, []);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
            useEffect(() => {
                if (tab === 'history') {
                    setTxLoading(true);
                    api.get('/api/user/transactions?limit=50').then(data => {
                        setTransactions(data.transactions || []);
                    }).catch(() => {}).finally(() => setTxLoading(false));
                }
                if (tab === 'referral') {
                    setRefLoading(true);
                    api.get('/api/referral/info').then(data => {
                        setReferralInfo(data);
                    }).catch(() => {}).finally(() => setRefLoading(false));
                }
            }, [tab]);

            const userRank = useMemo(() => {
                if (!leaderboard || !user) return '‚Äî';
                const idx = leaderboard.findIndex(l => l.user_id === user.user_id);
                return idx >= 0 ? idx + 1 : '‚Äî';
            }, [leaderboard, user]);

            const handleBuyPrize = async () => {
                if (!buyModal.prize) return;
                setBuyLoading(true);

                try {
                    await api.post('/api/prize/claim', {
                        prize_id: buyModal.prize.id,
                        contact: buyForm.contact,
                        size: buyForm.size || null,
                        phone: buyForm.phone || null,
                        address: buyForm.address || null
                    });
                    tg?.showAlert?.('üéâ –ó–∞—è–≤–∫–∞ –Ω–∞ –ø—Ä–∏–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!') || alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
                    setBuyModal({ open: false, prize: null });
                    setBuyForm({ contact: '', size: '', phone: '', address: '' });
                    onBuyPrize?.();
                } catch (err) {
                    tg?.showAlert?.(err.message) || alert(err.message);
                } finally {
                    setBuyLoading(false);
                }
            };

            const handleAdminAddBalance = async () => {
                if (!adminUsername || !adminAmount) return;
                setAdminLoading(true);
                setAdminResult(null);
                try {
                    const result = await api.post('/api/admin/add-balance', {
                        username: adminUsername,
                        amount: parseInt(adminAmount)
                    });
                    setAdminResult(result);
                    setAdminUsername('');
                    setAdminAmount('');
                } catch (err) {
                    setAdminResult({ error: err.message });
                } finally {
                    setAdminLoading(false);
                }
            };

            return (
                <div className="p-4 pb-28 animate-fade">
                    {/* Profile Header */}
                    <div className="glass rounded-2xl p-6 mb-6 text-center">
                        <div className="w-24 h-24 rounded-full mx-auto mb-4 overflow-hidden shadow-lg shadow-rm-gold/20">
                            {photoUrl ? (
                                <img src={photoUrl} className="w-full h-full object-cover" onError={(e) => { e.target.style.display='none'; e.target.parentElement.innerHTML=`<div class="w-24 h-24 bg-gradient-to-br from-rm-gold via-yellow-500 to-rm-gold rounded-full flex items-center justify-center text-4xl font-bold text-black">${user?.first_name?.[0] || '?'}</div>`; }} />
                            ) : (
                                <div className="w-full h-full bg-gradient-to-br from-rm-gold via-yellow-500 to-rm-gold flex items-center justify-center text-4xl font-bold text-black">
                                    {user?.first_name?.[0] || '?'}
                                </div>
                            )}
                        </div>
                        <h2 className="text-2xl font-bold mb-1">{user?.first_name || '–§–∞–Ω–∞—Ç'}</h2>
                        <p className="text-gray-400 mb-4">@{user?.username || 'anonymous'}</p>
                        <div className="inline-flex items-center gap-3 bg-rm-light px-5 py-2.5 rounded-full">
                            <span className="text-xl">üèÜ</span>
                            <span className="font-semibold">{userRank} –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ</span>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex gap-4 mb-6 border-b border-rm-light pb-1 overflow-x-auto hide-scrollbar">
                        <button onClick={() => setTab('stats')} className={`pb-3 text-sm font-semibold whitespace-nowrap ${tab === 'stats' ? 'tab-active text-white' : 'text-gray-500'}`}>
                            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </button>
                        <button onClick={() => setTab('history')} className={`pb-3 text-sm font-semibold whitespace-nowrap ${tab === 'history' ? 'tab-active text-white' : 'text-gray-500'}`}>
                            üìú –ò—Å—Ç–æ—Ä–∏—è
                        </button>
                        <button onClick={() => setTab('referral')} className={`pb-3 text-sm font-semibold whitespace-nowrap ${tab === 'referral' ? 'tab-active text-white' : 'text-gray-500'}`}>
                            üë• –î—Ä—É–∑—å—è
                        </button>
                        <button onClick={() => setTab('rating')} className={`pb-3 text-sm font-semibold whitespace-nowrap ${tab === 'rating' ? 'tab-active text-white' : 'text-gray-500'}`}>
                            üèÜ –†–µ–π—Ç–∏–Ω–≥
                        </button>
                        <button onClick={() => setTab('prizes')} className={`pb-3 text-sm font-semibold whitespace-nowrap ${tab === 'prizes' ? 'tab-active text-white' : 'text-gray-500'}`}>
                            üéÅ –ü—Ä–∏–∑—ã
                        </button>
                        {isAdmin && (
                            <button onClick={() => setTab('admin')} className={`pb-3 text-sm font-semibold whitespace-nowrap ${tab === 'admin' ? 'tab-active text-white' : 'text-gray-500'}`}>
                                üëë –ê–¥–º–∏–Ω
                            </button>
                        )}
                    </div>

                    {/* Stats Tab */}
                    {tab === 'stats' && (
                        <div className="grid grid-cols-2 gap-4">
                            <div className="glass rounded-2xl p-5 col-span-2">
                                <div className="text-rm-gold text-4xl font-bold text-center">{user?.balance?.toLocaleString() || 0}</div>
                                <div className="text-gray-400 text-sm text-center">–ë–∞–ª–∞–Ω—Å –æ—á–∫–æ–≤</div>
                            </div>
                            <div className="glass rounded-2xl p-5">
                                <div className="text-3xl font-bold">{user?.bets_count || 0}</div>
                                <div className="text-gray-400 text-sm">–í—Å–µ–≥–æ —Å—Ç–∞–≤–æ–∫</div>
                            </div>
                            <div className="glass rounded-2xl p-5">
                                <div className="text-green-400 text-3xl font-bold">{user?.bets_won || 0}</div>
                                <div className="text-gray-400 text-sm">–°—Ç–∞–≤–æ–∫ –≤—ã–∏–≥—Ä–∞–Ω–æ</div>
                            </div>
                            <div className="glass rounded-2xl p-5">
                                <div className="text-green-400 text-3xl font-bold">{user?.predictions_correct || 0}</div>
                                <div className="text-gray-400 text-sm">–ü—Ä–æ–≥–Ω–æ–∑–æ–≤ ‚úÖ</div>
                            </div>
                            <div className="glass rounded-2xl p-5">
                                <div className="text-red-400 text-3xl font-bold">{user?.predictions_incorrect || 0}</div>
                                <div className="text-gray-400 text-sm">–ü—Ä–æ–≥–Ω–æ–∑–æ–≤ ‚ùå</div>
                            </div>
                        </div>
                    )}

                    {/* History Tab */}
                    {tab === 'history' && (
                        <div className="space-y-4">
                            {txLoading ? (
                                <div>
                                    <LoadingBar text="–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏..." />
                                    <div className="space-y-3">
                                        {[1,2,3].map(i => <Skeleton key={i} className="h-20 w-full" rounded="rounded-xl" />)}
                                    </div>
                                </div>
                            ) : transactions.length > 0 ? (
                                <>
                                    {/* –ì—Ä–∞—Ñ–∏–∫ –±–∞–ª–∞–Ω—Å–∞ */}
                                    <div className="glass rounded-2xl p-4">
                                        <h4 className="font-bold mb-3">üìà –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞</h4>
                                        <div className="relative" style={{height: '160px'}}>
                                            {(() => {
                                                // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                                                const data = [...transactions].reverse().slice(-10);
                                                if (data.length < 2) return <div className="text-center text-gray-500 pt-16">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</div>;

                                                const balances = data.map(t => t.balance_after || 0);
                                                const max = Math.max(...balances);
                                                const min = Math.min(...balances);
                                                const range = max - min || 1;

                                                // –†–∞–∑–º–µ—Ä—ã —Å —É—á—ë—Ç–æ–º –æ—Ç—Å—Ç—É–ø–æ–≤ –¥–ª—è –æ—Å–µ–π
                                                const padding = { top: 10, right: 10, bottom: 25, left: 45 };
                                                const width = 300;
                                                const height = 140;
                                                const chartWidth = width - padding.left - padding.right;
                                                const chartHeight = height - padding.top - padding.bottom;

                                                // –°–æ–∑–¥–∞—ë–º —Ç–æ—á–∫–∏
                                                const points = balances.map((bal, i) => {
                                                    const x = padding.left + (i / (balances.length - 1)) * chartWidth;
                                                    const y = padding.top + chartHeight - ((bal - min) / range) * chartHeight;
                                                    return { x, y, val: bal };
                                                });

                                                // –ü–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è –ë–µ–∑—å–µ
                                                const createSmoothPath = (pts) => {
                                                    if (pts.length < 2) return '';
                                                    let path = `M ${pts[0].x},${pts[0].y}`;
                                                    for (let i = 0; i < pts.length - 1; i++) {
                                                        const p0 = pts[i];
                                                        const p1 = pts[i + 1];
                                                        const midX = (p0.x + p1.x) / 2;
                                                        path += ` C ${midX},${p0.y} ${midX},${p1.y} ${p1.x},${p1.y}`;
                                                    }
                                                    return path;
                                                };

                                                const linePath = createSmoothPath(points);
                                                const areaPath = linePath + ` L ${points[points.length-1].x},${height - padding.bottom} L ${padding.left},${height - padding.bottom} Z`;

                                                // –ó–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ—Å–∏ Y (3 –º–µ—Ç–∫–∏)
                                                const yLabels = [max, Math.round((max + min) / 2), min];

                                                return (
                                                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full">
                                                        <defs>
                                                            <linearGradient id="balanceGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                                                <stop offset="0%" stopColor="#FEBE10" stopOpacity="0.4"/>
                                                                <stop offset="100%" stopColor="#FEBE10" stopOpacity="0.05"/>
                                                            </linearGradient>
                                                        </defs>

                                                        {/* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏ */}
                                                        {[0, 0.5, 1].map((ratio, i) => (
                                                            <line
                                                                key={i}
                                                                x1={padding.left}
                                                                y1={padding.top + chartHeight * ratio}
                                                                x2={width - padding.right}
                                                                y2={padding.top + chartHeight * ratio}
                                                                stroke="#333"
                                                                strokeDasharray="3,3"
                                                            />
                                                        ))}

                                                        {/* –û—Å—å Y - –∑–Ω–∞—á–µ–Ω–∏—è */}
                                                        {yLabels.map((val, i) => (
                                                            <text
                                                                key={i}
                                                                x={padding.left - 5}
                                                                y={padding.top + (i * chartHeight / 2) + 4}
                                                                fill="#888"
                                                                fontSize="10"
                                                                textAnchor="end"
                                                            >
                                                                {val}
                                                            </text>
                                                        ))}

                                                        {/* –ó–∞–ª–∏–≤–∫–∞ –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º */}
                                                        <path d={areaPath} fill="url(#balanceGradient)" />

                                                        {/* –ü–ª–∞–≤–Ω–∞—è –ª–∏–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ */}
                                                        <path
                                                            d={linePath}
                                                            fill="none"
                                                            stroke="#FEBE10"
                                                            strokeWidth="2.5"
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                        />

                                                        {/* –¢–æ—á–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ */}
                                                        {points.map((p, i) => {
                                                            const isLast = i === points.length - 1;
                                                            const isFirst = i === 0;
                                                            return (
                                                                <g key={i}>
                                                                    <circle
                                                                        cx={p.x}
                                                                        cy={p.y}
                                                                        r={isLast ? 5 : isFirst ? 3 : 2}
                                                                        fill={isLast ? "#FEBE10" : "#fff"}
                                                                        stroke={isLast ? "#fff" : "none"}
                                                                        strokeWidth={isLast ? 2 : 0}
                                                                    />
                                                                    {/* –ü–æ–¥–ø–∏—Å—å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–µ */}
                                                                    {isLast && (
                                                                        <text
                                                                            x={p.x}
                                                                            y={p.y - 10}
                                                                            fill="#FEBE10"
                                                                            fontSize="11"
                                                                            fontWeight="bold"
                                                                            textAnchor="middle"
                                                                        >
                                                                            {p.val}
                                                                        </text>
                                                                    )}
                                                                </g>
                                                            );
                                                        })}

                                                        {/* –ü–æ–¥–ø–∏—Å–∏ –æ—Å–∏ X */}
                                                        <text x={padding.left} y={height - 5} fill="#666" fontSize="9" textAnchor="start">
                                                            {data.length} –Ω–∞–∑–∞–¥
                                                        </text>
                                                        <text x={width - padding.right} y={height - 5} fill="#666" fontSize="9" textAnchor="end">
                                                            —Å–µ–π—á–∞—Å
                                                        </text>
                                                    </svg>
                                                );
                                            })()}
                                        </div>
                                    </div>

                                    {/* –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π */}
                                    <div className="space-y-3">
                                        {transactions.map(tx => {
                                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
                                            let dateStr = '';
                                            try {
                                                const d = new Date(tx.created_at);
                                                if (!isNaN(d.getTime())) {
                                                    dateStr = d.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                                                }
                                            } catch(e) {}

                                            return (
                                                <div key={tx.id} className="glass rounded-xl p-4 flex items-center gap-4">
                                                    <div className="text-2xl">{tx.icon || 'üí´'}</div>
                                                    <div className="flex-1">
                                                        <div className="font-medium">{tx.type_name || tx.type}</div>
                                                        <div className="text-gray-500 text-xs">{tx.description}</div>
                                                        {dateStr && <div className="text-gray-600 text-xs mt-1">{dateStr}</div>}
                                                    </div>
                                                    <div className="text-right">
                                                        <div className={`font-bold text-lg ${tx.amount > 0 ? 'text-green-400' : tx.amount < 0 ? 'text-red-400' : 'text-gray-400'}`}>
                                                            {tx.amount > 0 ? '+' : ''}{tx.amount}
                                                        </div>
                                                        <div className="text-gray-600 text-xs">{tx.balance_after} üí∞</div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </>
                            ) : (
                                <div className="text-center py-12">
                                    <div className="text-5xl mb-4">üìú</div>
                                    <div className="text-gray-400">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Referral Tab */}
                    {tab === 'referral' && (
                        <div className="space-y-4">
                            {refLoading ? (
                                <div>
                                    <LoadingBar text="–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..." />
                                    <div className="space-y-3">
                                        {[1,2].map(i => <Skeleton key={i} className="h-32 w-full" rounded="rounded-2xl" />)}
                                    </div>
                                </div>
                            ) : (
                                <>
                                    {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                                    <div className="glass rounded-2xl p-5">
                                        <h4 className="font-bold mb-4 text-center">üë• –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–∑–µ–π</h4>
                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <div className="bg-rm-light rounded-xl p-4 text-center">
                                                <div className="text-3xl font-bold text-rm-gold">{referralInfo?.referral_count || 0}</div>
                                                <div className="text-gray-400 text-sm">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
                                            </div>
                                            <div className="bg-rm-light rounded-xl p-4 text-center">
                                                <div className="text-3xl font-bold text-green-400">+{referralInfo?.total_earnings || 0}</div>
                                                <div className="text-gray-400 text-sm">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                                            </div>
                                        </div>
                                        <div className="text-center text-sm text-gray-400 mb-4">
                                            üéÅ –ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞: <span className="text-rm-gold font-bold">+{referralInfo?.bonus_per_referral || 25} –æ—á–∫–æ–≤</span> —Ç–µ–±–µ –∏ –¥—Ä—É–≥—É!
                                            <div className="text-xs mt-1 text-gray-500">–ë–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —Å—Ç–∞–≤–∫–∏ –¥—Ä—É–≥–∞</div>
                                        </div>
                                    </div>

                                    {/* –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ */}
                                    <div className="glass rounded-2xl p-5">
                                        <h4 className="font-bold mb-3">üîó –¢–≤–æ—è —Å—Å—ã–ª–∫–∞</h4>
                                        <div className="bg-rm-light rounded-xl p-3 mb-3 break-all text-sm text-gray-300">
                                            {referralInfo?.ref_link || '–ó–∞–≥—Ä—É–∑–∫–∞...'}
                                        </div>
                                        <button
                                            onClick={() => {
                                                if (referralInfo?.ref_link) {
                                                    navigator.clipboard?.writeText(referralInfo.ref_link);
                                                    tg?.showAlert?.('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!') || alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
                                                }
                                            }}
                                            className="w-full btn-gold py-3 rounded-xl font-bold"
                                        >
                                            üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                                        </button>
                                    </div>

                                    {/* –ü–æ–¥–µ–ª–∏—Ç—å—Å—è */}
                                    <div className="glass rounded-2xl p-5">
                                        <h4 className="font-bold mb-3">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</h4>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button
                                                onClick={() => {
                                                    const text = `‚öΩ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ —Ñ–∞–Ω-–±–æ—Ç—É Real Madrid!\n\nüéÆ –°—Ç–∞–≤–∫–∏ –Ω–∞ –º–∞—Ç—á–∏\nüß† –í–∏–∫—Ç–æ—Ä–∏–Ω—ã\nüèÜ –ü—Ä–∏–∑—ã\n\n${referralInfo?.ref_link || ''}`;
                                                    window.open(`https://t.me/share/url?url=${encodeURIComponent(referralInfo?.ref_link || '')}&text=${encodeURIComponent(text)}`, '_blank');
                                                }}
                                                className="bg-blue-500 hover:bg-blue-600 py-3 rounded-xl font-bold transition-all"
                                            >
                                                üì± Telegram
                                            </button>
                                            <button
                                                onClick={() => {
                                                    const text = `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ —Ñ–∞–Ω-–±–æ—Ç—É Real Madrid! ${referralInfo?.ref_link || ''}`;
                                                    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank');
                                                }}
                                                className="bg-green-500 hover:bg-green-600 py-3 rounded-xl font-bold transition-all"
                                            >
                                                üí¨ WhatsApp
                                            </button>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    )}

                    {/* Rating Tab */}
                    {tab === 'rating' && (
                        <div className="space-y-3">
                            {leaderboard?.length > 0 ? leaderboard.map((l, i) => {
                                const isUser = l.user_id === user?.user_id;
                                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : null;
                                const initials = (l.first_name || '?')[0].toUpperCase();
                                const colors = ['bg-blue-600','bg-purple-600','bg-pink-600','bg-green-600','bg-orange-600','bg-cyan-600','bg-red-600','bg-indigo-600'];
                                const bgColor = colors[(l.user_id || i) % colors.length];

                                return (
                                    <div
                                        key={l.user_id}
                                        className={`glass rounded-2xl p-4 flex items-center transition-all ${isUser ? 'ring-2 ring-rm-gold/50 bg-rm-gold/5' : ''}`}
                                    >
                                        <div className="w-7 text-center font-bold text-sm text-gray-500 flex-shrink-0">
                                            {medal || (i + 1)}
                                        </div>
                                        <div className="w-10 h-10 rounded-full flex-shrink-0 ml-2 overflow-hidden">
                                            {l.photo_url ? (
                                                <img src={l.photo_url} className="w-full h-full object-cover" loading="lazy"
                                                    onError={(e) => { e.target.style.display='none'; e.target.nextSibling.style.display='flex'; }} />
                                            ) : null}
                                            <div className={`w-full h-full ${bgColor} flex items-center justify-center text-white font-bold text-lg`}
                                                style={{display: l.photo_url ? 'none' : 'flex'}}>
                                                {initials}
                                            </div>
                                        </div>
                                        <div className="flex-1 ml-3 min-w-0">
                                            <div className={`font-semibold truncate ${isUser ? 'text-rm-gold' : ''}`}>{l.first_name || '–ò–≥—Ä–æ–∫'}</div>
                                            <div className="text-gray-500 text-sm truncate">@{l.username || 'anonymous'}</div>
                                        </div>
                                        <div className="text-right flex-shrink-0">
                                            <div className="text-rm-gold font-bold text-xl">{l.balance?.toLocaleString()}</div>
                                            <div className="text-gray-500 text-xs">–æ—á–∫–æ–≤</div>
                                        </div>
                                    </div>
                                );
                            }) : (
                                <div className="text-center py-12">
                                    <div className="text-5xl mb-4">üèÜ</div>
                                    <div className="text-gray-400">–†–µ–π—Ç–∏–Ω–≥ –ø—É—Å—Ç</div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Prizes Tab */}
                    {tab === 'prizes' && (
                        <div className="space-y-4">
                            {prizes.map(prize => {
                                const canBuy = (user?.balance || 0) >= prize.cost;
                                const need = prize.cost - (user?.balance || 0);
                                const progress = Math.min(100, ((user?.balance || 0) / prize.cost) * 100);

                                return (
                                    <div key={prize.id} className="glass rounded-2xl p-5">
                                        <div className="flex gap-4">
                                            <div className="text-4xl">{prize.icon}</div>
                                            <div className="flex-1">
                                                <h3 className="font-bold mb-1">{prize.name}</h3>

                                                <div className="h-2 bg-rm-light rounded-full mb-3 overflow-hidden">
                                                    <div
                                                        className="h-full bg-gradient-to-r from-rm-gold to-yellow-500 rounded-full transition-all"
                                                        style={{ width: `${progress}%` }}
                                                    ></div>
                                                </div>

                                                <div className="flex items-center justify-between">
                                                    <span className="text-rm-gold font-bold">{prize.cost.toLocaleString()} –æ—á–∫–æ–≤</span>
                                                    {canBuy ? (
                                                        <button
                                                            onClick={() => setBuyModal({ open: true, prize })}
                                                            className="bg-rm-gold text-black px-4 py-2 rounded-lg text-sm font-bold hover:bg-yellow-400 transition"
                                                        >
                                                            üõí –ö—É–ø–∏—Ç—å
                                                        </button>
                                                    ) : (
                                                        <span className="text-gray-500 text-sm">–ù—É–∂–Ω–æ –µ—â—ë {need.toLocaleString()}</span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Buy Prize Modal */}
                    {buyModal.open && buyModal.prize && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => setBuyModal({ open: false, prize: null })}>
                            <div className="bg-rm-dark rounded-2xl p-6 w-full max-w-sm" onClick={e => e.stopPropagation()}>
                                <div className="text-center mb-6">
                                    <div className="text-5xl mb-3">{buyModal.prize.icon}</div>
                                    <h3 className="text-xl font-bold">{buyModal.prize.name}</h3>
                                    <p className="text-rm-gold font-bold">{buyModal.prize.cost.toLocaleString()} –æ—á–∫–æ–≤</p>
                                </div>

                                <div className="space-y-4">
                                    <input
                                        type="text"
                                        placeholder="Telegram username –¥–ª—è —Å–≤—è–∑–∏"
                                        value={buyForm.contact}
                                        onChange={e => setBuyForm({...buyForm, contact: e.target.value})}
                                        className="w-full bg-rm-light border border-rm-gray rounded-xl px-4 py-3 focus:border-rm-gold outline-none"
                                    />

                                    {buyModal.prize.requires === 'size' && (
                                        <select
                                            value={buyForm.size}
                                            onChange={e => setBuyForm({...buyForm, size: e.target.value})}
                                            className="w-full bg-rm-light border border-rm-gray rounded-xl px-4 py-3 focus:border-rm-gold outline-none"
                                        >
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                            <option value="XL">XL</option>
                                            <option value="XXL">XXL</option>
                                        </select>
                                    )}

                                    {buyModal.prize.requires === 'phone' && (
                                        <input
                                            type="tel"
                                            placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è TG Premium"
                                            value={buyForm.phone}
                                            onChange={e => setBuyForm({...buyForm, phone: e.target.value})}
                                            className="w-full bg-rm-light border border-rm-gray rounded-xl px-4 py-3 focus:border-rm-gold outline-none"
                                        />
                                    )}

                                    {buyModal.prize.requires === 'address' && (
                                        <textarea
                                            placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞, –∏–Ω–¥–µ–∫—Å)"
                                            value={buyForm.address}
                                            onChange={e => setBuyForm({...buyForm, address: e.target.value})}
                                            className="w-full bg-rm-light border border-rm-gray rounded-xl px-4 py-3 focus:border-rm-gold outline-none resize-none"
                                            rows={3}
                                        />
                                    )}
                                </div>

                                <div className="flex gap-3 mt-6">
                                    <button
                                        onClick={() => setBuyModal({ open: false, prize: null })}
                                        className="flex-1 bg-rm-light py-3 rounded-xl font-semibold"
                                    >
                                        –û—Ç–º–µ–Ω–∞
                                    </button>
                                    <button
                                        onClick={handleBuyPrize}
                                        disabled={buyLoading || !buyForm.contact}
                                        className="flex-1 btn-gold py-3 rounded-xl font-semibold disabled:opacity-50"
                                    >
                                        {buyLoading ? '...' : '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Admin Tab */}
                    {tab === 'admin' && isAdmin && (
                        <div className="space-y-4">
                            <div className="glass rounded-2xl p-5">
                                <h3 className="font-bold mb-4">üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
                                <div className="space-y-3">
                                    <input
                                        type="text"
                                        placeholder="@username"
                                        value={adminUsername}
                                        onChange={e => setAdminUsername(e.target.value)}
                                        className="w-full bg-rm-light border border-rm-gray rounded-xl px-4 py-3 focus:border-rm-gold outline-none"
                                    />
                                    <input
                                        type="number"
                                        placeholder="–°—É–º–º–∞"
                                        value={adminAmount}
                                        onChange={e => setAdminAmount(e.target.value)}
                                        className="w-full bg-rm-light border border-rm-gray rounded-xl px-4 py-3 focus:border-rm-gold outline-none"
                                    />
                                    <div className="flex gap-2">
                                        {[100, 500, 1000, 5000].map(n => (
                                            <button
                                                key={n}
                                                onClick={() => setAdminAmount(n.toString())}
                                                className="flex-1 bg-rm-light py-2 rounded-lg text-sm hover:bg-rm-gray"
                                            >
                                                +{n}
                                            </button>
                                        ))}
                                    </div>
                                    <button
                                        onClick={handleAdminAddBalance}
                                        disabled={adminLoading || !adminUsername || !adminAmount}
                                        className="w-full btn-gold py-3 rounded-xl font-bold disabled:opacity-50"
                                    >
                                        {adminLoading ? '...' : '–ü–æ–ø–æ–ª–Ω–∏—Ç—å'}
                                    </button>

                                    {adminResult && (
                                        <div className={`p-4 rounded-xl ${adminResult.error ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>
                                            {adminResult.error ? (
                                                <div>‚ùå {adminResult.error}</div>
                                            ) : (
                                                <div>
                                                    <div>‚úÖ @{adminResult.username}</div>
                                                    <div className="text-sm">{adminResult.old_balance} ‚Üí {adminResult.new_balance} (+{adminResult.added})</div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==================== MAIN APP ====================
        // ==================== HLS PLAYER OVERLAY ====================
        const PlayerOverlay = ({ streams: initialStreams, activeIndex, onClose, onSwitch }) => {
            const videoRef = useRef(null);
            const hlsRef = useRef(null);
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(true);
            const timerRef = useRef(null);
            const [parsedStreams, setParsedStreams] = useState(null);
            const [parseStatus, setParseStatus] = useState('');
            const [showIframeFallback, setShowIframeFallback] = useState(false);
            const [pseudoFull, setPseudoFull] = useState(false);
            const [showControls, setShowControls] = useState(true);
            const controlsTimerRef = useRef(null);

            const streams = parsedStreams || initialStreams;
            const current = streams[activeIndex] || streams[0];
            const originalCurrent = initialStreams[activeIndex] || initialStreams[0];
            const isOriginalIframe = originalCurrent?.type === 'iframe';
            const isIframe = showIframeFallback && isOriginalIframe;

            const destroyHls = useCallback(() => {
                if (timerRef.current) { clearTimeout(timerRef.current); timerRef.current = null; }
                if (hlsRef.current) { hlsRef.current.destroy(); hlsRef.current = null; }
            }, []);

            const startStream = useCallback((url, streamType) => {
                if (streamType === 'iframe') return;
                destroyHls();
                setError(null);
                setLoading(true);
                const video = videoRef.current;
                if (!video) return;

                const isAce = streamType === 'acestream';
                const timeoutMs = isAce ? 60000 : 10000;

                timerRef.current = setTimeout(() => {
                    setError('timeout');
                    setLoading(false);
                }, timeoutMs);

                if (isAce) {
                    video.src = url;
                    video.addEventListener('loadeddata', () => {
                        clearTimeout(timerRef.current);
                        setLoading(false);
                        video.play().catch(() => {});
                    }, { once: true });
                    video.addEventListener('error', () => {
                        clearTimeout(timerRef.current);
                        setLoading(false);
                        setError('fatal');
                    }, { once: true });
                } else if (window.Hls && Hls.isSupported()) {
                    console.log('[HLS] Loading:', url);
                    const hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: false,
                        xhrSetup: (xhr) => { xhr.timeout = 15000; },
                        manifestLoadingTimeOut: 15000,
                        levelLoadingTimeOut: 15000,
                        fragLoadingTimeOut: 20000,
                    });
                    hlsRef.current = hls;
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        console.log('[HLS] Manifest parsed OK');
                        clearTimeout(timerRef.current);
                        setLoading(false);
                        video.play().catch(() => {});
                    });
                    hls.on(Hls.Events.ERROR, (_, data) => {
                        console.error('[HLS] Error:', data.type, data.details, data.fatal, data.url);
                        if (data.fatal) {
                            if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                                hls.recoverMediaError();
                            } else {
                                clearTimeout(timerRef.current);
                                setLoading(false);
                                setError(data.type === Hls.ErrorTypes.NETWORK_ERROR ? 'network' : 'fatal');
                            }
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = url;
                    video.addEventListener('loadedmetadata', () => {
                        clearTimeout(timerRef.current);
                        setLoading(false);
                        video.play().catch(() => {});
                    }, { once: true });
                    video.addEventListener('error', () => {
                        clearTimeout(timerRef.current);
                        setLoading(false);
                        setError('fatal');
                    }, { once: true });
                } else {
                    setLoading(false);
                    setError('unsupported');
                }
            }, [destroyHls]);

            // Parse iframe pages for m3u8
            useEffect(() => {
                if (!isOriginalIframe) {
                    setParsedStreams(null);
                    setParseStatus('');
                    setShowIframeFallback(false);
                    return;
                }

                const parseUrl = originalCurrent?.parse_url;
                if (!parseUrl) {
                    setShowIframeFallback(true);
                    setLoading(false);
                    return;
                }

                let cancelled = false;
                setLoading(true);
                setError(null);
                setParseStatus('search');
                setParsedStreams(null);
                setShowIframeFallback(false);

                const t3 = setTimeout(() => { if (!cancelled) setParseStatus('connecting'); }, 3000);
                const t10 = setTimeout(() => { if (!cancelled) setParseStatus('slow'); }, 10000);

                fetch(parseUrl)
                    .then(r => r.json())
                    .then(data => {
                        clearTimeout(t3); clearTimeout(t10);
                        if (cancelled) return;
                        if (data.success && data.streams && data.streams.length > 0) {
                            console.log('[Parse] Found streams:', data.streams);
                            const hlsStreams = data.streams.map((s, i) => ({
                                name: s.name || originalCurrent.name + ' #' + (i + 1),
                                url: s.url,
                                type: 'hls'
                            }));
                            setParsedStreams(hlsStreams);
                            setParseStatus('found');
                        } else {
                            console.log('[Parse] No streams found, falling back to iframe');
                            setShowIframeFallback(true);
                            setLoading(false);
                            setParseStatus('');
                        }
                    })
                    .catch(err => {
                        clearTimeout(t3); clearTimeout(t10);
                        if (cancelled) return;
                        console.error('[Parse] Error:', err);
                        setShowIframeFallback(true);
                        setLoading(false);
                        setParseStatus('');
                    });

                return () => { cancelled = true; clearTimeout(t3); clearTimeout(t10); };
            }, [activeIndex, isOriginalIframe, originalCurrent?.parse_url]);

            // Start HLS/acestream playback
            const playUrl = current?.type === 'acestream'
                ? current?.http_url
                : current?.type === 'hls'
                    ? (current?.url ? '/api/proxy/hls?url=' + encodeURIComponent(current.url) : null)
                    : null;

            useEffect(() => {
                if (isIframe || (isOriginalIframe && !parsedStreams)) return;
                if (playUrl) startStream(playUrl, current?.type);
                return destroyHls;
            }, [activeIndex, playUrl, current?.type, isIframe, isOriginalIframe, parsedStreams, startStream, destroyHls]);

            const openInBrowser = () => { window.open(originalCurrent?.url, '_blank'); };
            const copyUrl = () => {
                navigator.clipboard?.writeText(current?.url || '').then(() => {
                    tg?.showAlert?.('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
                }).catch(() => {});
            };
            const switchToIframe = () => {
                destroyHls();
                setParsedStreams(null);
                setShowIframeFallback(true);
                setLoading(false);
                setError(null);
            };

            // Fullscreen: native API + orientation lock, or CSS rotation fallback
            const goFullscreen = useCallback(() => {
                const overlay = document.getElementById('player-overlay');
                if (!overlay) return;

                // Exit native fullscreen
                if (document.fullscreenElement || document.webkitFullscreenElement) {
                    (document.exitFullscreen || document.webkitExitFullscreen || function(){}).call(document);
                    setPseudoFull(false);
                    return;
                }
                // Exit pseudo-fullscreen
                if (pseudoFull) {
                    setPseudoFull(false);
                    return;
                }

                const video = videoRef.current;
                // iOS: native video fullscreen
                if (video && video.webkitEnterFullscreen) {
                    try { video.webkitEnterFullscreen(); return; } catch(e) {}
                }

                // Try native Fullscreen API + orientation lock
                const requestFs = overlay.requestFullscreen || overlay.webkitRequestFullscreen;
                if (requestFs) {
                    const p = requestFs.call(overlay);
                    if (p && p.then) {
                        p.then(() => {
                            try { screen.orientation.lock('landscape').catch(() => {}); } catch(e) {}
                        }).catch(() => {
                            setPseudoFull(true);
                        });
                    }
                } else {
                    // No Fullscreen API (Telegram WebView) ‚Äî CSS rotation
                    setPseudoFull(true);
                }
            }, [pseudoFull]);

            // Native fullscreen exit listener
            useEffect(() => {
                const onFsChange = () => {
                    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                        try { screen.orientation.unlock(); } catch(e) {}
                    }
                };
                document.addEventListener('fullscreenchange', onFsChange);
                document.addEventListener('webkitfullscreenchange', onFsChange);
                return () => {
                    document.removeEventListener('fullscreenchange', onFsChange);
                    document.removeEventListener('webkitfullscreenchange', onFsChange);
                };
            }, []);

            // Auto-hide controls in pseudo-fullscreen (3s)
            useEffect(() => {
                if (pseudoFull) {
                    setShowControls(true);
                    controlsTimerRef.current = setTimeout(() => setShowControls(false), 3000);
                    return () => { if (controlsTimerRef.current) clearTimeout(controlsTimerRef.current); };
                } else {
                    setShowControls(true);
                    if (controlsTimerRef.current) { clearTimeout(controlsTimerRef.current); controlsTimerRef.current = null; }
                }
            }, [pseudoFull]);

            // Tap to toggle controls in fullscreen
            const onFullscreenTap = useCallback((e) => {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                if (e.target.tagName === 'VIDEO') return; // let native controls handle
                if (controlsTimerRef.current) clearTimeout(controlsTimerRef.current);
                setShowControls(prev => {
                    if (!prev) {
                        controlsTimerRef.current = setTimeout(() => setShowControls(false), 3000);
                    }
                    return !prev;
                });
            }, []);

            const isParseLoading = isOriginalIframe && !parsedStreams && !showIframeFallback && loading;

            // Rotated landscape style for pseudo-fullscreen
            const containerStyle = pseudoFull ? {
                position: 'fixed',
                top: '100vh',
                left: 0,
                width: '100vh',
                height: '100vw',
                transform: 'rotate(90deg)',
                transformOrigin: 'top left',
                zIndex: 99999,
                background: '#000',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden'
            } : {
                position: 'fixed',
                top: 0, left: 0, right: 0, bottom: 0,
                background: '#000',
                zIndex: 9999,
                display: 'flex',
                flexDirection: 'column'
            };

            return (
                <div id="player-overlay" style={containerStyle}>
                    <style dangerouslySetInnerHTML={{__html: `
                        #player-overlay:-webkit-full-screen { padding:0; }
                        #player-overlay:fullscreen { padding:0; }
                        #player-overlay:-webkit-full-screen video,
                        #player-overlay:fullscreen video { width:100%!important; height:100%!important; max-height:100%!important; object-fit:contain; }
                        #player-overlay:-webkit-full-screen iframe,
                        #player-overlay:fullscreen iframe { width:100%!important; height:100%!important; }
                        #player-overlay:-webkit-full-screen .po-header,
                        #player-overlay:fullscreen .po-header,
                        #player-overlay:-webkit-full-screen .po-footer,
                        #player-overlay:fullscreen .po-footer { display:none!important; }
                        @keyframes pulse { 0%,100% { opacity:0.4; } 50% { opacity:1; } }
                    `}} />

                    {/* Header ‚Äî hidden in pseudo-fullscreen */}
                    {!pseudoFull && (
                        <div className="po-header" style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 16px',flexShrink:0}}>
                            <div style={{color:'#fff',fontSize:16,fontWeight:600}}>{originalCurrent?.name || 'Stream'}</div>
                            <div style={{display:'flex',alignItems:'center',gap:4}}>
                                <button onClick={goFullscreen} style={{
                                    color:'#fff',fontSize:18,background:'rgba(255,255,255,0.15)',border:'none',
                                    cursor:'pointer',padding:'6px 10px',borderRadius:8,lineHeight:1
                                }}>&#x26F6;</button>
                                <button onClick={onClose} style={{
                                    color:'#fff',fontSize:28,lineHeight:1,background:'none',border:'none',
                                    cursor:'pointer',padding:'4px 8px'
                                }}>&times;</button>
                            </div>
                        </div>
                    )}

                    {/* Content area */}
                    <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',position:'relative',overflow:'hidden'}}
                         onClick={pseudoFull ? onFullscreenTap : undefined}
                    >
                        {/* Fullscreen close button (auto-hiding) */}
                        {pseudoFull && showControls && (
                            <button onClick={(e) => { e.stopPropagation(); setPseudoFull(false); }} style={{
                                position:'absolute',top:12,right:12,zIndex:10001,
                                color:'#fff',fontSize:20,background:'rgba(0,0,0,0.6)',border:'none',
                                cursor:'pointer',padding:'8px 14px',borderRadius:8,lineHeight:1
                            }}>&#x2715;</button>
                        )}

                        {isParseLoading ? (
                            <div style={{color:'#fff',textAlign:'center',padding:20}}>
                                <div style={{fontSize:40,marginBottom:16}}>
                                    {parseStatus === 'slow' ? '\u23F3' : '\uD83D\uDD0D'}
                                </div>
                                <div style={{fontSize:15,fontWeight:500,marginBottom:8}}>
                                    {parseStatus === 'search' ? '–ò—â–µ–º —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é...'
                                     : parseStatus === 'connecting' ? '–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...'
                                     : parseStatus === 'slow' ? '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏...'
                                     : '–ó–∞–≥—Ä—É–∑–∫–∞...'}
                                </div>
                                <div style={{width:120,height:3,background:'#333',borderRadius:2,margin:'16px auto',overflow:'hidden'}}>
                                    <div style={{
                                        width:'60%',height:'100%',background:'#e74c3c',borderRadius:2,
                                        animation:'pulse 1.5s ease-in-out infinite'
                                    }}></div>
                                </div>
                                {parseStatus === 'slow' && (
                                    <button onClick={switchToIframe} style={{
                                        marginTop:16,background:'#333',color:'#fff',border:'none',borderRadius:12,
                                        padding:'10px 24px',fontSize:13,cursor:'pointer'
                                    }}>–û—Ç–∫—Ä—ã—Ç—å –≤ –ø–ª–µ–µ—Ä–µ —Å–∞–π—Ç–∞</button>
                                )}
                            </div>
                        ) : isIframe ? (
                            <iframe
                                key={originalCurrent?.url}
                                src={originalCurrent?.url}
                                style={{
                                    width: '100%',
                                    height: '100%',
                                    border:'none',background:'#000'
                                }}
                                sandbox="allow-scripts allow-same-origin allow-popups allow-presentation"
                                allow="autoplay; encrypted-media; fullscreen; picture-in-picture"
                                allowFullScreen
                            />
                        ) : (
                            <>
                                <video
                                    ref={videoRef}
                                    controls
                                    playsInline
                                    style={{
                                        width: '100%',
                                        height: pseudoFull ? '100%' : 'auto',
                                        maxHeight: '100%',
                                        aspectRatio: pseudoFull ? undefined : '16/9',
                                        background:'#000',
                                        objectFit: 'contain'
                                    }}
                                />
                                {loading && !error && (
                                    <div style={{
                                        position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%)',
                                        color:'#fff',textAlign:'center'
                                    }}>
                                        <div style={{fontSize:32,marginBottom:8}}>&#8987;</div>
                                        <div style={{fontSize:13,color:'#999'}}>
                                            {current?.type === 'acestream'
                                                ? 'Acestream –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...'
                                                : '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏...'}
                                        </div>
                                    </div>
                                )}
                                {error && (
                                    <div style={{
                                        position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%)',
                                        color:'#fff',textAlign:'center',padding:20
                                    }}>
                                        <div style={{fontSize:32,marginBottom:8}}>&#128546;</div>
                                        <div style={{fontSize:14,marginBottom:12,color:'#ccc'}}>
                                            {error === 'timeout' ? '–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞' :
                                             error === 'network' ? '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏' :
                                             '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏'}
                                        </div>
                                        <div style={{display:'flex',gap:8,justifyContent:'center',flexWrap:'wrap'}}>
                                            <button onClick={() => { if (playUrl) startStream(playUrl, current?.type); }} style={{
                                                background:'#e74c3c',color:'#fff',border:'none',borderRadius:12,
                                                padding:'10px 24px',fontSize:14,fontWeight:600,cursor:'pointer'
                                            }}>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                                            {isOriginalIframe && (
                                                <button onClick={switchToIframe} style={{
                                                    background:'#333',color:'#fff',border:'none',borderRadius:12,
                                                    padding:'10px 24px',fontSize:13,cursor:'pointer'
                                                }}>–ü–ª–µ–µ—Ä —Å–∞–π—Ç–∞</button>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>

                    {/* Bottom controls ‚Äî hidden in pseudo-fullscreen */}
                    {!pseudoFull && (
                        <div className="po-footer" style={{padding:'12px 16px 20px',flexShrink:0}}>
                            {streams.length > 1 && !isParseLoading && (
                                <div style={{display:'flex',gap:8,overflowX:'auto',marginBottom:12,
                                    WebkitOverflowScrolling:'touch'}}>
                                    {streams.map((s, i) => (
                                        <button
                                            key={i}
                                            onClick={() => onSwitch(i)}
                                            style={{
                                                padding:'8px 16px',borderRadius:20,fontSize:13,fontWeight:500,
                                                border:'none',cursor:'pointer',whiteSpace:'nowrap',flexShrink:0,
                                                background: i === activeIndex ? '#e74c3c' : '#333',
                                                color: '#fff',transition:'all 0.2s'
                                            }}
                                        >{s.name}</button>
                                    ))}
                                </div>
                            )}
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                <div style={{fontSize:11,color:'#666'}}>
                                    {isIframe ? '–ù–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è?' : isParseLoading ? '' : '–ù–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è?'}
                                </div>
                                <div style={{display:'flex',gap:8}}>
                                    {isIframe && (
                                        <button onClick={openInBrowser} style={{
                                            fontSize:12,color:'#999',background:'none',border:'1px solid #444',
                                            borderRadius:8,padding:'6px 12px',cursor:'pointer',whiteSpace:'nowrap'
                                        }}>&#8599; –ë—Ä–∞—É–∑–µ—Ä</button>
                                    )}
                                    {!isIframe && !isParseLoading && (
                                        <button onClick={copyUrl} style={{
                                            fontSize:12,color:'#999',background:'none',border:'1px solid #444',
                                            borderRadius:8,padding:'6px 12px',cursor:'pointer',whiteSpace:'nowrap'
                                        }}>&#128203; –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                                    )}
                                    {parsedStreams && isOriginalIframe && !isIframe && (
                                        <button onClick={switchToIframe} style={{
                                            fontSize:12,color:'#999',background:'none',border:'1px solid #444',
                                            borderRadius:8,padding:'6px 12px',cursor:'pointer',whiteSpace:'nowrap'
                                        }}>–ü–ª–µ–µ—Ä —Å–∞–π—Ç–∞</button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==================== STREAM BLOCK ====================
        const StreamBlock = ({ streams, compact = false }) => {
            if (!streams || streams.length === 0) return null;
            const [playerOpen, setPlayerOpen] = useState(false);
            const [playerIndex, setPlayerIndex] = useState(0);

            const openPlayer = (index) => {
                setPlayerIndex(index);
                setPlayerOpen(true);
            };

            if (compact) {
                return (
                    <>
                    <div className="mt-3 flex flex-wrap gap-2">
                        {streams.map((s, i) => (
                            <button
                                key={i}
                                onClick={() => openPlayer(i)}
                                className="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold transition-all"
                                style={{background:'rgba(231,76,60,0.2)',color:'#e74c3c'}}
                            >
                                <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                                {s.name}
                            </button>
                        ))}
                    </div>
                    {playerOpen && (
                        <PlayerOverlay
                            streams={streams}
                            activeIndex={playerIndex}
                            onClose={() => setPlayerOpen(false)}
                            onSwitch={(i) => setPlayerIndex(i)}
                        />
                    )}
                    </>
                );
            }

            return (
                <>
                <div className="glass rounded-2xl overflow-hidden" style={{borderLeft:'3px solid #e74c3c'}}>
                    <div className="p-4">
                        <div className="text-xs font-bold text-red-400 mb-3 flex items-center gap-2">
                            <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                            –¢–†–ê–ù–°–õ–Ø–¶–ò–Ø
                        </div>
                        <div className="flex flex-col gap-2">
                            {streams.map((s, i) => (
                                <button
                                    key={i}
                                    onClick={() => openPlayer(i)}
                                    className="flex items-center gap-3 w-full text-left px-4 py-3 rounded-xl font-semibold transition-all hover:brightness-110"
                                    style={{background:'#e74c3c',color:'#fff'}}
                                >
                                    <span className="w-2 h-2 bg-white rounded-full animate-pulse shrink-0"></span>
                                    <span className="truncate">{s.name}</span>
                                </button>
                            ))}
                        </div>
                        <div className="text-gray-500 text-[11px] mt-3 text-center">
                            –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏
                        </div>
                    </div>
                </div>
                {playerOpen && (
                    <PlayerOverlay
                        streams={streams}
                        activeIndex={playerIndex}
                        onClose={() => setPlayerOpen(false)}
                        onSwitch={(i) => setPlayerIndex(i)}
                    />
                )}
                </>
            );
        };

        const App = () => {
            const [page, setPage] = useState('home');
            const [loading, setLoading] = useState(true);
            const [newsLoading, setNewsLoading] = useState(true);
            const [matchesLoading, setMatchesLoading] = useState(true);
            const [user, setUser] = useState(null);
            const [match, setMatch] = useState(null);
            const [matches, setMatches] = useState([]);
            const [results, setResults] = useState([]);
            const [standings, setStandings] = useState([]);
            const [bets, setBets] = useState([]);
            const [predictions, setPredictions] = useState([]);
            const [leaderboard, setLeaderboard] = useState([]);
            const [news, setNews] = useState([]);
            const [liveMatch, setLiveMatch] = useState(null);
            const [streams, setStreams] = useState([]);
            const [betModal, setBetModal] = useState({ open: false });
            const [purchaseModal, setPurchaseModal] = useState(false);

            // Initialize Telegram WebApp
            const tgPhotoUrl = tg?.initDataUnsafe?.user?.photo_url || '';

            useEffect(() => {
                if (tg) {
                    tg.ready();
                    tg.expand();
                    tg.setHeaderColor('#0A0A0C');
                    tg.setBackgroundColor('#0A0A0C');
                }
            }, []);

            // Load data in 2 stages: fast first, heavy in background
            const loadData = useCallback(async () => {
                setLoading(true);
                setNewsLoading(true);
                setMatchesLoading(true);

                // STAGE 1: Fast data (DB/cache) ‚Äî user sees UI in <1s
                try {
                    const [userData, matchData, betsData, predictionsData, leaderboardData] = await Promise.all([
                        api.get('/api/user/me').catch(() => null),
                        api.get('/api/match/next').catch(() => ({})),
                        api.get('/api/user/bets').catch(() => ({})),
                        api.get('/api/user/predictions').catch(() => ({})),
                        api.get('/api/leaderboard').catch(() => ({}))
                    ]);

                    setUser(userData);
                    setMatch(matchData?.match);
                    setBets(betsData?.bets || []);
                    setPredictions(predictionsData?.predictions || []);
                    setLeaderboard(leaderboardData?.leaderboard || []);
                } catch (err) {
                    console.error('Stage 1 error:', err);
                } finally {
                    setLoading(false); // UI ready!
                }

                // STAGE 2: Heavy data (external APIs) ‚Äî loads in background
                Promise.all([
                    api.get('/api/matches/upcoming').catch(() => ({})),
                    api.get('/api/matches/results').catch(() => ({})),
                    api.get('/api/standings').catch(() => ({}))
                ]).then(([matchesData, resultsData, standingsData]) => {
                    setMatches(matchesData?.matches || []);
                    setResults(resultsData?.results || []);
                    setStandings(standingsData?.standings || []);
                    setMatchesLoading(false);
                }).catch(() => setMatchesLoading(false));

                // News (separate, slowest)
                api.get('/api/news?count=10').catch(() => ({})).then(newsData => {
                    setNews(newsData?.news || []);
                    setNewsLoading(false);
                });

                // Live data + streams
                api.get('/api/live').then(data => {
                    setLiveMatch(data?.is_live ? data : null);
                }).catch(() => {});
                api.get('/api/streams').then(data => {
                    setStreams(data?.streams || []);
                }).catch(() => {});
            }, []);

            useEffect(() => { loadData(); }, [loadData]);

            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ live –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            useEffect(() => {
                const interval = setInterval(() => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º live –¥–∞–Ω–Ω—ã–µ (—Å—á—ë—Ç, –º–∏–Ω—É—Ç–∞, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
                    api.get('/api/live').then(data => {
                        setLiveMatch(data?.is_live ? data : null);
                    }).catch(() => {});
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∏ –º–∞—Ä–∫–µ—Ç—ã —Å—Ç–∞–≤–æ–∫
                    api.get('/api/match/next').then(data => {
                        if (data?.match) setMatch(data.match);
                    }).catch(() => {});
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∏–º—ã
                    api.get('/api/streams').then(data => {
                        setStreams(data?.streams || []);
                    }).catch(() => {});
                }, 30000);
                return () => clearInterval(interval);
            }, []);

            const handleBet = (type, odds) => {
                tg?.HapticFeedback?.impactOccurred?.('light');
                setBetModal({ open: true, type, odds });
            };

            return (
                <div className="min-h-screen">
                    <Header balance={user?.balance} loading={loading} onBuyClick={() => setPurchaseModal(true)} photoUrl={tgPhotoUrl} />

                    <main>
                        {page === 'home' && <HomePage user={user} match={match} liveMatch={liveMatch} loading={loading} onNavigate={setPage} streams={streams} onQuizComplete={loadData} />}
                        {page === 'matches' && <MatchesPage matches={matches} results={results} standings={standings} loading={matchesLoading} isAdmin={ADMIN_IDS.includes(user?.user_id)} liveMatch={liveMatch} onNavigate={setPage} streams={streams} />}
                        {page === 'bets' && <BetsPage bets={bets} predictions={predictions} match={match} loading={loading} onSellBet={loadData} onPlaceBet={loadData} streams={streams} />}
                        {page === 'games' && <GamesPage />}
                        {page === 'news' && <NewsPage news={news} loading={newsLoading} onRefresh={loadData} />}
                        {page === 'profile' && <ProfilePage user={user} leaderboard={leaderboard} loading={loading} onBuyPrize={loadData} photoUrl={tgPhotoUrl} />}
                    </main>

                    <Navigation active={page} onChange={setPage} />

                    <BetModal
                        isOpen={betModal.open}
                        onClose={() => setBetModal({ open: false })}
                        betType={betModal.type}
                        odds={betModal.odds}
                        balance={user?.balance || 0}
                        matchId={match?.id}
                        match={match}
                        onSuccess={loadData}
                    />

                    <PurchaseModal isOpen={purchaseModal} onClose={() => setPurchaseModal(false)} />
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
